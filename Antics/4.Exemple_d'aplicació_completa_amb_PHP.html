
<!doctype html>
<html lang="ca" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://xsastre.github.io/Antics/4.Exemple_d%27aplicacio%CC%81_completa_amb_PHP.html">
      
      
      
      
      <link rel="icon" href="../imagenes/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.9">
    
    
      
        <title>Exemple d'aplicació completa amb PHP - Docencia Xavier</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.f2e4d321.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Sans+Condensed:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"IBM Plex Sans Condensed";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="light-blue" data-md-color-accent="Teal">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#exemple-daplicacio-completa-amb-php" class="md-skip">
          Salta el contingut
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Capçalera">
    <a href=".." title="Docencia Xavier" class="md-header__button md-logo" aria-label="Docencia Xavier" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Docencia Xavier
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Exemple d'aplicació completa amb PHP
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="light-blue" data-md-color-accent="Teal"  aria-label="Cambiar a modo noche"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Cambiar a modo noche" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="light-blue" data-md-color-accent="Teal"  aria-label="Canviar a mode dia"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Canviar a mode dia" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Cerca" placeholder="Cerca" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Cerca">
        
        <button type="reset" class="md-search__icon md-icon" title="Neteja" aria-label="Neteja" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicialitzant cerca
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navegació" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Docencia Xavier" class="md-nav__button md-logo" aria-label="Docencia Xavier" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Docencia Xavier
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Inici
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Inici
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Inici
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    DWEC
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            DWEC
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Moduls/DWEC/_DWEC2425.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Desenvolupament web en entorn client - DAW
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Moduls/DWEC/desenvolupamentfrontend.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Desenvolupamet frontend
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    AW
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            AW
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Moduls/AW/01.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Aplicacions web
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="exemple-daplicacio-completa-amb-php">Exemple d'aplicació completa amb PHP<a class="headerlink" href="#exemple-daplicacio-completa-amb-php" title="Permanent link">&para;</a></h1>
<h2 id="definicio-del-projecte">Definició del projecte<a class="headerlink" href="#definicio-del-projecte" title="Permanent link">&para;</a></h2>
<p>En l'anàlisi, es defineix la funcionalitat de l'aplicació i les seues limitacions. S'indica les dades que es volen emmagatzemar i es realitze un esquema E/R per a la BBDD. Es definiran:</p>
<ul>
<li>Les pantalles que vorà l'usuari</li>
<li>El fitxers que formaràn l'aplicació i com es pasaran els pràmetres entre ells.</li>
<li>L'estructura de dades i com manipular-la.</li>
<li>La base de dades.</li>
</ul>
<p>Finalment, en la implementació, s'escriuen el fitxers de l'aplicació. </p>
<p>L'aplicació serà la web de una distribuidora. Tindrem un magatzem central i tendes que fan comandes al magatzem.</p>
<h2 id="analisi-de-requeriments">Anàlisi de requeriments<a class="headerlink" href="#analisi-de-requeriments" title="Permanent link">&para;</a></h2>
<p>Es requerix realitzar una aplicació per al departament de comandes de la distribuidora d'una cadena de tendes xineses. Les tendes de la cadena utilitzaran l'aplicació per realitzar comandes de productes.
L'aplicació ha de permetre:
* Consultar les categories de productes.
* Consultar els productes.
* Afegir una o més unitats d'un producte a la comanda.
* Consultar la comanda i eliminar productes.
* Realitzar la comanda, actualitzan la base de dades i enviant correus de confirmació a la tenda que fa la comanda i a la central.</p>
<p>Per tal d'accedir a l'aplicació cal autenticar-se. 
De cada categoria es vol emmagatzemar el seu codi, nom, descripció. Dels productes, el seu codi,nom, descripció, quantitat en stock, la categoria a la que pertany,el preu i una imatge. Cada producte pertany a una categoria.</p>
<p>De cada comanda interesa saber:</p>
<ul>
<li>La tenda que l'ha realitzat.</li>
<li>Els productes que s'han demanat, incloent la quantitat.</li>
<li>La data.</li>
<li>El preu total</li>
<li>Si s'ha remés.</li>
</ul>
<p>Les comandes s'introduiran a la base de dades com a no enviats i el departament de comandes les marcarà com a envidades (l'aplicació no s'encarrega d'això).</p>
<p>De les tendes guardarem:</p>
<ul>
<li>El codi</li>
<li>El correu electrònic.</li>
<li>La clau</li>
<li>Pais, adreça i codi postal.</li>
</ul>
<h3 id="esquema-entitat-relacio">Esquema Entitat Relació<a class="headerlink" href="#esquema-entitat-relacio" title="Permanent link">&para;</a></h3>
<p><img alt="Esquema" src="../img/ER.png" /></p>
<h3 id="limitacions-de-laplicacio">Limitacions de l'aplicació<a class="headerlink" href="#limitacions-de-laplicacio" title="Permanent link">&para;</a></h3>
<ul>
<li>No hi ha panel d'administració. Els usuaris, categories i productes s'han d'introduir directament a la BBDD</li>
<li>No hi ha possibilitat d'autoregistre.</li>
<li>No es control·la l'stock (de moment)</li>
</ul>
<h2 id="disseny-de-laplicacio">Disseny de l'aplicació<a class="headerlink" href="#disseny-de-laplicacio" title="Permanent link">&para;</a></h2>
<p>A partir de l'analisi anterior dissenyarem:</p>
<ul>
<li>La base de dades.</li>
<li>El fluxe de pantalles per a realitzar una comanda.</li>
<li>L'estructura de dades per a una comanda.</li>
<li>Els fitxers de l'aplicació i com es passen paràmetres.</li>
<li>El control d'accés.</li>
</ul>
<h3 id="disseny-logic-de-la-bbdd">Disseny lògic de la BBDD<a class="headerlink" href="#disseny-logic-de-la-bbdd" title="Permanent link">&para;</a></h3>
<p>A partir de l'esquema anterior s'obtenen les següent taules:</p>
<p>Base de dades <strong>Distribuidora</strong></p>
<p><strong>Categories</strong>(<strong>id</strong>,name,description)</p>
<p><strong>Orders</strong>(<strong>id</strong>,date,send,idShop)</p>
<p><strong>OrderLines</strong>(<strong>idOrder</strong>,<strong>idProduct</strong>,amount)</p>
<p><strong>Products</strong>(<strong>id</strong>,name,description,stock,idCategory,price,image)</p>
<p><strong>Shops</strong>(<strong>id</strong>,email,password,adress,PostalCode,country)</p>
<p>Per a passar al disseny físic de la BBDD cal decidir els tipus de dades de les columnes. Així marcarem els correus com a unics i les claus com a autoincrementables. </p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="  1 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="  2 "></span><span class="c1">-- Base de dades: `Distribution`</span>
<span class="linenos" data-linenos="  3 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="  4 "></span><span class="k">CREATE</span><span class="w"> </span><span class="k">DATABASE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="o">`</span><span class="n">Distribution</span><span class="o">`</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="nb">CHARACTER</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">utf8</span><span class="w"> </span><span class="k">COLLATE</span><span class="w"> </span><span class="n">utf8_general_ci</span><span class="p">;</span>
<span class="linenos" data-linenos="  5 "></span><span class="n">USE</span><span class="w"> </span><span class="o">`</span><span class="n">Distribution</span><span class="o">`</span><span class="p">;</span>
<span class="linenos" data-linenos="  6 "></span>
<span class="linenos" data-linenos="  7 "></span><span class="c1">-- --------------------------------------------------------</span>
<span class="linenos" data-linenos="  8 "></span>
<span class="linenos" data-linenos="  9 "></span><span class="c1">--</span>
<span class="linenos" data-linenos=" 10 "></span><span class="c1">-- Estructura de la taula `Categories`</span>
<span class="linenos" data-linenos=" 11 "></span><span class="c1">--</span>
<span class="linenos" data-linenos=" 12 "></span>
<span class="linenos" data-linenos=" 13 "></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">Categories</span><span class="o">`</span><span class="w"> </span><span class="p">(</span>
<span class="linenos" data-linenos=" 14 "></span><span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="linenos" data-linenos=" 15 "></span><span class="w">  </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="linenos" data-linenos=" 16 "></span><span class="w">  </span><span class="o">`</span><span class="n">description</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span>
<span class="linenos" data-linenos=" 17 "></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
<span class="linenos" data-linenos=" 18 "></span>
<span class="linenos" data-linenos=" 19 "></span><span class="c1">--</span>
<span class="linenos" data-linenos=" 20 "></span><span class="c1">-- Bolcant dades de la taula `Categories`</span>
<span class="linenos" data-linenos=" 21 "></span><span class="c1">--</span>
<span class="linenos" data-linenos=" 22 "></span>
<span class="linenos" data-linenos=" 23 "></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">Categories</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">description</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span>
<span class="linenos" data-linenos=" 24 "></span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Begudes&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Tot tipus de begudes&#39;</span><span class="p">),</span>
<span class="linenos" data-linenos=" 25 "></span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Menjar&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Productes comestibles&#39;</span><span class="p">),</span>
<span class="linenos" data-linenos=" 26 "></span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Bateries&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Tot tipus de bateries&#39;</span><span class="p">),</span>
<span class="linenos" data-linenos=" 27 "></span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Joguets&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Tot tipus de jogets&#39;</span><span class="p">);</span>
<span class="linenos" data-linenos=" 28 "></span>
<span class="linenos" data-linenos=" 29 "></span><span class="c1">-- --------------------------------------------------------</span>
<span class="linenos" data-linenos=" 30 "></span>
<span class="linenos" data-linenos=" 31 "></span><span class="c1">--</span>
<span class="linenos" data-linenos=" 32 "></span><span class="c1">-- Estructura de la taula `OrderLines`</span>
<span class="linenos" data-linenos=" 33 "></span><span class="c1">--</span>
<span class="linenos" data-linenos=" 34 "></span>
<span class="linenos" data-linenos=" 35 "></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">OrderLines</span><span class="o">`</span><span class="w"> </span><span class="p">(</span>
<span class="linenos" data-linenos=" 36 "></span><span class="w">  </span><span class="o">`</span><span class="n">idOrder</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="linenos" data-linenos=" 37 "></span><span class="w">  </span><span class="o">`</span><span class="n">idProduct</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="linenos" data-linenos=" 38 "></span><span class="w">  </span><span class="o">`</span><span class="n">amount</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span>
<span class="linenos" data-linenos=" 39 "></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
<span class="linenos" data-linenos=" 40 "></span>
<span class="linenos" data-linenos=" 41 "></span><span class="c1">-- --------------------------------------------------------</span>
<span class="linenos" data-linenos=" 42 "></span>
<span class="linenos" data-linenos=" 43 "></span><span class="c1">--</span>
<span class="linenos" data-linenos=" 44 "></span><span class="c1">-- Estructura de la taula `Orders`</span>
<span class="linenos" data-linenos=" 45 "></span><span class="c1">--</span>
<span class="linenos" data-linenos=" 46 "></span>
<span class="linenos" data-linenos=" 47 "></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">Orders</span><span class="o">`</span><span class="w"> </span><span class="p">(</span>
<span class="linenos" data-linenos=" 48 "></span><span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="linenos" data-linenos=" 49 "></span><span class="w">  </span><span class="o">`</span><span class="nb">date</span><span class="o">`</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="linenos" data-linenos=" 50 "></span><span class="w">  </span><span class="o">`</span><span class="n">send</span><span class="o">`</span><span class="w"> </span><span class="nb">binary</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="linenos" data-linenos=" 51 "></span><span class="w">  </span><span class="o">`</span><span class="n">idShop</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
<span class="linenos" data-linenos=" 52 "></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
<span class="linenos" data-linenos=" 53 "></span>
<span class="linenos" data-linenos=" 54 "></span><span class="c1">-- --------------------------------------------------------</span>
<span class="linenos" data-linenos=" 55 "></span>
<span class="linenos" data-linenos=" 56 "></span><span class="c1">--</span>
<span class="linenos" data-linenos=" 57 "></span><span class="c1">-- Estructura de la taula `Products`</span>
<span class="linenos" data-linenos=" 58 "></span><span class="c1">--</span>
<span class="linenos" data-linenos=" 59 "></span>
<span class="linenos" data-linenos=" 60 "></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">Products</span><span class="o">`</span><span class="w"> </span><span class="p">(</span>
<span class="linenos" data-linenos=" 61 "></span><span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="linenos" data-linenos=" 62 "></span><span class="w">  </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="linenos" data-linenos=" 63 "></span><span class="w">  </span><span class="o">`</span><span class="n">description</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="linenos" data-linenos=" 64 "></span><span class="w">  </span><span class="o">`</span><span class="n">stock</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="linenos" data-linenos=" 65 "></span><span class="w">  </span><span class="o">`</span><span class="n">idCategory</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="linenos" data-linenos=" 66 "></span><span class="w">  </span><span class="o">`</span><span class="n">price</span><span class="o">`</span><span class="w"> </span><span class="nb">float</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="linenos" data-linenos=" 67 "></span><span class="w">  </span><span class="o">`</span><span class="n">image</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
<span class="linenos" data-linenos=" 68 "></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
<span class="linenos" data-linenos=" 69 "></span>
<span class="linenos" data-linenos=" 70 "></span><span class="c1">--</span>
<span class="linenos" data-linenos=" 71 "></span><span class="c1">-- Bolcant dades de la taula `Products`</span>
<span class="linenos" data-linenos=" 72 "></span><span class="c1">--</span>
<span class="linenos" data-linenos=" 73 "></span>
<span class="linenos" data-linenos=" 74 "></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">Products</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">description</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">stock</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">idCategory</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">price</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">image</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span>
<span class="linenos" data-linenos=" 75 "></span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;rollito&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Rollito de primavera&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">99</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">),</span>
<span class="linenos" data-linenos=" 76 "></span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;aigua&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Ampolla d\&#39;</span><span class="n">aigua</span><span class="s1">&#39;, 1000, 1, 0.45, &#39;&#39;),</span>
<span class="linenos" data-linenos=" 77 "></span><span class="s1">(5, &#39;</span><span class="n">pistola</span><span class="s1">&#39;, &#39;</span><span class="n">Pistola</span><span class="w"> </span><span class="n">d</span><span class="err">\</span><span class="s1">&#39;aigua&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">),</span>
<span class="linenos" data-linenos=" 78 "></span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;cafe licor&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;1L&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">.</span><span class="mi">99</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">),</span>
<span class="linenos" data-linenos=" 79 "></span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Pilas AAA&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;piles xicotetes&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">.</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">),</span>
<span class="linenos" data-linenos=" 80 "></span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Quicos&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Paquete 50gr&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="linenos" data-linenos=" 81 "></span>
<span class="linenos" data-linenos=" 82 "></span><span class="c1">-- --------------------------------------------------------</span>
<span class="linenos" data-linenos=" 83 "></span>
<span class="linenos" data-linenos=" 84 "></span><span class="c1">--</span>
<span class="linenos" data-linenos=" 85 "></span><span class="c1">-- Estructura de la taula `Shops`</span>
<span class="linenos" data-linenos=" 86 "></span><span class="c1">--</span>
<span class="linenos" data-linenos=" 87 "></span>
<span class="linenos" data-linenos=" 88 "></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">Shops</span><span class="o">`</span><span class="w"> </span><span class="p">(</span>
<span class="linenos" data-linenos=" 89 "></span><span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="linenos" data-linenos=" 90 "></span><span class="w">  </span><span class="o">`</span><span class="n">mailAdress</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="linenos" data-linenos=" 91 "></span><span class="w">  </span><span class="o">`</span><span class="n">password</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="linenos" data-linenos=" 92 "></span><span class="w">  </span><span class="o">`</span><span class="n">adress</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="linenos" data-linenos=" 93 "></span><span class="w">  </span><span class="o">`</span><span class="n">postalCode</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="linenos" data-linenos=" 94 "></span><span class="w">  </span><span class="o">`</span><span class="n">country</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span>
<span class="linenos" data-linenos=" 95 "></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
<span class="linenos" data-linenos=" 96 "></span>
<span class="linenos" data-linenos=" 97 "></span><span class="c1">--</span>
<span class="linenos" data-linenos=" 98 "></span><span class="c1">-- Bolcant dades de la taula `Shops`</span>
<span class="linenos" data-linenos=" 99 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="100 "></span>
<span class="linenos" data-linenos="101 "></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">Shops</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">mailAdress</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">password</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">adress</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">postalCode</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">country</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span>
<span class="linenos" data-linenos="102 "></span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;alcoi@tenda.es&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;1234&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Mossen Torregorsa, 2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;03802&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Espanya&#39;</span><span class="p">),</span>
<span class="linenos" data-linenos="103 "></span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;barcelona@tenda.es&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;1234&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Balmes,340&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;46023&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Catalunya&#39;</span><span class="p">);</span>
<span class="linenos" data-linenos="104 "></span>
<span class="linenos" data-linenos="105 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="106 "></span><span class="c1">-- Indexos per taules bolcades</span>
<span class="linenos" data-linenos="107 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="108 "></span>
<span class="linenos" data-linenos="109 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="110 "></span><span class="c1">-- Index de la taula `Categories`</span>
<span class="linenos" data-linenos="111 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="112 "></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">Categories</span><span class="o">`</span>
<span class="linenos" data-linenos="113 "></span><span class="w">  </span><span class="k">ADD</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">);</span>
<span class="linenos" data-linenos="114 "></span>
<span class="linenos" data-linenos="115 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="116 "></span><span class="c1">-- Index de la taula `OrderLines`</span>
<span class="linenos" data-linenos="117 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="118 "></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">OrderLines</span><span class="o">`</span>
<span class="linenos" data-linenos="119 "></span><span class="w">  </span><span class="k">ADD</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">idOrder</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">idProduct</span><span class="o">`</span><span class="p">),</span>
<span class="linenos" data-linenos="120 "></span><span class="w">  </span><span class="k">ADD</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">fk_Comanda_has_Producte_Producte1_idx</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">idProduct</span><span class="o">`</span><span class="p">),</span>
<span class="linenos" data-linenos="121 "></span><span class="w">  </span><span class="k">ADD</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">fk_Comanda_has_Producte_Comanda1_idx</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">idOrder</span><span class="o">`</span><span class="p">);</span>
<span class="linenos" data-linenos="122 "></span>
<span class="linenos" data-linenos="123 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="124 "></span><span class="c1">-- Index de la taula `Orders`</span>
<span class="linenos" data-linenos="125 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="126 "></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">Orders</span><span class="o">`</span>
<span class="linenos" data-linenos="127 "></span><span class="w">  </span><span class="k">ADD</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">),</span>
<span class="linenos" data-linenos="128 "></span><span class="w">  </span><span class="k">ADD</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">fk_Comanda_Tenda1_idx</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">idShop</span><span class="o">`</span><span class="p">);</span>
<span class="linenos" data-linenos="129 "></span>
<span class="linenos" data-linenos="130 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="131 "></span><span class="c1">-- Index de la taula `Products`</span>
<span class="linenos" data-linenos="132 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="133 "></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">Products</span><span class="o">`</span>
<span class="linenos" data-linenos="134 "></span><span class="w">  </span><span class="k">ADD</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">idCategory</span><span class="o">`</span><span class="p">),</span>
<span class="linenos" data-linenos="135 "></span><span class="w">  </span><span class="k">ADD</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">fk_Producte_categoria1_idx</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">idCategory</span><span class="o">`</span><span class="p">);</span>
<span class="linenos" data-linenos="136 "></span>
<span class="linenos" data-linenos="137 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="138 "></span><span class="c1">-- Index de la taula `Shops`</span>
<span class="linenos" data-linenos="139 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="140 "></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">Shops</span><span class="o">`</span>
<span class="linenos" data-linenos="141 "></span><span class="w">  </span><span class="k">ADD</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">);</span>
<span class="linenos" data-linenos="142 "></span>
<span class="linenos" data-linenos="143 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="144 "></span><span class="c1">-- AUTO_INCREMENT per les taules bolcades</span>
<span class="linenos" data-linenos="145 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="146 "></span>
<span class="linenos" data-linenos="147 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="148 "></span><span class="c1">-- AUTO_INCREMENT per la taula `Categories`</span>
<span class="linenos" data-linenos="149 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="150 "></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">Categories</span><span class="o">`</span>
<span class="linenos" data-linenos="151 "></span><span class="w">  </span><span class="k">MODIFY</span><span class="w"> </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="p">,</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">5</span><span class="p">;</span>
<span class="linenos" data-linenos="152 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="153 "></span><span class="c1">-- AUTO_INCREMENT per la taula `Orders`</span>
<span class="linenos" data-linenos="154 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="155 "></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">Orders</span><span class="o">`</span>
<span class="linenos" data-linenos="156 "></span><span class="w">  </span><span class="k">MODIFY</span><span class="w"> </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="p">;</span>
<span class="linenos" data-linenos="157 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="158 "></span><span class="c1">-- AUTO_INCREMENT per la taula `Products`</span>
<span class="linenos" data-linenos="159 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="160 "></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">Products</span><span class="o">`</span>
<span class="linenos" data-linenos="161 "></span><span class="w">  </span><span class="k">MODIFY</span><span class="w"> </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="p">,</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">9</span><span class="p">;</span>
<span class="linenos" data-linenos="162 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="163 "></span><span class="c1">-- AUTO_INCREMENT per la taula `Shops`</span>
<span class="linenos" data-linenos="164 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="165 "></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">Shops</span><span class="o">`</span>
<span class="linenos" data-linenos="166 "></span><span class="w">  </span><span class="k">MODIFY</span><span class="w"> </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="p">,</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span>
<span class="linenos" data-linenos="167 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="168 "></span><span class="c1">-- Restriccions per taules bolcades</span>
<span class="linenos" data-linenos="169 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="170 "></span>
<span class="linenos" data-linenos="171 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="172 "></span><span class="c1">-- Restriccions per la taula `OrderLines`</span>
<span class="linenos" data-linenos="173 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="174 "></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">OrderLines</span><span class="o">`</span>
<span class="linenos" data-linenos="175 "></span><span class="w">  </span><span class="k">ADD</span><span class="w"> </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="o">`</span><span class="n">fk_Comanda_has_Producte_Comanda1</span><span class="o">`</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">idOrder</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="o">`</span><span class="n">Orders</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">NO</span><span class="w"> </span><span class="n">ACTION</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">NO</span><span class="w"> </span><span class="n">ACTION</span><span class="p">,</span>
<span class="linenos" data-linenos="176 "></span><span class="w">  </span><span class="k">ADD</span><span class="w"> </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="o">`</span><span class="n">fk_Comanda_has_Producte_Producte1</span><span class="o">`</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">idProduct</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="o">`</span><span class="n">Products</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">NO</span><span class="w"> </span><span class="n">ACTION</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">NO</span><span class="w"> </span><span class="n">ACTION</span><span class="p">;</span>
<span class="linenos" data-linenos="177 "></span>
<span class="linenos" data-linenos="178 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="179 "></span><span class="c1">-- Restriccions per la taula `Orders`</span>
<span class="linenos" data-linenos="180 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="181 "></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">Orders</span><span class="o">`</span>
<span class="linenos" data-linenos="182 "></span><span class="w">  </span><span class="k">ADD</span><span class="w"> </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="o">`</span><span class="n">fk_Comanda_Tenda1</span><span class="o">`</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">idShop</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="o">`</span><span class="n">Shops</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">NO</span><span class="w"> </span><span class="n">ACTION</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">NO</span><span class="w"> </span><span class="n">ACTION</span><span class="p">;</span>
<span class="linenos" data-linenos="183 "></span>
<span class="linenos" data-linenos="184 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="185 "></span><span class="c1">-- Restriccions per la taula `Products`</span>
<span class="linenos" data-linenos="186 "></span><span class="c1">--</span>
<span class="linenos" data-linenos="187 "></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">Products</span><span class="o">`</span>
<span class="linenos" data-linenos="188 "></span><span class="w">  </span><span class="k">ADD</span><span class="w"> </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="o">`</span><span class="n">fk_Producte_categoria1</span><span class="o">`</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">idCategory</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="o">`</span><span class="n">Categories</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">NO</span><span class="w"> </span><span class="n">ACTION</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">NO</span><span class="w"> </span><span class="n">ACTION</span><span class="p">;</span>
</code></pre></div>
<p>Partim també d'un fitxer distribuidora.css que s'inclou</p>
<h3 id="diagrama-de-fluxe-de-pantalles">Diagrama de fluxe de pantalles<a class="headerlink" href="#diagrama-de-fluxe-de-pantalles" title="Permanent link">&para;</a></h3>
<p>L'objectiu es representar les pantalles per les que pasa l'usuari al realitzar una operació. El següent diagrama pot ser una possible solució a aquest cas:</p>
<h3 id="la-comanda-order">La comanda (order)<a class="headerlink" href="#la-comanda-order" title="Permanent link">&para;</a></h3>
<p>L'estructura de dades utilitzada per a una comanda és un dels punts més importants de l'aplicació. per a emmagatzemar-la utilitzarem una variable de sessió.</p>
<p>La comanda serà un array associatiatiu en els que les claus dels elements representen el codi del producte, y el valor, el número de unitats demanades.</p>
<p>L'array comença buïd. Quan s'afeguix un producte a la comanda, cal comprovar si ja hi ha en el array un element amb eixa clau. Si no l'afegueix. Si hi ha un element amb eixe codi, s'afegueixen les unitats al valor actual de l'element.</p>
<p>De la mateixa manera, a l'eliminar productes de la comanda, cal cercar l'element corresponent i restar-li les unitats.</p>
<h3 id="control-dacces-login">Control d'accés (login)<a class="headerlink" href="#control-dacces-login" title="Permanent link">&para;</a></h3>
<p>Quan es realitza un login amb èxit, es crea una nova sessió i dos variables de sessió:</p>
<ul>
<li>Un array amb dos camps. <ul>
<li>Un per a guardar el ID de la tenda i el seu correu.</li>
<li>La variable per a la comanda.</li>
</ul>
</li>
</ul>
<p>La resta de fitxers de l'aplicació comencen unint-se a la sessió i comprovant que la primera d'estes variables existeix. En cas contrari, no pot accedir i es redirigueix a la pàgina de login.</p>
<h3 id="fitxers-de-laplicacio">Fitxers de l'aplicació<a class="headerlink" href="#fitxers-de-laplicacio" title="Permanent link">&para;</a></h3>
<p>El següent pas es decidir que fitxers formaràn part de l'aplicació i com es comuniquen entre si.</p>
<table>
<thead>
<tr>
<th>Ruta</th>
<th>Descripció</th>
<th>Paràmetres</th>
<th>Adreçar-se a</th>
</tr>
</thead>
<tbody>
<tr>
<td>login.php</td>
<td>Formulari de login</td>
<td>$_GET['redirigit'] $_POST['usuari'] $_POST['clau']</td>
<td>categorias.php</td>
</tr>
<tr>
<td>logoff.php</td>
<td>Tanca la sessió</td>
<td></td>
<td>login.php</td>
</tr>
<tr>
<td>categories.php</td>
<td>Mostra la llista de categories amb vincles a products.php?category=codigo</td>
<td></td>
<td>products.php?category=codigo</td>
</tr>
<tr>
<td>header.php</td>
<td>capçalera</td>
<td></td>
<td></td>
</tr>
<tr>
<td>footer.php</td>
<td>peu de pagina amb enllaços</td>
<td></td>
<td></td>
</tr>
<tr>
<td>products.php</td>
<td>mostra els productes de la categoria, permet afegir a la comanda</td>
<td>$_GET['category']</td>
<td></td>
</tr>
<tr>
<td>order.php</td>
<td>mostra la comanda, permet llevar productes o confirmar-la</td>
<td></td>
<td></td>
</tr>
<tr>
<td>processOrder.php</td>
<td>Insereix la comanda en la BBDD, envia correus de confirmació i mostra missatges d'exit o error</td>
<td></td>
<td></td>
</tr>
<tr>
<td>deleteOrder.php</td>
<td>Esborra la comanda</td>
<td></td>
<td>categories.php</td>
</tr>
<tr>
<td>bd.php</td>
<td>classe per fer la connexio amb la BBDD</td>
<td></td>
<td></td>
</tr>
<tr>
<td>mail.php</td>
<td>classe per a enviar correus</td>
<td></td>
<td></td>
</tr>
<tr>
<td>myHelpers.php</td>
<td>fitxer amb funcions per fer consultes a la base de dades i relaciones amb les sessions</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="implementacio">Implementació<a class="headerlink" href="#implementacio" title="Permanent link">&para;</a></h3>
<h4 id="configuracio-del-lloc-web">configuració del lloc web<a class="headerlink" href="#configuracio-del-lloc-web" title="Permanent link">&para;</a></h4>
<p>Una vegada completat el disseny de l'aplicació, es pot començar en l'implementació. 
  Anem a crear un directori dins de Code que s'anomene <strong>Distribuidora</strong>.
  Entre a la màquina <strong>homestead</strong> i al directori /home/vagrant/Code/Distribuidora:</p>
<ul>
<li>Creem el lloc web al ngnix</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>serve distribuidora.my /home/vagrant/Code/Distribuidora/public
</code></pre></div>
<ul>
<li>Ara instal.lem les dependències que ens faràn falta mitjançant composer:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>  composer require phpmailer/phpmailer
<span class="linenos" data-linenos="2 "></span>  composer require --dev phpunit/phpunit
<span class="linenos" data-linenos="3 "></span>  composer require filp/whoops
</code></pre></div>
<p>Anem a crear els següents directoris:</p>
<ul>
<li><strong>class</strong> per a guardar les classes.</li>
<li><strong>public</strong> on aniran els fitxers de l'aplicatiu.</li>
<li><strong>public/css</strong> per a guardar els fitxers de css.</li>
<li><strong>public/img</strong> per guadar les imatges (cesta.png).</li>
<li><strong>Helpers</strong> on guardem els fitxers de funcions comunes.</li>
<li><strong>config</strong> on hi han fitxers de configuració</li>
</ul>
<p>Modifiquem el fitxer composer.json per a incloure el fitxer de funcions que s'anomenarà <strong>myHelpers.php</strong> i estarà dins de la carpeta Helpers. Aixì qualsevol funció que estiga dins d'eixe fitxer serà visible des de qualsevol fitxer que carregue el <strong>/vendor/autoload.php</strong>. 
  Al mateix temps farem que les classes penjen del namespace <strong>/App</strong> i que estiguen en el directori <strong>class</strong> i així poder importar-les on calguen.
 Així afegim el següent codi:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span> &quot;autoload&quot;: {
<span class="linenos" data-linenos="2 "></span>       &quot;psr-4&quot;:{
<span class="linenos" data-linenos="3 "></span>           &quot;App\\&quot; : &quot;class/&quot;
<span class="linenos" data-linenos="4 "></span>       },
<span class="linenos" data-linenos="5 "></span>       &quot;files&quot;: [
<span class="linenos" data-linenos="6 "></span>           &quot;Helpers/myHelpers.php&quot;
<span class="linenos" data-linenos="7 "></span>       ]
<span class="linenos" data-linenos="8 "></span>   } 
</code></pre></div>
<p>Partint del disseny anterior es van implementant tots els fitxers:</p>
<p>config/database.php</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="cp">&lt;?php</span>
<span class="linenos" data-linenos="2 "></span><span class="k">return</span> <span class="p">[</span>
<span class="linenos" data-linenos="3 "></span>    <span class="s1">&#39;ip&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;192.168.10.10&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="4 "></span>    <span class="s1">&#39;nom&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Distribution&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="5 "></span>    <span class="s1">&#39;usuari&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;homestead&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="6 "></span>    <span class="s1">&#39;clau&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;secret&#39;</span>
<span class="linenos" data-linenos="7 "></span><span class="p">];</span>
</code></pre></div>
<p>config/load.php</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="cp">&lt;?php</span>
<span class="linenos" data-linenos="2 "></span><span class="k">require</span> <span class="nb">dirname</span><span class="p">(</span><span class="no">__FILE__</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&quot;/../vendor/autoload.php&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos="3 "></span><span class="nv">$whoops</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Whoops\Run</span><span class="p">;</span>
<span class="linenos" data-linenos="4 "></span><span class="nv">$whoops</span><span class="o">-&gt;</span><span class="na">pushHandler</span><span class="p">(</span><span class="k">new</span> <span class="nx">\Whoops\Handler\PrettyPageHandler</span><span class="p">);</span>
<span class="linenos" data-linenos="5 "></span><span class="nv">$whoops</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">();</span>
</code></pre></div>
<p>clases/bd.php  </p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="cp">&lt;?php</span>
<span class="linenos" data-linenos=" 2 "></span><span class="k">namespace</span> <span class="nx">App</span><span class="p">;</span>
<span class="linenos" data-linenos=" 3 "></span>
<span class="linenos" data-linenos=" 4 "></span><span class="k">class</span> <span class="nc">bd</span> <span class="k">extends</span> <span class="nx">\PDO</span>
<span class="linenos" data-linenos=" 5 "></span><span class="p">{</span>
<span class="linenos" data-linenos=" 6 "></span>
<span class="linenos" data-linenos=" 7 "></span>    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span>
<span class="linenos" data-linenos=" 8 "></span>    <span class="p">{</span>
<span class="linenos" data-linenos=" 9 "></span>        <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">leer_config</span><span class="p">();</span>
<span class="linenos" data-linenos="10 "></span>        <span class="k">try</span> <span class="p">{</span>
<span class="linenos" data-linenos="11 "></span>            <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="nv">$res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nv">$res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nv">$res</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="linenos" data-linenos="12 "></span>        <span class="p">}</span><span class="k">catch</span> <span class="p">(</span><span class="nx">\PDOException</span> <span class="nv">$e</span><span class="p">){</span>
<span class="linenos" data-linenos="13 "></span>            <span class="k">echo</span> <span class="s2">&quot;Error amb la connexió a la base de dades: &quot;</span><span class="o">.</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">();</span>
<span class="linenos" data-linenos="14 "></span>            <span class="k">exit</span><span class="p">();</span>
<span class="linenos" data-linenos="15 "></span>        <span class="p">}</span>
<span class="linenos" data-linenos="16 "></span>
<span class="linenos" data-linenos="17 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos="18 "></span>
<span class="linenos" data-linenos="19 "></span>    <span class="k">private</span> <span class="k">function</span> <span class="nf">leer_config</span><span class="p">(){</span>
<span class="linenos" data-linenos="20 "></span>        <span class="nv">$config</span> <span class="o">=</span> <span class="k">require</span> <span class="s1">&#39;../config/database.php&#39;</span><span class="p">;</span>
<span class="linenos" data-linenos="21 "></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$config</span><span class="p">){</span>
<span class="linenos" data-linenos="22 "></span>            <span class="k">throw</span> <span class="k">new</span> <span class="nx">InvalidArgumentException</span><span class="p">(</span><span class="s2">&quot;Revise fichero de configuración&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos="23 "></span>        <span class="p">}</span>
<span class="linenos" data-linenos="24 "></span>        <span class="nv">$resul</span> <span class="o">=</span> <span class="p">[];</span>
<span class="linenos" data-linenos="25 "></span>        <span class="nv">$resul</span><span class="p">[]</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s2">&quot;mysql:dbname=%s;host=%s&quot;</span><span class="p">,</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;nom&#39;</span><span class="p">],</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;ip&#39;</span><span class="p">]);</span>
<span class="linenos" data-linenos="26 "></span>        <span class="nv">$resul</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;usuari&#39;</span><span class="p">];</span>
<span class="linenos" data-linenos="27 "></span>        <span class="nv">$resul</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;clau&#39;</span><span class="p">];</span>
<span class="linenos" data-linenos="28 "></span>        <span class="k">return</span> <span class="nv">$resul</span><span class="p">;</span>
<span class="linenos" data-linenos="29 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos="30 "></span>
<span class="linenos" data-linenos="31 "></span><span class="p">}</span>
</code></pre></div>
<p>clases/mail.php</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="cp">&lt;?php</span>
<span class="linenos" data-linenos=" 2 "></span><span class="sd">/**</span>
<span class="linenos" data-linenos=" 3 "></span><span class="sd"> * Created by PhpStorm.</span>
<span class="linenos" data-linenos=" 4 "></span><span class="sd"> * User: igomis</span>
<span class="linenos" data-linenos=" 5 "></span><span class="sd"> * Date: 2019-07-17</span>
<span class="linenos" data-linenos=" 6 "></span><span class="sd"> * Time: 18:50</span>
<span class="linenos" data-linenos=" 7 "></span><span class="sd"> */</span>
<span class="linenos" data-linenos=" 8 "></span><span class="k">namespace</span> <span class="nx">App</span><span class="p">;</span>
<span class="linenos" data-linenos=" 9 "></span>
<span class="linenos" data-linenos="10 "></span><span class="k">use</span> <span class="nx">PHPMailer\PHPMailer\PHPMailer</span><span class="p">;</span>
<span class="linenos" data-linenos="11 "></span>
<span class="linenos" data-linenos="12 "></span><span class="k">class</span> <span class="nc">mail</span>
<span class="linenos" data-linenos="13 "></span><span class="p">{</span>
<span class="linenos" data-linenos="14 "></span>    <span class="k">private</span> <span class="nv">$order</span><span class="p">;</span>
<span class="linenos" data-linenos="15 "></span>    <span class="k">private</span> <span class="nv">$id</span><span class="p">;</span>
<span class="linenos" data-linenos="16 "></span>    <span class="k">private</span> <span class="nv">$email</span><span class="p">;</span>
<span class="linenos" data-linenos="17 "></span>
<span class="linenos" data-linenos="18 "></span>    <span class="sd">/**</span>
<span class="linenos" data-linenos="19 "></span><span class="sd">     * mail constructor.</span>
<span class="linenos" data-linenos="20 "></span><span class="sd">     * @param $order</span>
<span class="linenos" data-linenos="21 "></span><span class="sd">     * @param $idShop</span>
<span class="linenos" data-linenos="22 "></span><span class="sd">     * @param $email</span>
<span class="linenos" data-linenos="23 "></span><span class="sd">     */</span>
<span class="linenos" data-linenos="24 "></span>    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$order</span><span class="p">,</span> <span class="nv">$id</span><span class="p">,</span> <span class="nv">$email</span><span class="p">)</span>
<span class="linenos" data-linenos="25 "></span>    <span class="p">{</span>
<span class="linenos" data-linenos="26 "></span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">order</span> <span class="o">=</span> <span class="nv">$order</span><span class="p">;</span>
<span class="linenos" data-linenos="27 "></span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">id</span> <span class="o">=</span> <span class="nv">$id</span><span class="p">;</span>
<span class="linenos" data-linenos="28 "></span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">email</span> <span class="o">=</span> <span class="nv">$email</span><span class="p">;</span>
<span class="linenos" data-linenos="29 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos="30 "></span>
<span class="linenos" data-linenos="31 "></span>
<span class="linenos" data-linenos="32 "></span>    <span class="k">public</span> <span class="k">function</span> <span class="nf">send</span><span class="p">(){</span>
<span class="linenos" data-linenos="33 "></span>        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sendMails</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">$this-&gt;email</span><span class="s2">, igomis@cipfpbatoi.es&quot;</span><span class="p">,</span> <span class="s2">&quot;Pedido </span><span class="si">$this-&gt;id</span><span class="s2"> confirmado&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos="34 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos="35 "></span>
<span class="linenos" data-linenos="36 "></span>    <span class="k">private</span> <span class="k">function</span> <span class="nf">doMsgHTML</span><span class="p">(){</span>
<span class="linenos" data-linenos="37 "></span>        <span class="nv">$products</span> <span class="o">=</span> <span class="nx">loadProducts</span><span class="p">(</span><span class="nb">array_keys</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">order</span><span class="p">));</span>
<span class="linenos" data-linenos="38 "></span>        <span class="nv">$text</span> <span class="o">=</span> <span class="s2">&quot;&lt;h1&gt;Pedido nº </span><span class="si">$this-&gt;id</span><span class="s2"> &lt;/h1&gt;&lt;h2&gt;Restaurante: </span><span class="si">$this-&gt;email</span><span class="s2"> &lt;/h2&gt;&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos="39 "></span>        <span class="nv">$text</span> <span class="o">.=</span> <span class="s2">&quot;Detalle del pedido:&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos="40 "></span>        <span class="nv">$text</span> <span class="o">.=</span> <span class="s2">&quot;&lt;table&gt;&quot;</span><span class="p">;</span> <span class="c1">//abrir la tabla</span>
<span class="linenos" data-linenos="41 "></span>        <span class="nv">$text</span> <span class="o">.=</span> <span class="s2">&quot;&lt;tr&gt;&lt;th&gt;Id&lt;/th&gt;&lt;th&gt;Nom&lt;/th&gt;&lt;th&gt;Descripció&lt;/th&gt;&lt;th&gt;Unitats&lt;/th&gt;&lt;/tr&gt;&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos="42 "></span>
<span class="linenos" data-linenos="43 "></span>        <span class="k">foreach</span><span class="p">(</span><span class="nv">$products</span> <span class="k">as</span> <span class="nv">$product</span><span class="p">)</span>
<span class="linenos" data-linenos="44 "></span>            <span class="nv">$text</span> <span class="o">.=</span> <span class="s2">&quot;&lt;tr&gt;&lt;td&gt;</span><span class="si">$product-&gt;id</span><span class="s2">&lt;/td&gt;&lt;td&gt;</span><span class="si">$product-&gt;name</span><span class="s2">&lt;/td&gt;&lt;td&gt;</span><span class="si">$product-&gt;description</span><span class="s2">&lt;/td&gt;&lt;td&gt;&quot;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">order</span><span class="p">[</span><span class="nv">$product</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">]</span><span class="o">.</span><span class="s2">&quot;&lt;/td&gt;&lt;td&gt;&lt;/tr&gt;&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos="45 "></span>
<span class="linenos" data-linenos="46 "></span>        <span class="nv">$text</span> <span class="o">.=</span> <span class="s2">&quot;&lt;/table&gt;&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos="47 "></span>        <span class="k">return</span> <span class="nv">$text</span><span class="p">;</span>
<span class="linenos" data-linenos="48 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos="49 "></span>
<span class="linenos" data-linenos="50 "></span>    <span class="k">private</span> <span class="k">function</span> <span class="nf">sendMails</span><span class="p">(</span><span class="nv">$emailsList</span><span class="p">,</span>  <span class="nv">$subject</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">){</span>
<span class="linenos" data-linenos="51 "></span>        <span class="nv">$mail</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PHPMailer</span><span class="p">();</span>
<span class="linenos" data-linenos="52 "></span>        <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">IsSMTP</span><span class="p">();</span>
<span class="linenos" data-linenos="53 "></span>        <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">SMTPDebug</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// cambiar a 1 o 2 para ver errores</span>
<span class="linenos" data-linenos="54 "></span>        <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">SMTPAuth</span>   <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
<span class="linenos" data-linenos="55 "></span>        <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">SMTPSecure</span> <span class="o">=</span> <span class="s2">&quot;tls&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos="56 "></span>        <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">Host</span>       <span class="o">=</span> <span class="s2">&quot;smtp.gmail.com&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos="57 "></span>        <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">Port</span>       <span class="o">=</span> <span class="mi">587</span><span class="p">;</span>
<span class="linenos" data-linenos="58 "></span>        <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">Username</span>   <span class="o">=</span> <span class="s2">&quot;cipfpbatoi2daw@gmail.com&quot;</span><span class="p">;</span>  <span class="c1">//usuario de gmail</span>
<span class="linenos" data-linenos="59 "></span>        <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">Password</span>   <span class="o">=</span> <span class="s2">&quot;2dawDWES&quot;</span><span class="p">;</span> <span class="c1">//contraseña de gmail</span>
<span class="linenos" data-linenos="60 "></span>        <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">SetFrom</span><span class="p">(</span><span class="s1">&#39;noreply@empresafalsa.com&#39;</span><span class="p">,</span> <span class="s1">&#39;Sistema de pedidos&#39;</span><span class="p">);</span>
<span class="linenos" data-linenos="61 "></span>        <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">Subject</span>    <span class="o">=</span> <span class="nv">$subject</span><span class="p">;</span>
<span class="linenos" data-linenos="62 "></span>        <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">MsgHTML</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">doMsgHTML</span><span class="p">());</span>
<span class="linenos" data-linenos="63 "></span>
<span class="linenos" data-linenos="64 "></span>        <span class="k">foreach</span><span class="p">(</span><span class="nb">explode</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="nv">$emailsList</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$email</span><span class="p">){</span>
<span class="linenos" data-linenos="65 "></span>            <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">AddAddress</span><span class="p">(</span><span class="nv">$email</span><span class="p">,</span> <span class="nv">$email</span><span class="p">);</span>
<span class="linenos" data-linenos="66 "></span>        <span class="p">}</span>
<span class="linenos" data-linenos="67 "></span>        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">Send</span><span class="p">())</span> <span class="p">{</span>
<span class="linenos" data-linenos="68 "></span>            <span class="k">return</span> <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">ErrorInfo</span><span class="p">;</span>
<span class="linenos" data-linenos="69 "></span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="linenos" data-linenos="70 "></span>            <span class="k">return</span> <span class="k">TRUE</span><span class="p">;</span>
<span class="linenos" data-linenos="71 "></span>        <span class="p">}</span>
<span class="linenos" data-linenos="72 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos="73 "></span><span class="p">}</span>
</code></pre></div>
<p>Helpers/myHelpers.php</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="cp">&lt;?php</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span>
<span class="linenos" data-linenos=" 4 "></span><span class="k">use</span> <span class="nx">App\bd</span><span class="p">;</span>
<span class="linenos" data-linenos=" 5 "></span>
<span class="linenos" data-linenos=" 6 "></span><span class="k">function</span> <span class="nf">checkLogin</span><span class="p">(</span><span class="nv">$email</span><span class="p">,</span> <span class="nv">$pass</span><span class="p">){</span>
<span class="linenos" data-linenos=" 7 "></span>    <span class="nv">$bd</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">bd</span><span class="p">();</span>
<span class="linenos" data-linenos=" 8 "></span>    <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$bd</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">&quot;SELECT id, mailAdress FROM Shops WHERE mailAdress LIKE :email AND password LIKE :pass&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos=" 9 "></span>    <span class="nv">$resul</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">([</span><span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="nv">$email</span><span class="p">,</span><span class="s1">&#39;pass&#39;</span> <span class="o">=&gt;</span> <span class="nv">$pass</span><span class="p">]);</span>
<span class="linenos" data-linenos="10 "></span>    <span class="k">if</span><span class="p">(</span><span class="nv">$resul</span><span class="p">){</span>
<span class="linenos" data-linenos="11 "></span>        <span class="k">return</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">fetch</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_OBJ</span><span class="p">);</span>
<span class="linenos" data-linenos="12 "></span>    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="linenos" data-linenos="13 "></span>        <span class="k">return</span> <span class="k">FALSE</span><span class="p">;</span>
<span class="linenos" data-linenos="14 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos="15 "></span><span class="p">}</span>
<span class="linenos" data-linenos="16 "></span><span class="k">function</span> <span class="nf">loadCategories</span><span class="p">(){</span>
<span class="linenos" data-linenos="17 "></span>    <span class="nv">$bd</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">bd</span><span class="p">();</span>
<span class="linenos" data-linenos="18 "></span>    <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$bd</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">&quot;select * from Categories&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos="19 "></span>    <span class="nv">$resul</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
<span class="linenos" data-linenos="20 "></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$resul</span><span class="p">)</span> <span class="k">return</span> <span class="p">[];</span>
<span class="linenos" data-linenos="21 "></span>    <span class="k">return</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">fetchAll</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_OBJ</span><span class="p">);</span>
<span class="linenos" data-linenos="22 "></span><span class="p">}</span>
<span class="linenos" data-linenos="23 "></span><span class="k">function</span> <span class="nf">loadCategory</span><span class="p">(</span><span class="nv">$id</span><span class="p">){</span>
<span class="linenos" data-linenos="24 "></span>    <span class="nv">$bd</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">bd</span><span class="p">();</span>
<span class="linenos" data-linenos="25 "></span>    <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$bd</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span> <span class="s2">&quot;select * from Categories where id = :id&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos="26 "></span>    <span class="nv">$resul</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">([</span><span class="s1">&#39;id&#39;</span><span class="o">=&gt;</span><span class="nv">$id</span><span class="p">]);</span>
<span class="linenos" data-linenos="27 "></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$resul</span><span class="p">)</span> <span class="k">return</span> <span class="p">[];</span>
<span class="linenos" data-linenos="28 "></span>    <span class="k">return</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">fetch</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_OBJ</span><span class="p">);</span>
<span class="linenos" data-linenos="29 "></span><span class="p">}</span>
<span class="linenos" data-linenos="30 "></span><span class="k">function</span> <span class="nf">loadProductsCategory</span><span class="p">(</span><span class="nv">$id</span><span class="p">){</span>
<span class="linenos" data-linenos="31 "></span>    <span class="nv">$bd</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">bd</span><span class="p">();</span>
<span class="linenos" data-linenos="32 "></span>    <span class="nv">$sth</span><span class="o">=</span> <span class="nv">$bd</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">&quot;select * from Products where idCategory  = :id&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos="33 "></span>    <span class="nv">$resul</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">([</span><span class="s1">&#39;id&#39;</span><span class="o">=&gt;</span><span class="nv">$id</span><span class="p">]);</span>
<span class="linenos" data-linenos="34 "></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$resul</span><span class="p">)</span> <span class="k">return</span> <span class="p">[];</span>
<span class="linenos" data-linenos="35 "></span>    <span class="k">return</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">fetchAll</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_OBJ</span><span class="p">);</span>
<span class="linenos" data-linenos="36 "></span><span class="p">}</span>
<span class="linenos" data-linenos="37 "></span>
<span class="linenos" data-linenos="38 "></span>
<span class="linenos" data-linenos="39 "></span><span class="c1">// recibe un array de códigos de productos</span>
<span class="linenos" data-linenos="40 "></span><span class="c1">// devuelve un cursor con los datos de esos productos</span>
<span class="linenos" data-linenos="41 "></span><span class="k">function</span> <span class="nf">loadProduct</span><span class="p">(</span><span class="nv">$id</span><span class="p">){</span>
<span class="linenos" data-linenos="42 "></span>    <span class="nv">$bd</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">bd</span><span class="p">();</span>
<span class="linenos" data-linenos="43 "></span>    <span class="nv">$sth</span><span class="o">=</span> <span class="nv">$bd</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">&quot;select * from Products where id  = :id&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos="44 "></span>    <span class="nv">$resul</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">([</span><span class="s1">&#39;id&#39;</span><span class="o">=&gt;</span><span class="nv">$id</span><span class="p">]);</span>
<span class="linenos" data-linenos="45 "></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$resul</span><span class="p">)</span> <span class="k">return</span> <span class="p">[];</span>
<span class="linenos" data-linenos="46 "></span>    <span class="k">return</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">fetch</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_OBJ</span><span class="p">);</span>
<span class="linenos" data-linenos="47 "></span><span class="p">}</span>
<span class="linenos" data-linenos="48 "></span>
<span class="linenos" data-linenos="49 "></span><span class="c1">// recibe un array de códigos de productos</span>
<span class="linenos" data-linenos="50 "></span><span class="c1">// devuelve un cursor con los datos de esos productos</span>
<span class="linenos" data-linenos="51 "></span><span class="k">function</span> <span class="nf">loadProducts</span><span class="p">(</span><span class="k">Array</span> <span class="nv">$ids</span><span class="p">){</span>
<span class="linenos" data-linenos="52 "></span>    <span class="nv">$bd</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">bd</span><span class="p">();</span>
<span class="linenos" data-linenos="53 "></span>    <span class="nv">$setProducts</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="nv">$ids</span><span class="p">);</span>
<span class="linenos" data-linenos="54 "></span>    <span class="nv">$resul</span> <span class="o">=</span> <span class="nv">$bd</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span> <span class="s2">&quot;select * from Products where id in(</span><span class="si">$setProducts</span><span class="s2">)&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos="55 "></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$resul</span><span class="p">)</span> <span class="k">return</span> <span class="k">FALSE</span><span class="p">;</span>
<span class="linenos" data-linenos="56 "></span>    <span class="k">return</span> <span class="nv">$resul</span><span class="o">-&gt;</span><span class="na">fetchAll</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_OBJ</span><span class="p">);</span>
<span class="linenos" data-linenos="57 "></span><span class="p">}</span>
<span class="linenos" data-linenos="58 "></span>
<span class="linenos" data-linenos="59 "></span><span class="k">function</span> <span class="nf">addOrder</span><span class="p">(</span><span class="nv">$order</span><span class="p">,</span> <span class="nv">$idShop</span><span class="p">){</span>
<span class="linenos" data-linenos="60 "></span>    <span class="nv">$bd</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">bd</span><span class="p">();</span>
<span class="linenos" data-linenos="61 "></span>    <span class="nv">$bd</span><span class="o">-&gt;</span><span class="na">beginTransaction</span><span class="p">();</span>    
<span class="linenos" data-linenos="62 "></span>
<span class="linenos" data-linenos="63 "></span>    <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$bd</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">&quot;insert into Orders(date, send, idShop) values (:hora,:send,:idShop)&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos="64 "></span>    <span class="nv">$resul</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">([</span><span class="s1">&#39;hora&#39;</span><span class="o">=&gt;</span><span class="nb">date</span><span class="p">(</span><span class="s2">&quot;Y-m-d H:i:s&quot;</span><span class="p">,</span> <span class="nb">time</span><span class="p">()),</span><span class="s1">&#39;send&#39;</span><span class="o">=&gt;</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;idShop&#39;</span><span class="o">=&gt;</span><span class="nv">$idShop</span><span class="p">]);</span>
<span class="linenos" data-linenos="65 "></span>
<span class="linenos" data-linenos="66 "></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$resul</span><span class="p">)</span> <span class="k">return</span> <span class="k">FALSE</span><span class="p">;</span>
<span class="linenos" data-linenos="67 "></span>
<span class="linenos" data-linenos="68 "></span>    <span class="c1">// coger el id del nuevo pedido para las filas detalle</span>
<span class="linenos" data-linenos="69 "></span>    <span class="nv">$idOrder</span> <span class="o">=</span> <span class="nv">$bd</span><span class="o">-&gt;</span><span class="na">lastInsertId</span><span class="p">();</span>
<span class="linenos" data-linenos="70 "></span>    <span class="c1">// insertar las filas en pedidoproductos</span>
<span class="linenos" data-linenos="71 "></span>
<span class="linenos" data-linenos="72 "></span>    <span class="k">foreach</span><span class="p">(</span><span class="nv">$order</span> <span class="k">as</span> <span class="nv">$id</span><span class="o">=&gt;</span><span class="nv">$amount</span><span class="p">){</span>
<span class="linenos" data-linenos="73 "></span>        <span class="nv">$sth</span> <span class="o">=</span>  <span class="nv">$bd</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">&quot;insert into OrderLines(idOrder, idProduct, amount) values( :idOrder, :idProduct, :amount)&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos="74 "></span>        <span class="nv">$resul</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">([</span><span class="s1">&#39;idOrder&#39;</span><span class="o">=&gt;</span><span class="nv">$idOrder</span><span class="p">,</span><span class="s1">&#39;idProduct&#39;</span><span class="o">=&gt;</span><span class="nv">$id</span><span class="p">,</span><span class="s1">&#39;amount&#39;</span><span class="o">=&gt;</span><span class="nv">$amount</span><span class="p">]);</span>
<span class="linenos" data-linenos="75 "></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$resul</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos" data-linenos="76 "></span>            <span class="nv">$bd</span><span class="o">-&gt;</span><span class="na">rollback</span><span class="p">();</span>
<span class="linenos" data-linenos="77 "></span>            <span class="k">return</span> <span class="k">FALSE</span><span class="p">;</span>
<span class="linenos" data-linenos="78 "></span>        <span class="p">}</span>
<span class="linenos" data-linenos="79 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos="80 "></span>    <span class="nv">$bd</span><span class="o">-&gt;</span><span class="na">commit</span><span class="p">();</span>
<span class="linenos" data-linenos="81 "></span>    <span class="k">return</span> <span class="nv">$idOrder</span><span class="p">;</span>
<span class="linenos" data-linenos="82 "></span><span class="p">}</span>
<span class="linenos" data-linenos="83 "></span>
<span class="linenos" data-linenos="84 "></span><span class="k">function</span> <span class="nf">checkSession</span><span class="p">(){</span>
<span class="linenos" data-linenos="85 "></span>    <span class="nb">session_start</span><span class="p">();</span>
<span class="linenos" data-linenos="86 "></span>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">])){</span>
<span class="linenos" data-linenos="87 "></span>        <span class="nb">header</span><span class="p">(</span><span class="s2">&quot;Location: login.php?redirigido=true&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos="88 "></span>        <span class="k">exit</span><span class="p">();</span>
<span class="linenos" data-linenos="89 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos="90 "></span>
<span class="linenos" data-linenos="91 "></span><span class="p">}</span>
<span class="linenos" data-linenos="92 "></span>
<span class="linenos" data-linenos="93 "></span><span class="k">function</span> <span class="nf">dd</span><span class="p">(</span><span class="nv">$var</span><span class="p">){</span>
<span class="linenos" data-linenos="94 "></span>    <span class="nb">var_dump</span><span class="p">(</span><span class="nv">$var</span><span class="p">);</span>
<span class="linenos" data-linenos="95 "></span>    <span class="k">exit</span><span class="p">();</span>
<span class="linenos" data-linenos="96 "></span><span class="p">}</span>
</code></pre></div>
<p>public/login.php</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="cp">&lt;?php</span>
<span class="linenos" data-linenos=" 2 "></span><span class="k">require</span> <span class="nb">dirname</span><span class="p">(</span><span class="no">__FILE__</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&quot;/../config/load.php&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos=" 3 "></span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span><span class="cm">/*formulario de login habitual</span>
<span class="linenos" data-linenos=" 6 "></span><span class="cm">si va bien abre sesión, guarda el nombre de usuario y redirige a principal.php </span>
<span class="linenos" data-linenos=" 7 "></span><span class="cm">si va mal, mensaje de error */</span>
<span class="linenos" data-linenos=" 8 "></span>
<span class="linenos" data-linenos=" 9 "></span><span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s2">&quot;redirigido&quot;</span><span class="p">]))</span> <span class="nv">$error</span> <span class="o">=</span> <span class="s1">&#39;Haga login para continuar&#39;</span><span class="p">;</span>
<span class="linenos" data-linenos="10 "></span><span class="k">else</span> <span class="nv">$error</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="linenos" data-linenos="11 "></span>
<span class="linenos" data-linenos="12 "></span><span class="k">if</span> <span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s2">&quot;REQUEST_METHOD&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">)</span> <span class="p">{</span>  
<span class="linenos" data-linenos="13 "></span>
<span class="linenos" data-linenos="14 "></span>    <span class="nv">$usu</span> <span class="o">=</span> <span class="nx">checkLogin</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;usuario&#39;</span><span class="p">],</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;clave&#39;</span><span class="p">]);</span>
<span class="linenos" data-linenos="15 "></span>
<span class="linenos" data-linenos="16 "></span>    <span class="k">if</span><span class="p">(</span><span class="nv">$usu</span><span class="o">===</span><span class="k">false</span><span class="p">){</span>
<span class="linenos" data-linenos="17 "></span>        <span class="nv">$error</span> <span class="o">=</span> <span class="s1">&#39;Revise usuario y contraseña&#39;</span><span class="p">;</span>
<span class="linenos" data-linenos="18 "></span>        <span class="nv">$usuario</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">];</span>
<span class="linenos" data-linenos="19 "></span>    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="linenos" data-linenos="20 "></span>        <span class="nb">session_start</span><span class="p">();</span>
<span class="linenos" data-linenos="21 "></span>        <span class="c1">// $usu tiene campos correo y codRes, correo </span>
<span class="linenos" data-linenos="22 "></span>        <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$usu</span><span class="p">;</span>
<span class="linenos" data-linenos="23 "></span>        <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
<span class="linenos" data-linenos="24 "></span>        <span class="nb">header</span><span class="p">(</span><span class="s2">&quot;Location: categories.php&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos="25 "></span>        <span class="k">return</span><span class="p">;</span>
<span class="linenos" data-linenos="26 "></span>    <span class="p">}</span>   
<span class="linenos" data-linenos="27 "></span><span class="p">}</span>
<span class="linenos" data-linenos="28 "></span><span class="cp">?&gt;</span>
<span class="linenos" data-linenos="29 "></span>
<span class="linenos" data-linenos="30 "></span><span class="x">&lt;!DOCTYPE html&gt;</span>
<span class="linenos" data-linenos="31 "></span><span class="x">&lt;html&gt;</span>
<span class="linenos" data-linenos="32 "></span><span class="x">    &lt;head&gt;</span>
<span class="linenos" data-linenos="33 "></span><span class="x">        &lt;title&gt;Formulario de login&lt;/title&gt;</span>
<span class="linenos" data-linenos="34 "></span><span class="x">        &lt;meta charset = &quot;UTF-8&quot;&gt;</span>
<span class="linenos" data-linenos="35 "></span><span class="x">        &lt;link href=&quot;/css/distribuidora.css&quot; rel=&quot;stylesheet&quot;&gt;</span>
<span class="linenos" data-linenos="36 "></span><span class="x">    &lt;/head&gt;</span>
<span class="linenos" data-linenos="37 "></span><span class="x">    &lt;body&gt;</span>
<span class="linenos" data-linenos="38 "></span><span class="x">    &lt;div id=&#39;login&#39;&gt;</span>
<span class="linenos" data-linenos="39 "></span><span class="x">        &lt;form action = &quot;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s2">&quot;PHP_SELF&quot;</span><span class="p">]);</span><span class="cp">?&gt;</span><span class="x">&quot; method = &quot;POST&quot;&gt;</span>
<span class="linenos" data-linenos="40 "></span><span class="x">            &lt;fieldset&gt;</span>
<span class="linenos" data-linenos="41 "></span><span class="x">                &lt;legend&gt;Login&lt;/legend&gt;</span>
<span class="linenos" data-linenos="42 "></span><span class="x">                &lt;div&gt;</span>
<span class="linenos" data-linenos="43 "></span><span class="x">                    &lt;span class=&#39;error&#39;&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$error</span> <span class="cp">?&gt;</span><span class="x">&lt;/span&gt;</span>
<span class="linenos" data-linenos="44 "></span><span class="x">                &lt;/div&gt;</span>
<span class="linenos" data-linenos="45 "></span><span class="x">                &lt;div class=&#39;campo&#39;&gt;</span>
<span class="linenos" data-linenos="46 "></span><span class="x">                    &lt;label for = &quot;usuario&quot;&gt;Usuari&lt;/label&gt;</span>
<span class="linenos" data-linenos="47 "></span><span class="x">                    &lt;input value = &quot;</span><span class="cp">&lt;?php</span> <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$usuario</span><span class="p">))</span><span class="k">echo</span> <span class="nv">$usuario</span><span class="p">;</span><span class="cp">?&gt;</span><span class="x">&quot; id = &quot;usuario&quot; name = &quot;usuario&quot; type = &quot;text&quot; maxlength=&quot;50&quot; /&gt;</span>
<span class="linenos" data-linenos="48 "></span><span class="x">                &lt;/div&gt;</span>
<span class="linenos" data-linenos="49 "></span><span class="x">                &lt;div class=&#39;campo&#39;&gt;</span>
<span class="linenos" data-linenos="50 "></span><span class="x">                    &lt;label for = &quot;clave&quot;&gt;Clau&lt;/label&gt;</span>
<span class="linenos" data-linenos="51 "></span><span class="x">                    &lt;input id = &quot;clave&quot; name = &quot;clave&quot; type = &quot;password&quot;  maxlength=&quot;50&quot; /&gt;</span>
<span class="linenos" data-linenos="52 "></span><span class="x">                &lt;/div&gt;</span>
<span class="linenos" data-linenos="53 "></span><span class="x">                &lt;div class=&#39;campo&#39; style=&#39;text-align: center&#39;&gt;</span>
<span class="linenos" data-linenos="54 "></span><span class="x">                    &lt;input type = &quot;submit&quot; class=&quot;boton&quot; name=&quot;enviar&quot; value=&quot;enviar&quot;&gt;</span>
<span class="linenos" data-linenos="55 "></span><span class="x">                &lt;/div&gt;</span>
<span class="linenos" data-linenos="56 "></span><span class="x">            &lt;/fieldset&gt;</span>
<span class="linenos" data-linenos="57 "></span><span class="x">        &lt;/form&gt;</span>
<span class="linenos" data-linenos="58 "></span><span class="x">    &lt;/div&gt;</span>
<span class="linenos" data-linenos="59 "></span><span class="x">    &lt;/body&gt;</span>
<span class="linenos" data-linenos="60 "></span><span class="x">&lt;/html&gt;</span>
<span class="linenos" data-linenos="61 "></span><span class="x">&lt;body&gt;</span>
</code></pre></div>
<p>public/logoff.php</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="cp">&lt;?php</span>
<span class="linenos" data-linenos="2 "></span>    <span class="k">require</span> <span class="nb">dirname</span><span class="p">(</span><span class="no">__FILE__</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&quot;/../config/load.php&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos="3 "></span>    <span class="nb">session_start</span><span class="p">();</span>
<span class="linenos" data-linenos="4 "></span>    <span class="nv">$_SESSION</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="linenos" data-linenos="5 "></span>    <span class="nb">session_destroy</span><span class="p">();</span>  <span class="c1">// eliminar la sesion</span>
<span class="linenos" data-linenos="6 "></span>    <span class="nb">setcookie</span><span class="p">(</span><span class="nb">session_name</span><span class="p">(),</span> <span class="mi">123</span><span class="p">,</span> <span class="nb">time</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1000</span><span class="p">);</span> <span class="c1">// eliminar la cookie</span>
<span class="linenos" data-linenos="7 "></span>    <span class="nb">header</span><span class="p">(</span><span class="s2">&quot;Location: login.php&quot;</span><span class="p">);</span>
</code></pre></div>
<p>public/header.php</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="cp">&lt;?php</span>
<span class="linenos" data-linenos=" 2 "></span><span class="k">require</span> <span class="nb">dirname</span><span class="p">(</span><span class="no">__FILE__</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&quot;/../config/load.php&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos=" 3 "></span><span class="nx">checkSession</span><span class="p">();</span>
<span class="linenos" data-linenos=" 4 "></span><span class="cp">?&gt;</span>
<span class="linenos" data-linenos=" 5 "></span><span class="x">&lt;!DOCTYPE html&gt;</span>
<span class="linenos" data-linenos=" 6 "></span><span class="x">&lt;html&gt;</span>
<span class="linenos" data-linenos=" 7 "></span><span class="x">    &lt;head&gt;</span>
<span class="linenos" data-linenos=" 8 "></span><span class="x">        &lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=UTF-8&quot;&gt;</span>
<span class="linenos" data-linenos=" 9 "></span><span class="x">        &lt;title&gt;Tarea 5: Listado de Productos con Plantillas&lt;/title&gt;</span>
<span class="linenos" data-linenos="10 "></span><span class="x">        &lt;link href=&quot;/css/distribuidora.css&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot;&gt;</span>
<span class="linenos" data-linenos="11 "></span><span class="x">    &lt;/head&gt;</span>
<span class="linenos" data-linenos="12 "></span><span class="x">    &lt;body class=&quot;pagproductos&quot;&gt;</span>
<span class="linenos" data-linenos="13 "></span><span class="x">        &lt;div id=&quot;contenedor&quot;&gt;``` </span>
<span class="linenos" data-linenos="14 "></span>
<span class="linenos" data-linenos="15 "></span><span class="x">public/footer.php</span>
<span class="linenos" data-linenos="16 "></span>
<span class="linenos" data-linenos="17 "></span><span class="x">```php </span>
<span class="linenos" data-linenos="18 "></span><span class="x">            &lt;br class=&quot;divisor&quot; /&gt;</span>
<span class="linenos" data-linenos="19 "></span><span class="x">            &lt;div id=&quot;pie&quot;&gt;</span>
<span class="linenos" data-linenos="20 "></span><span class="x">                &lt;form action=&#39;categories.php&#39; method=&#39;post&#39;&gt;</span>
<span class="linenos" data-linenos="21 "></span><span class="x">                    &lt;!-- Botón del mismo tipo que los demás --&gt;</span>
<span class="linenos" data-linenos="22 "></span><span class="x">                    &lt;input type=&#39;submit&#39; name=&#39;categories&#39; class=&#39;boton&#39; style=&#39;width:100%;&#39; value=&#39;Tornar Categories&#39; ?&gt;</span>
<span class="linenos" data-linenos="23 "></span><span class="x">                &lt;/form&gt;</span>
<span class="linenos" data-linenos="24 "></span><span class="x">                &lt;form action=&#39;logoff.php&#39; method=&#39;post&#39;&gt;</span>
<span class="linenos" data-linenos="25 "></span><span class="x">                    &lt;!-- Botón del mismo tipo que los demás --&gt;</span>
<span class="linenos" data-linenos="26 "></span><span class="x">                    &lt;input type=&#39;submit&#39; name=&#39;desconectar&#39; class=&#39;boton&#39; style=&#39;width:100%;&#39; value=&#39;Desconectar usuario </span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">mailAdress</span> <span class="cp">?&gt;</span><span class="x">&#39;/&gt;</span>
<span class="linenos" data-linenos="27 "></span><span class="x">                &lt;/form&gt;</span>
<span class="linenos" data-linenos="28 "></span><span class="x">            &lt;/div&gt;</span>
<span class="linenos" data-linenos="29 "></span><span class="x">        &lt;/div&gt;</span>
<span class="linenos" data-linenos="30 "></span><span class="x">    &lt;/body&gt;</span>
<span class="linenos" data-linenos="31 "></span><span class="x">&lt;/html&gt;</span>
</code></pre></div>
<p>public/categories.php</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="cp">&lt;?php</span> <span class="k">require</span> <span class="s1">&#39;header.php&#39;</span><span class="p">;</span><span class="cp">?&gt;</span>
<span class="linenos" data-linenos=" 2 "></span><span class="x">&lt;div id=&quot;encabezado&quot;&gt;</span>
<span class="linenos" data-linenos=" 3 "></span><span class="x">    &lt;h1&gt;Llistat de categories&lt;/h1&gt;</span>
<span class="linenos" data-linenos=" 4 "></span><span class="x">&lt;/div&gt;</span>
<span class="linenos" data-linenos=" 5 "></span><span class="cp">&lt;?php</span>
<span class="linenos" data-linenos=" 6 "></span>    <span class="nv">$categorias</span> <span class="o">=</span> <span class="nx">loadCategories</span><span class="p">();</span>
<span class="linenos" data-linenos=" 7 "></span>    <span class="k">foreach</span><span class="p">(</span><span class="nv">$categorias</span> <span class="k">as</span> <span class="nv">$cat</span><span class="p">){</span>
<span class="linenos" data-linenos=" 8 "></span><span class="cp">?&gt;</span>
<span class="linenos" data-linenos=" 9 "></span><span class="x">     &lt;p&gt;&lt;a href=&#39;products.php?category=</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$cat</span><span class="o">-&gt;</span><span class="na">id</span> <span class="cp">?&gt;</span><span class="x">&#39;&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$cat</span><span class="o">-&gt;</span><span class="na">name</span> <span class="cp">?&gt;</span><span class="x">&lt;/a&gt;&lt;/p&gt;</span>
<span class="linenos" data-linenos="10 "></span><span class="cp">&lt;?php</span> <span class="p">};</span>
<span class="linenos" data-linenos="11 "></span>    <span class="k">require</span> <span class="s1">&#39;footer.php&#39;</span><span class="p">;</span> <span class="cp">?&gt;</span>
</code></pre></div>
<p>public/products.php</p>
<p><div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="cp">&lt;?php</span>
<span class="linenos" data-linenos=" 2 "></span>    <span class="k">require</span> <span class="s1">&#39;header.php&#39;</span><span class="p">;</span>
<span class="linenos" data-linenos=" 3 "></span>    <span class="nv">$cat</span> <span class="o">=</span> <span class="nx">loadCategory</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]);</span>
<span class="linenos" data-linenos=" 4 "></span>    <span class="nv">$products</span> <span class="o">=</span> <span class="nx">loadProductsCategory</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]);</span>
<span class="linenos" data-linenos=" 5 "></span>
<span class="linenos" data-linenos=" 6 "></span>    <span class="k">if</span> <span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s2">&quot;REQUEST_METHOD&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">){</span>
<span class="linenos" data-linenos=" 7 "></span>        <span class="nv">$id</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">];</span>
<span class="linenos" data-linenos=" 8 "></span>        <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">][</span><span class="nv">$id</span><span class="p">])){</span>
<span class="linenos" data-linenos=" 9 "></span>            <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">][</span><span class="nv">$id</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">];</span>
<span class="linenos" data-linenos="10 "></span>        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="linenos" data-linenos="11 "></span>            <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">][</span><span class="nv">$id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">];</span>
<span class="linenos" data-linenos="12 "></span>        <span class="p">}</span>
<span class="linenos" data-linenos="13 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos="14 "></span><span class="cp">?&gt;</span>
<span class="linenos" data-linenos="15 "></span><span class="x">    &lt;div id=&quot;encabezado&quot;&gt;</span>
<span class="linenos" data-linenos="16 "></span><span class="x">        &lt;h1&gt;Productes categoria </span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$cat</span><span class="o">-&gt;</span><span class="na">name</span> <span class="cp">?&gt;</span><span class="x">&lt;/h1&gt;</span>
<span class="linenos" data-linenos="17 "></span><span class="x">    &lt;/div&gt;</span>
<span class="linenos" data-linenos="18 "></span><span class="x">    &lt;div id=&quot;cesta&quot; style=&quot;text-align:center&quot;&gt;</span>
<span class="linenos" data-linenos="19 "></span><span class="x">        </span><span class="cp">&lt;?php</span> <span class="k">require_once</span> <span class="s2">&quot;order.php&quot;</span> <span class="cp">?&gt;</span>
<span class="linenos" data-linenos="20 "></span><span class="x">    &lt;/div&gt;</span>
<span class="linenos" data-linenos="21 "></span><span class="x">    &lt;div id=&quot;productos&quot;&gt;</span>
<span class="linenos" data-linenos="22 "></span><span class="x">        </span><span class="cp">&lt;?php</span> <span class="k">foreach</span><span class="p">(</span><span class="nv">$products</span> <span class="k">as</span> <span class="nv">$product</span><span class="p">){</span> <span class="cp">?&gt;</span>
<span class="linenos" data-linenos="23 "></span><span class="x">        &lt;p&gt;</span>
<span class="linenos" data-linenos="24 "></span><span class="x">        &lt;form id=&#39;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">id</span> <span class="cp">?&gt;</span><span class="x">&#39;  method=&#39;post&#39;&gt;</span>
<span class="linenos" data-linenos="25 "></span><span class="x">            &lt;label&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">name</span> <span class="cp">?&gt;</span><span class="x"> - </span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">description</span>  <span class="cp">?&gt;</span><span class="x">(</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">stock</span> <span class="cp">?&gt;</span><span class="x">)&lt;/label&gt;</span>
<span class="linenos" data-linenos="26 "></span><span class="x">            &lt;input name = &#39;id&#39; type=&#39;hidden&#39; value = &#39;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">id</span> <span class="cp">?&gt;</span><span class="x">&#39;&gt;</span>
<span class="linenos" data-linenos="27 "></span><span class="x">            &lt;input name = &#39;amount&#39; type=&#39;number&#39; min = &#39;1&#39; value = &#39;1&#39;&gt;</span>
<span class="linenos" data-linenos="28 "></span><span class="x">            &lt;input type = &#39;submit&#39; value=&#39;Comprar&#39;&gt;</span>
<span class="linenos" data-linenos="29 "></span><span class="x">        &lt;/form&gt;</span>
<span class="linenos" data-linenos="30 "></span><span class="x">        &lt;/p&gt;</span>
<span class="linenos" data-linenos="31 "></span><span class="x">        </span><span class="cp">&lt;?php</span> <span class="p">};</span> <span class="cp">?&gt;</span>
<span class="linenos" data-linenos="32 "></span><span class="x">    &lt;/div&gt;</span>
<span class="linenos" data-linenos="33 "></span><span class="cp">&lt;?php</span> <span class="k">require</span> <span class="s1">&#39;footer.php&#39;</span><span class="p">;</span> <span class="cp">?&gt;</span>
</code></pre></div>
public/order.php</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="x">&lt;h3&gt;&lt;img src=&#39;img/cesta.png&#39; alt=&#39;Cesta&#39; width=&#39;24&#39; height=&#39;21&#39;&gt;Comanda&lt;/h3&gt;</span>
<span class="linenos" data-linenos=" 2 "></span><span class="x">&lt;hr /&gt;</span>
<span class="linenos" data-linenos=" 3 "></span><span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]))</span> <span class="k">echo</span> <span class="s2">&quot;&lt;p&gt;Buïda&lt;/p&gt;&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos=" 4 "></span>      <span class="k">else</span> <span class="p">{</span>
<span class="linenos" data-linenos=" 5 "></span>          <span class="k">foreach</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$amount</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos" data-linenos=" 6 "></span>              <span class="nv">$product</span> <span class="o">=</span> <span class="nx">loadProduct</span><span class="p">(</span><span class="nv">$key</span><span class="p">);</span>
<span class="linenos" data-linenos=" 7 "></span>              <span class="k">echo</span> <span class="s2">&quot;&lt;p&gt; </span><span class="si">$product-&gt;name</span><span class="s2"> - </span><span class="si">$amount</span><span class="s2"> &lt;/p&gt;&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos=" 8 "></span>
<span class="linenos" data-linenos=" 9 "></span>          <span class="p">}</span>    <span class="cp">?&gt;</span>
<span class="linenos" data-linenos="10 "></span><span class="x">              &lt;form id=&#39;vaciar&#39; action=&#39;deleteOrder.php&#39; method=&#39;post&#39;&gt;</span>
<span class="linenos" data-linenos="11 "></span><span class="x">                  &lt;input type=&#39;submit&#39; name=&#39;empty&#39; class=&#39;boton&#39; value=&#39;Buidar&#39;  /&gt;</span>
<span class="linenos" data-linenos="12 "></span><span class="x">              &lt;/form&gt;</span>
<span class="linenos" data-linenos="13 "></span><span class="x">              &lt;form id=&#39;comprar&#39; action=&#39;processOrder.php&#39; method=&#39;post&#39;&gt;</span>
<span class="linenos" data-linenos="14 "></span><span class="x">                  &lt;input type=&#39;submit&#39; name=&#39;buy&#39; class=&#39;boton&#39; value=&#39;Processar&#39;  /&gt;</span>
<span class="linenos" data-linenos="15 "></span><span class="x">              &lt;/form&gt;</span>
<span class="linenos" data-linenos="16 "></span><span class="cp">&lt;?php</span> <span class="p">}</span> <span class="cp">?&gt;</span>
</code></pre></div>
<p>public/deleteOrder.php</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="cp">&lt;?php</span>
<span class="linenos" data-linenos="2 "></span><span class="k">require</span> <span class="nb">dirname</span><span class="p">(</span><span class="no">__FILE__</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&quot;/../config/load.php&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos="3 "></span><span class="nx">checkSession</span><span class="p">();</span>
<span class="linenos" data-linenos="4 "></span><span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;empty&#39;</span><span class="p">]))</span>
<span class="linenos" data-linenos="5 "></span>    <span class="nb">unset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]);</span>
<span class="linenos" data-linenos="6 "></span><span class="nb">header</span><span class="p">(</span><span class="s2">&quot;Location: categories.php&quot;</span><span class="p">);</span>
</code></pre></div>
<p>public/processOrder.php</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="cp">&lt;?php</span>
<span class="linenos" data-linenos=" 2 "></span><span class="k">use</span> <span class="nx">App\mail</span><span class="p">;</span>
<span class="linenos" data-linenos=" 3 "></span><span class="k">require</span> <span class="s1">&#39;header.php&#39;</span><span class="p">;</span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span><span class="nv">$error</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="linenos" data-linenos=" 6 "></span><span class="nv">$idOrder</span> <span class="o">=</span> <span class="nx">addOrder</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">],</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
<span class="linenos" data-linenos=" 7 "></span><span class="k">if</span><span class="p">(</span><span class="nv">$idOrder</span> <span class="o">===</span> <span class="k">FALSE</span><span class="p">)</span> <span class="nv">$error</span> <span class="o">=</span> <span class="s2">&quot;No s&#39;ha pogut realitzar la comanda&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos=" 8 "></span><span class="k">else</span><span class="p">{</span>
<span class="linenos" data-linenos=" 9 "></span>
<span class="linenos" data-linenos="10 "></span>    <span class="nv">$mail</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">mail</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">],</span> <span class="nv">$idOrder</span><span class="p">,</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">mailAdress</span><span class="p">);</span>
<span class="linenos" data-linenos="11 "></span>    <span class="nv">$resul</span> <span class="o">=</span><span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">();</span>
<span class="linenos" data-linenos="12 "></span>    <span class="k">if</span><span class="p">(</span><span class="nv">$resul</span> <span class="o">!==</span><span class="k">TRUE</span><span class="p">)</span> <span class="nv">$error</span> <span class="o">=</span> <span class="s2">&quot;Error al enviar correu a &quot;</span><span class="o">.</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">mailAdress</span><span class="p">;</span>
<span class="linenos" data-linenos="13 "></span>    <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
<span class="linenos" data-linenos="14 "></span><span class="p">}</span>
<span class="linenos" data-linenos="15 "></span><span class="cp">?&gt;</span>
<span class="linenos" data-linenos="16 "></span><span class="x">&lt;div id=&quot;encabezado&quot;&gt;</span>
<span class="linenos" data-linenos="17 "></span><span class="x">    &lt;h1&gt;Processant Comanda </span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">id</span> <span class="cp">?&gt;</span><span class="x">&lt;/h1&gt;</span>
<span class="linenos" data-linenos="18 "></span><span class="x">    &lt;p&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$error</span><span class="p">)</span><span class="o">?</span><span class="s1">&#39;Comanda Processada amb èxit&#39;</span><span class="o">:</span><span class="nv">$error</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x">&lt;/p&gt;</span>
<span class="linenos" data-linenos="19 "></span><span class="x">&lt;/div&gt;</span>
<span class="linenos" data-linenos="20 "></span><span class="cp">&lt;?php</span> <span class="k">require</span> <span class="s1">&#39;footer.php&#39;</span><span class="p">;</span><span class="cp">?&gt;</span>
</code></pre></div>
<p>Ha arribat el moment de completar la web amb uns exericisis:
<a href="4.1.Activitat.html">Exercisi 4.1 Aplicació</a></p>
<p>Amb tot açó tendriem una primera versió de la web. Però tenim algunes deficiències importants:</p>
<ul>
<li>Hi ha codi html barrejat amb php. <strong>Solució : crear vistes.</strong></li>
<li>Les funcions sql per consultar a la base de dades comencen a ser importants. Si afeguirem un manteniment de tendes, la cosa aniria a mes. <strong>Solució: separar la capa de la base de dades</strong></li>
</ul>
<h3 id="plantilles-per-a-vistes">Plantilles per a vistes<a class="headerlink" href="#plantilles-per-a-vistes" title="Permanent link">&para;</a></h3>
<p>Per a solucionar el problema de les vistes, podem instal.lar algun aplicatiu que faça de motor de plantilles. Este ens permetrà separar el que és el codi html del php, agrupant parts comunes i permetent que criden a la plantilla com si de una funció es tractes des de qualsevol lloc del nostre codi php. Així mateix les plantilles podran, a banda de mostrar el html, executar xicotetes parts de codi per visualitzar els resultats calculats abans. Motor de plantilles tenim entre altes <strong>swing,smarty,blade</strong>.
Nosaltres anem a instal·lar el <a href="https://github.com/jenssegers/blade">blade</a>, que és el que gasta laravel.</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>composer require jenssegers/blade
</code></pre></div>
<p>Afegim al config load el necessari per tal que funcionen les vistes:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="x">use Jenssegers\Blade\Blade;</span>
<span class="linenos" data-linenos="2 "></span><span class="x">$blade = new Blade(&#39;../views&#39;,&#39;../cache&#39;);</span>
</code></pre></div>
<p>Creem els directoris <strong>views</strong>, on enmagatzenarem les vistes, i <strong>cache</strong>, cache per a les vistes creades.</p>
<p>Ara hem d'anar extraient el codi html dels nostres fitxers php i possant-lo en la carpeta views. 
Començarem pel login.php, que és una pàgina independent a la resta.
Dins de la carpeta views crearem un fitxer <strong>login.blade.php</strong> i posarem el codi html de l'anterior.</p>
<p><div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span>&lt;!DOCTYPE html&gt;
<span class="linenos" data-linenos=" 2 "></span>&lt;html&gt;
<span class="linenos" data-linenos=" 3 "></span>&lt;head&gt;
<span class="linenos" data-linenos=" 4 "></span>    &lt;title&gt;Formulario de login&lt;/title&gt;
<span class="linenos" data-linenos=" 5 "></span>    &lt;meta charset = &quot;UTF-8&quot;&gt;
<span class="linenos" data-linenos=" 6 "></span>    &lt;link href=&quot;/css/distribuidora.css&quot; rel=&quot;stylesheet&quot;&gt;
<span class="linenos" data-linenos=" 7 "></span>&lt;/head&gt;
<span class="linenos" data-linenos=" 8 "></span>&lt;body&gt;
<span class="linenos" data-linenos=" 9 "></span>&lt;div id=&#39;login&#39;&gt;
<span class="linenos" data-linenos="10 "></span>    &lt;form action = &quot;{ { htmlspecialchars($_SERVER[&quot;PHP_SELF&quot;]) }}&quot; method = &quot;POST&quot;&gt;
<span class="linenos" data-linenos="11 "></span>        &lt;fieldset&gt;
<span class="linenos" data-linenos="12 "></span>            &lt;legend&gt;Login&lt;/legend&gt;
<span class="linenos" data-linenos="13 "></span>            &lt;div&gt;
<span class="linenos" data-linenos="14 "></span>                &lt;span class=&#39;error&#39;&gt;{ { $error }}&lt;/span&gt;
<span class="linenos" data-linenos="15 "></span>            &lt;/div&gt;
<span class="linenos" data-linenos="16 "></span>            &lt;div class=&#39;campo&#39;&gt;
<span class="linenos" data-linenos="17 "></span>                &lt;label for = &quot;usuario&quot;&gt;Usuari&lt;/label&gt;
<span class="linenos" data-linenos="18 "></span>                &lt;input value = &quot;{ { $usuario }}&quot; id = &quot;usuario&quot; name = &quot;usuario&quot; type = &quot;text&quot; maxlength=&quot;50&quot; /&gt;
<span class="linenos" data-linenos="19 "></span>            &lt;/div&gt;
<span class="linenos" data-linenos="20 "></span>            &lt;div class=&#39;campo&#39;&gt;
<span class="linenos" data-linenos="21 "></span>                &lt;label for = &quot;clave&quot;&gt;Clau&lt;/label&gt;
<span class="linenos" data-linenos="22 "></span>                &lt;input id = &quot;clave&quot; name = &quot;clave&quot; type = &quot;password&quot;  maxlength=&quot;50&quot; /&gt;
<span class="linenos" data-linenos="23 "></span>            &lt;/div&gt;
<span class="linenos" data-linenos="24 "></span>            &lt;div class=&#39;campo&#39; style=&#39;text-align: center&#39;&gt;
<span class="linenos" data-linenos="25 "></span>                &lt;input type = &quot;submit&quot; class=&quot;boton&quot; name=&quot;enviar&quot; value=&quot;enviar&quot;&gt;
<span class="linenos" data-linenos="26 "></span>            &lt;/div&gt;
<span class="linenos" data-linenos="27 "></span>        &lt;/fieldset&gt;
<span class="linenos" data-linenos="28 "></span>    &lt;/form&gt;
<span class="linenos" data-linenos="29 "></span>&lt;/div&gt;
<span class="linenos" data-linenos="30 "></span>&lt;/body&gt;
<span class="linenos" data-linenos="31 "></span>&lt;/html&gt;
<span class="linenos" data-linenos="32 "></span>&lt;body&gt;
</code></pre></div>
Com podeu vore hem substituit els echo de php per la doble clau, que en blade té la mateixa funció </p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span> &lt;span class=&#39;error&#39;&gt;{ { $error }}&lt;/span&gt;
</code></pre></div>
<p>I ara anem a vore com queda el login.php</p>
<p><div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="cp">&lt;?php</span>
<span class="linenos" data-linenos=" 2 "></span><span class="k">require</span> <span class="nb">dirname</span><span class="p">(</span><span class="no">__FILE__</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&quot;/../config/load.php&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos=" 3 "></span>
<span class="linenos" data-linenos=" 4 "></span><span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s2">&quot;redirigido&quot;</span><span class="p">]))</span> <span class="nv">$error</span> <span class="o">=</span> <span class="s1">&#39;Haga login para continuar&#39;</span><span class="p">;</span>
<span class="linenos" data-linenos=" 5 "></span><span class="k">else</span> <span class="nv">$error</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="linenos" data-linenos=" 6 "></span><span class="nv">$usuario</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="linenos" data-linenos=" 7 "></span>
<span class="linenos" data-linenos=" 8 "></span><span class="k">if</span> <span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s2">&quot;REQUEST_METHOD&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">)</span> <span class="p">{</span>  
<span class="linenos" data-linenos=" 9 "></span>
<span class="linenos" data-linenos="10 "></span>    <span class="nv">$usu</span> <span class="o">=</span> <span class="nx">checkLogin</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;usuario&#39;</span><span class="p">],</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;clave&#39;</span><span class="p">]);</span>
<span class="linenos" data-linenos="11 "></span>
<span class="linenos" data-linenos="12 "></span>    <span class="k">if</span><span class="p">(</span><span class="nv">$usu</span><span class="o">===</span><span class="k">false</span><span class="p">){</span>
<span class="linenos" data-linenos="13 "></span>        <span class="nv">$error</span> <span class="o">=</span> <span class="s1">&#39;Revise usuario y contraseña&#39;</span><span class="p">;</span>
<span class="linenos" data-linenos="14 "></span>        <span class="nv">$usuario</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;usuario&#39;</span><span class="p">];</span>
<span class="linenos" data-linenos="15 "></span>    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="linenos" data-linenos="16 "></span>        <span class="nb">session_start</span><span class="p">();</span>
<span class="linenos" data-linenos="17 "></span>        <span class="c1">// $usu tiene campos correo y codRes, correo </span>
<span class="linenos" data-linenos="18 "></span>        <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$usu</span><span class="p">;</span>
<span class="linenos" data-linenos="19 "></span>        <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
<span class="linenos" data-linenos="20 "></span>        <span class="nb">header</span><span class="p">(</span><span class="s2">&quot;Location: categories.php&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos="21 "></span>        <span class="k">return</span><span class="p">;</span>
<span class="linenos" data-linenos="22 "></span>    <span class="p">}</span>   
<span class="linenos" data-linenos="23 "></span><span class="p">}</span>
<span class="linenos" data-linenos="24 "></span><span class="k">echo</span> <span class="nv">$blade</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">,</span><span class="nb">compact</span><span class="p">(</span><span class="s1">&#39;usuario&#39;</span><span class="p">,</span><span class="s1">&#39;error&#39;</span><span class="p">));</span>
</code></pre></div>
Com veieu queda igual però hi ha una cridada a la funció <strong>render</strong> de <strong>blade</strong> on pasem el nombre la vista(login) sense especificar l'extensió (ha d'estar en la carpeta views) i les variables que anem a utiltizar en la vista(usuario,error) i ho fem amb la funció de php compact que empaqueta en un array associatiu les variables entre cometes. Ara ha quedat separat el codi php del html completament i un dissenyador es podrà ocupar de la presentació sense por a tocar el codi de programació.</p>
<p>Hem de decidir que fem amb les dos línees que codi php al principi de la capçalera</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="cp">&lt;?php</span>
<span class="linenos" data-linenos="2 "></span><span class="k">require</span> <span class="nb">dirname</span><span class="p">(</span><span class="no">__FILE__</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&quot;/../config/load.php&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos="3 "></span><span class="nx">checkSession</span><span class="p">();</span>
<span class="linenos" data-linenos="4 "></span><span class="cp">?&gt;</span>
</code></pre></div>
<p>La primera l'haurem de possar als fitxers i la segona la podriem possar al load però ham de tenir en compte que a la pàgina de login no s'ha d'estar loguejat per accedir-hi i també carrega el load. Així el load podria quedar:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="x"> </span><span class="cp">&lt;?php</span>
<span class="linenos" data-linenos=" 2 "></span><span class="k">use</span> <span class="nx">Jenssegers\Blade\Blade</span><span class="p">;</span>
<span class="linenos" data-linenos=" 3 "></span><span class="k">require</span> <span class="nb">dirname</span><span class="p">(</span><span class="no">__FILE__</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&quot;/../vendor/autoload.php&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos=" 4 "></span><span class="nv">$whoops</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Whoops\Run</span><span class="p">;</span>
<span class="linenos" data-linenos=" 5 "></span><span class="nv">$whoops</span><span class="o">-&gt;</span><span class="na">pushHandler</span><span class="p">(</span><span class="k">new</span> <span class="nx">\Whoops\Handler\PrettyPageHandler</span><span class="p">);</span>
<span class="linenos" data-linenos=" 6 "></span><span class="nv">$whoops</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">();</span>
<span class="linenos" data-linenos=" 7 "></span><span class="nv">$blade</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blade</span><span class="p">(</span><span class="s1">&#39;../views&#39;</span><span class="p">,</span><span class="s1">&#39;../cache&#39;</span><span class="p">);</span>
<span class="linenos" data-linenos=" 8 "></span><span class="k">if</span> <span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;PHP_SELF&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;/login.php&#39;</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos" data-linenos=" 9 "></span>    <span class="nx">checkSession</span><span class="p">();</span>
<span class="linenos" data-linenos="10 "></span><span class="p">}</span>
</code></pre></div>
<p>Per a la resta de les pàgines crearem una plantilla amb les parts comunes a totes les pàgines como són la capçalera i el footer.Copiem el codi html de la capçalera i el peu a un fitxer que anomenaren <strong>main.blade.php</strong> i que ficarem dins d'una carpeta anomenada <strong>layout</strong> dins de <strong>views</strong>.Estos dos fitxers els podrem esborrar perquè ja no els utilitzarem.</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span>&lt;!DOCTYPE html&gt;
<span class="linenos" data-linenos=" 2 "></span>&lt;html&gt;
<span class="linenos" data-linenos=" 3 "></span>&lt;head&gt;
<span class="linenos" data-linenos=" 4 "></span>    &lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=UTF-8&quot;&gt;
<span class="linenos" data-linenos=" 5 "></span>    &lt;title&gt;Tarea 5: Listado de Productos con Plantillas&lt;/title&gt;
<span class="linenos" data-linenos=" 6 "></span>    &lt;link href=&quot;/css/distribuidora.css&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot;&gt;
<span class="linenos" data-linenos=" 7 "></span>&lt;/head&gt;
<span class="linenos" data-linenos=" 8 "></span>&lt;body class=&quot;pagproductos&quot;&gt;
<span class="linenos" data-linenos=" 9 "></span>    &lt;div id=&quot;contenedor&quot;&gt;
<span class="linenos" data-linenos="10 "></span>        &lt;div id=&quot;encabezado&quot;&gt;
<span class="linenos" data-linenos="11 "></span>            &lt;h1&gt;{ { $titleView }}&lt;/h1&gt;
<span class="linenos" data-linenos="12 "></span>        &lt;/div&gt;
<span class="linenos" data-linenos="13 "></span>        @yield(&#39;body&#39;)
<span class="linenos" data-linenos="14 "></span>        &lt;br class=&quot;divisor&quot; /&gt;
<span class="linenos" data-linenos="15 "></span>        &lt;div id=&quot;pie&quot;&gt;
<span class="linenos" data-linenos="16 "></span>            @if ($_SESSION[&#39;user&#39;]-&gt;id == &#39;1&#39;)
<span class="linenos" data-linenos="17 "></span>                &lt;form action=&#39;addProduct.php&#39; method=&#39;post&#39;&gt;
<span class="linenos" data-linenos="18 "></span>                    &lt;!-- Botón del mismo tipo que los demás --&gt;
<span class="linenos" data-linenos="19 "></span>                    &lt;input type=&#39;submit&#39; name=&#39;categories&#39; class=&#39;boton&#39; style=&#39;width:100%;&#39; value=&#39;Afegir Producte&#39;&gt;
<span class="linenos" data-linenos="20 "></span>                &lt;/form&gt;
<span class="linenos" data-linenos="21 "></span>            @endif
<span class="linenos" data-linenos="22 "></span>            &lt;form action=&#39;categories.php&#39; method=&#39;post&#39;&gt;
<span class="linenos" data-linenos="23 "></span>                &lt;!-- Botón del mismo tipo que los demás --&gt;
<span class="linenos" data-linenos="24 "></span>                &lt;input type=&#39;submit&#39; name=&#39;categories&#39; class=&#39;boton&#39; style=&#39;width:100%;&#39; value=&#39;Tornar Categories&#39;&gt;
<span class="linenos" data-linenos="25 "></span>            &lt;/form&gt;
<span class="linenos" data-linenos="26 "></span>            &lt;form action=&#39;logoff.php&#39; method=&#39;post&#39;&gt;
<span class="linenos" data-linenos="27 "></span>                &lt;!-- Botón del mismo tipo que los demás --&gt;
<span class="linenos" data-linenos="28 "></span>                &lt;input type=&#39;submit&#39; name=&#39;desconectar&#39; class=&#39;boton&#39; style=&#39;width:100%;&#39; value=&#39;Desconectar usuario { { $_SESSION[&#39;user&#39;]-&gt;mailAdress }}&#39;/&gt;
<span class="linenos" data-linenos="29 "></span>            &lt;/form&gt;
<span class="linenos" data-linenos="30 "></span>        &lt;/div&gt;
<span class="linenos" data-linenos="31 "></span>    &lt;/div&gt;
<span class="linenos" data-linenos="32 "></span>&lt;/body&gt;
<span class="linenos" data-linenos="33 "></span>&lt;/html&gt;
</code></pre></div>
<p>Com veieu per al title de la pàgina utilitzem una variable $titleView que haurem de passar en totes les cridades a la vista i utilitzem un <strong>yield</strong> de nom <strong>body</strong> que es com dir que allí possarem el codi que és propi de cada pàgina que implemente esta plantilla. Podem tindre tants <strong>yields</strong> com calguen.</p>
<p>Comencen per categories.php. Extraiem el codi html en <strong>view/categories.blade.php</strong></p>
<p><div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>@extends(&#39;layouts.main&#39;);
<span class="linenos" data-linenos="2 "></span>@section(&#39;body&#39;)
<span class="linenos" data-linenos="3 "></span>    &lt;div&gt;
<span class="linenos" data-linenos="4 "></span>        @foreach ($categorias as $cat)
<span class="linenos" data-linenos="5 "></span>            &lt;p&gt;&lt;a href=&#39;products.php?category={ {$cat-&gt;id}}&#39;&gt;{ {$cat-&gt;name}}&lt;/a&gt;&lt;/p&gt;
<span class="linenos" data-linenos="6 "></span>        @endforeach
<span class="linenos" data-linenos="7 "></span>    &lt;/div&gt;
<span class="linenos" data-linenos="8 "></span>@endsection
</code></pre></div>
Com veiu tenim una directiva <strong>@extends</strong> per a indicar que la vista és una extensió del layout main que ja hem instanciat.</p>
<p>I també tenim una directiva <strong>@section</strong> de nom <strong>body</strong> que ve s'incrustarà en el @yield del mateix nom del layout main.</p>
<p>També tenim una directiva <strong>@foreach</strong> que ve a ser el foreach de php però en format blade.</p>
<p>I hem de tenir clar que quan cridem a la vista li hauriem de passar la variable <strong>$categorias</strong>.</p>
<p>Així el fitxer categories.php quedaria</p>
<p><div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="cp">&lt;?php</span>
<span class="linenos" data-linenos="2 "></span>    <span class="k">use</span> <span class="nx">App\shoppingCart</span><span class="p">;</span>
<span class="linenos" data-linenos="3 "></span>    <span class="k">require</span> <span class="s1">&#39;../config/load.php&#39;</span><span class="p">;</span>
<span class="linenos" data-linenos="4 "></span>    <span class="nv">$categorias</span> <span class="o">=</span> <span class="nx">loadCategories</span><span class="p">();</span>
<span class="linenos" data-linenos="5 "></span>    <span class="nv">$titleView</span> <span class="o">=</span> <span class="s2">&quot;Llistat de categories&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos="6 "></span>    <span class="k">echo</span> <span class="nv">$blade</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;categories&#39;</span><span class="p">,</span><span class="nb">compact</span><span class="p">(</span><span class="s1">&#39;categorias&#39;</span><span class="p">,</span><span class="s1">&#39;titleView&#39;</span><span class="p">));</span>
</code></pre></div>
que únicament carrega les variables para la vista.</p>
<p>Un poc més complicat és el fitxer <strong>products.php</strong> que inclou <strong>order.php</strong>
Separem de nou el codi html per crear <strong>view/products.php</strong></p>
<p><div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span>@extends(&#39;layouts.main&#39;);
<span class="linenos" data-linenos=" 2 "></span>@section(&#39;body&#39;)
<span class="linenos" data-linenos=" 3 "></span>    &lt;div id=&quot;cesta&quot; style=&quot;text-align:center&quot;&gt;
<span class="linenos" data-linenos=" 4 "></span>        @include(&#39;order&#39;)
<span class="linenos" data-linenos=" 5 "></span>    &lt;/div&gt;
<span class="linenos" data-linenos=" 6 "></span>    &lt;div id=&quot;productos&quot;&gt;
<span class="linenos" data-linenos=" 7 "></span>        &lt;table class=&quot;table table-striped table-hover&quot;&gt;
<span class="linenos" data-linenos=" 8 "></span>            &lt;tr&gt;&lt;th&gt;Nombre&lt;/th&gt;&lt;th&gt;Descripción&lt;/th&gt;&lt;th&gt;Stock&lt;/th&gt;&lt;th&gt;Comprar&lt;/th&gt;&lt;/tr&gt;
<span class="linenos" data-linenos=" 9 "></span>            @foreach ($products as $product)
<span class="linenos" data-linenos="10 "></span>            &lt;tr&gt;
<span class="linenos" data-linenos="11 "></span>                &lt;td&gt;{ { $product-&gt;name }} &lt;/td&gt;
<span class="linenos" data-linenos="12 "></span>                &lt;td&gt;{ { $product-&gt;description }}&lt;/td&gt;
<span class="linenos" data-linenos="13 "></span>                &lt;td&gt;{ { $product-&gt;stock }}&lt;/td&gt;
<span class="linenos" data-linenos="14 "></span>                &lt;td&gt;
<span class="linenos" data-linenos="15 "></span>                    &lt;form method = &#39;POST&#39;&gt;
<span class="linenos" data-linenos="16 "></span>                        &lt;input type=&quot;hidden&quot; name=&quot;cod&quot; value=&quot;{ { $product-&gt;id }}&quot; /&gt;
<span class="linenos" data-linenos="17 "></span>                        &lt;input name = &#39;unidades&#39; type=&#39;number&#39; min = &#39;1&#39; value = &#39;1&#39; /&gt;
<span class="linenos" data-linenos="18 "></span>                        &lt;input type = &#39;submit&#39; name=&#39;comprar&#39; value=&#39;Comprar&#39;&gt;
<span class="linenos" data-linenos="19 "></span>                    &lt;/form&gt;
<span class="linenos" data-linenos="20 "></span>                &lt;/td&gt;
<span class="linenos" data-linenos="21 "></span>            &lt;/tr&gt;
<span class="linenos" data-linenos="22 "></span>            @endforeach
<span class="linenos" data-linenos="23 "></span>        &lt;/table&gt;
<span class="linenos" data-linenos="24 "></span>    &lt;/div&gt;
<span class="linenos" data-linenos="25 "></span>@endsection
</code></pre></div>
Tenim les mateixes directives que l'anterior i ademés la directiva <strong>@include('order')</strong> que ve a dir que ahí va una altra vista de nom order.blade.php que crearem del fitxer order.php</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="x">&lt;h3&gt;&lt;img src=&#39;img/cesta.png&#39; alt=&#39;Cesta&#39; width=&#39;24&#39; height=&#39;21&#39;&gt;Comanda&lt;/h3&gt;</span>
<span class="linenos" data-linenos=" 2 "></span><span class="x">&lt;hr /&gt;</span>
<span class="linenos" data-linenos=" 3 "></span><span class="x">@if (!empty($productosCar))</span>
<span class="linenos" data-linenos=" 4 "></span><span class="x">    @foreach ($productosCar as $productoCar)</span>
<span class="linenos" data-linenos=" 5 "></span><span class="x">        &lt;form  method = &#39;POST&#39;&gt;</span>
<span class="linenos" data-linenos=" 6 "></span><span class="x">            &lt;input type=&quot;text&quot; style=&quot;width: 5em&quot; disabled  value=&quot;{ {$productoCar-&gt;name}}&quot; /&gt;</span>
<span class="linenos" data-linenos=" 7 "></span><span class="x">            &lt;input name = &#39;cod&#39; type=&#39;hidden&#39;  value = &#39;{ {$productoCar-&gt;id}}&#39;&gt;</span>
<span class="linenos" data-linenos=" 8 "></span><span class="x">            &lt;input name = &#39;unidades&#39; type=&#39;number&#39; min = &#39;1&#39; value = &quot;{ { $_SESSION[&#39;order&#39;][$productoCar-&gt;id] }}&quot; style=&quot;width: 3em&quot;&gt;</span>
<span class="linenos" data-linenos=" 9 "></span><span class="x">            &lt;input type = &#39;submit&#39; style=&quot;width: 2em&quot; name=&#39;actualizar&#39; value=&#39;OK&#39;&gt;</span>
<span class="linenos" data-linenos="10 "></span><span class="x">            &lt;input type = &#39;submit&#39; style=&quot;width: 2em&quot;  name=&#39;eliminar&#39; value=&#39;X&#39;&gt;</span>
<span class="linenos" data-linenos="11 "></span><span class="x">        &lt;/form&gt;</span>
<span class="linenos" data-linenos="12 "></span><span class="x">    @endforeach</span>
<span class="linenos" data-linenos="13 "></span><span class="x">    &lt;form id=&#39;vaciar&#39; action=&#39;deleteOrder.php&#39; method=&#39;post&#39;&gt;</span>
<span class="linenos" data-linenos="14 "></span><span class="x">        &lt;input type=&#39;submit&#39; name=&#39;empty&#39; class=&#39;boton&#39; value=&#39;Buidar&#39;  /&gt;</span>
<span class="linenos" data-linenos="15 "></span><span class="x">    &lt;/form&gt;</span>
<span class="linenos" data-linenos="16 "></span><span class="x">    &lt;form id=&#39;comprar&#39; action=&#39;processOrder.php&#39; method=&#39;post&#39;&gt;</span>
<span class="linenos" data-linenos="17 "></span><span class="x">        &lt;input type=&#39;submit&#39; name=&#39;buy&#39; class=&#39;boton&#39; value=&#39;Processar&#39;  /&gt;</span>
<span class="linenos" data-linenos="18 "></span><span class="x">    &lt;/form&gt;</span>
<span class="linenos" data-linenos="19 "></span><span class="x">@else</span>
<span class="linenos" data-linenos="20 "></span><span class="x">    &lt;p&gt;Buida&lt;/p&gt;</span>
<span class="linenos" data-linenos="21 "></span><span class="x">@endif</span>
</code></pre></div>
<p>D'ací el que hem de tenir en compte és que el fitxer <strong>products.php</strong> haurà de carregar les variables que utilitzen les dos vistes, ja que en realitat és la mateixa.</p>
<p><div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="cp">&lt;?php</span>
<span class="linenos" data-linenos=" 2 "></span>    <span class="k">use</span> <span class="nx">App\shoppingCart</span><span class="p">;</span>
<span class="linenos" data-linenos=" 3 "></span>    <span class="k">require</span> <span class="s1">&#39;../config/load.php&#39;</span><span class="p">;</span>
<span class="linenos" data-linenos=" 4 "></span>    <span class="nv">$cat</span> <span class="o">=</span> <span class="nx">loadCategory</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]);</span>
<span class="linenos" data-linenos=" 5 "></span>    <span class="nv">$cart</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">shoppingCart</span><span class="p">();</span>
<span class="linenos" data-linenos=" 6 "></span>
<span class="linenos" data-linenos=" 7 "></span>    <span class="k">if</span> <span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s2">&quot;REQUEST_METHOD&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos" data-linenos=" 8 "></span>        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;comprar&#39;</span><span class="p">]))</span>
<span class="linenos" data-linenos=" 9 "></span>            <span class="nv">$cart</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;cod&#39;</span><span class="p">],(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;unidades&#39;</span><span class="p">]);</span>
<span class="linenos" data-linenos="10 "></span>        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;actualizar&#39;</span><span class="p">])){</span>
<span class="linenos" data-linenos="11 "></span>            <span class="nv">$cart</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;cod&#39;</span><span class="p">],(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;unidades&#39;</span><span class="p">]);</span>
<span class="linenos" data-linenos="12 "></span>        <span class="p">}</span>
<span class="linenos" data-linenos="13 "></span>        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;eliminar&#39;</span><span class="p">])){</span>
<span class="linenos" data-linenos="14 "></span>            <span class="nv">$cart</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;cod&#39;</span><span class="p">]);</span>
<span class="linenos" data-linenos="15 "></span>        <span class="p">}</span>
<span class="linenos" data-linenos="16 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos="17 "></span>
<span class="linenos" data-linenos="18 "></span>    <span class="nv">$titleView</span> <span class="o">=</span> <span class="s2">&quot;Productes categoria </span><span class="si">$cat-&gt;name</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos="19 "></span>    <span class="nv">$products</span> <span class="o">=</span> <span class="nx">loadProductsCategory</span><span class="p">(</span><span class="nv">$cat</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
<span class="linenos" data-linenos="20 "></span>    <span class="nv">$productosCar</span> <span class="o">=</span> <span class="nv">$cart</span><span class="o">-&gt;</span><span class="na">loadProducts</span><span class="p">();</span>
<span class="linenos" data-linenos="21 "></span>    <span class="k">echo</span> <span class="nv">$blade</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;products&#39;</span><span class="p">,</span><span class="nb">compact</span><span class="p">(</span><span class="s1">&#39;products&#39;</span><span class="p">,</span><span class="s1">&#39;titleView&#39;</span><span class="p">,</span><span class="s1">&#39;productosCar&#39;</span><span class="p">));</span>
</code></pre></div>
Ens que el tractament dels botons i la cridada a la vista.</p>
<p>Per fi ens queda processOrder.php que pràcticament no canvia.</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="x">@extends(&#39;layouts.main&#39;);</span>
<span class="linenos" data-linenos="2 "></span><span class="x">@section(&#39;body&#39;)</span>
<span class="linenos" data-linenos="3 "></span><span class="x">    &lt;div&gt;</span>
<span class="linenos" data-linenos="4 "></span><span class="x">        { { $message }}</span>
<span class="linenos" data-linenos="5 "></span><span class="x">    &lt;/div&gt;</span>
<span class="linenos" data-linenos="6 "></span><span class="x">@endsection</span>
</code></pre></div>
<p><div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="cp">&lt;?php</span>
<span class="linenos" data-linenos=" 2 "></span><span class="k">use</span> <span class="nx">App\mail</span><span class="p">;</span>
<span class="linenos" data-linenos=" 3 "></span><span class="k">use</span> <span class="nx">App\shoppingCart</span><span class="p">;</span>
<span class="linenos" data-linenos=" 4 "></span><span class="k">require</span> <span class="s1">&#39;../config/load.php&#39;</span><span class="p">;</span>
<span class="linenos" data-linenos=" 5 "></span>
<span class="linenos" data-linenos=" 6 "></span><span class="nv">$cart</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">shoppingCart</span><span class="p">();</span>
<span class="linenos" data-linenos=" 7 "></span><span class="nv">$resul</span> <span class="o">=</span> <span class="nv">$cart</span><span class="o">-&gt;</span><span class="na">processOrder</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
<span class="linenos" data-linenos=" 8 "></span>
<span class="linenos" data-linenos=" 9 "></span><span class="k">if</span><span class="p">(</span><span class="nv">$resul</span> <span class="o">===</span> <span class="k">true</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nv">$cart</span><span class="o">-&gt;</span><span class="na">isEmpty</span><span class="p">()){</span>
<span class="linenos" data-linenos="10 "></span>    <span class="nv">$correo</span> <span class="o">=</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">mailAdress</span><span class="p">;</span>
<span class="linenos" data-linenos="11 "></span>    <span class="nv">$message</span> <span class="o">=</span>  <span class="s2">&quot;Comanda realitzada amb èxit. Se enviarà un correu de confirmació a: </span><span class="si">$correo</span><span class="s2"> &quot;</span><span class="p">;</span>
<span class="linenos" data-linenos="12 "></span>    <span class="nv">$mail</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">mail</span><span class="p">(</span><span class="nv">$cart</span><span class="o">-&gt;</span><span class="na">getOrder</span><span class="p">(),</span> <span class="nv">$resul</span><span class="p">,</span> <span class="nv">$correo</span><span class="p">);</span>
<span class="linenos" data-linenos="13 "></span>    <span class="nv">$resul</span> <span class="o">=</span> <span class="nv">$mail</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">();</span>
<span class="linenos" data-linenos="14 "></span>    <span class="k">if</span><span class="p">(</span><span class="nv">$resul</span> <span class="o">!==</span> <span class="k">TRUE</span><span class="p">){</span>
<span class="linenos" data-linenos="15 "></span>        <span class="nv">$message</span> <span class="o">=</span>  <span class="s2">&quot;Error a l&#39;enviar: </span><span class="si">$resul</span><span class="s2"> &lt;br&gt;&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos="16 "></span>    <span class="p">};</span>
<span class="linenos" data-linenos="17 "></span>    <span class="nv">$cart</span><span class="o">-&gt;</span><span class="na">empty</span><span class="p">();</span>
<span class="linenos" data-linenos="18 "></span><span class="p">}</span> <span class="k">else</span> <span class="nv">$message</span> <span class="o">=</span> <span class="s2">&quot;No s&#39;ha pogut processar la comanda: &quot;</span><span class="o">.</span><span class="nv">$resul</span><span class="p">;</span>
<span class="linenos" data-linenos="19 "></span><span class="nv">$titleView</span> <span class="o">=</span> <span class="s2">&quot;Comanda processada&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos="20 "></span><span class="k">echo</span> <span class="nv">$blade</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;processOrder&#39;</span><span class="p">,</span><span class="nb">compact</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span><span class="s1">&#39;titleView&#39;</span><span class="p">));</span>
</code></pre></div>
Vos deixe el fitxer addProduct.php com a exercisi.</p>
<h3 id="model-de-dades">Model de dades<a class="headerlink" href="#model-de-dades" title="Permanent link">&para;</a></h3>
<p>L'objectiu és possar una capa de software entre l'usuari i la base de dades per així:</p>
<ul>
<li>Que l'usuari no ataque directament la base de dades.</li>
<li>Alliberar al programador de la tascat de generar consultes sql.</li>
<li>Fer el codi més llegible.</li>
<li>Comprovar les dades sense utilitzar la BBDD.</li>
</ul>
<p>Cada taula en la BBDD ha de tindre una classe en l'aplicació i allí és on guardarem el codi per interactuar. A l'igual que amb el motor de plantilles podem optar per motors de dades comercials. (P.E: Eloquent, Doctrine..).Però anem a construir un d'anar per casa. </p>
<p>El que volem és una entidad que aprofitan l'herència ens permeta programar el meyns possible en les classes depenents d'una taula de la BBDD. La classe abstracta  podria ser així:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="  1 "></span><span class="cp">&lt;?php</span>
<span class="linenos" data-linenos="  2 "></span>
<span class="linenos" data-linenos="  3 "></span><span class="k">namespace</span> <span class="nx">App</span><span class="p">;</span>
<span class="linenos" data-linenos="  4 "></span><span class="k">use</span> <span class="nx">\PDO</span><span class="p">;</span>
<span class="linenos" data-linenos="  5 "></span><span class="k">use</span> <span class="nx">App\bd</span><span class="p">;</span>
<span class="linenos" data-linenos="  6 "></span>
<span class="linenos" data-linenos="  7 "></span><span class="k">abstract</span> <span class="k">class</span> <span class="nc">EntidadBase</span>
<span class="linenos" data-linenos="  8 "></span><span class="p">{</span>
<span class="linenos" data-linenos="  9 "></span>
<span class="linenos" data-linenos=" 10 "></span>    <span class="k">protected</span> <span class="k">static</span> <span class="nv">$table</span><span class="p">;</span>
<span class="linenos" data-linenos=" 11 "></span>    <span class="k">protected</span> <span class="k">static</span> <span class="nv">$index</span><span class="p">;</span>
<span class="linenos" data-linenos=" 12 "></span>    <span class="k">protected</span> <span class="nv">$attributes</span> <span class="o">=</span> <span class="p">[];</span>
<span class="linenos" data-linenos=" 13 "></span>    <span class="k">protected</span> <span class="nv">$visible</span> <span class="o">=</span> <span class="p">[];</span>
<span class="linenos" data-linenos=" 14 "></span>
<span class="linenos" data-linenos=" 15 "></span>
<span class="linenos" data-linenos=" 16 "></span>    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$items</span><span class="o">=</span><span class="p">[])</span>
<span class="linenos" data-linenos=" 17 "></span>    <span class="p">{</span>
<span class="linenos" data-linenos=" 18 "></span>        <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$items</span><span class="p">))</span>
<span class="linenos" data-linenos=" 19 "></span>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">attributes</span> <span class="o">=</span> <span class="nb">array_intersect_key</span><span class="p">(</span><span class="nv">$items</span><span class="p">,</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">visible</span><span class="p">);</span>
<span class="linenos" data-linenos=" 20 "></span>        <span class="k">else</span>
<span class="linenos" data-linenos=" 21 "></span>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$items</span><span class="p">);</span>
<span class="linenos" data-linenos=" 22 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos=" 23 "></span>
<span class="linenos" data-linenos=" 24 "></span>    <span class="k">public</span> <span class="k">function</span> <span class="fm">__get</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span>
<span class="linenos" data-linenos=" 25 "></span>    <span class="p">{</span>
<span class="linenos" data-linenos=" 26 "></span>        <span class="k">if</span> <span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">attributes</span><span class="p">))</span> <span class="p">{</span>
<span class="linenos" data-linenos=" 27 "></span>            <span class="k">return</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">attributes</span><span class="p">[</span><span class="nv">$name</span><span class="p">]);</span>
<span class="linenos" data-linenos=" 28 "></span>        <span class="p">}</span>
<span class="linenos" data-linenos=" 29 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos=" 30 "></span>
<span class="linenos" data-linenos=" 31 "></span>    <span class="k">public</span> <span class="k">function</span> <span class="fm">__set</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span>
<span class="linenos" data-linenos=" 32 "></span>    <span class="p">{</span>
<span class="linenos" data-linenos=" 33 "></span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">attributes</span><span class="p">[</span><span class="nv">$name</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>
<span class="linenos" data-linenos=" 34 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos=" 35 "></span>
<span class="linenos" data-linenos=" 36 "></span>    <span class="k">public</span> <span class="k">function</span> <span class="fm">__isset</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span>
<span class="linenos" data-linenos=" 37 "></span>    <span class="p">{</span>
<span class="linenos" data-linenos=" 38 "></span>        <span class="k">return</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">attributes</span><span class="p">[</span><span class="nv">$name</span><span class="p">]);</span>
<span class="linenos" data-linenos=" 39 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos=" 40 "></span>
<span class="linenos" data-linenos=" 41 "></span>    <span class="k">public</span> <span class="k">function</span> <span class="nf">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span><span class="nv">$fetch_style</span><span class="o">=</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_ASSOC</span><span class="p">)</span>
<span class="linenos" data-linenos=" 42 "></span>    <span class="p">{</span>
<span class="linenos" data-linenos=" 43 "></span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">attributes</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">getbyId</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span><span class="nv">$fetch_style</span><span class="p">);</span>
<span class="linenos" data-linenos=" 44 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos=" 45 "></span>
<span class="linenos" data-linenos=" 46 "></span>    <span class="k">public</span> <span class="k">function</span> <span class="nf">delete</span><span class="p">()</span>
<span class="linenos" data-linenos=" 47 "></span>    <span class="p">{</span>
<span class="linenos" data-linenos=" 48 "></span>        <span class="nv">$id</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">attributes</span><span class="p">[</span><span class="k">static</span><span class="o">::</span><span class="nv">$index</span><span class="p">];</span>
<span class="linenos" data-linenos=" 49 "></span>        <span class="nx">self</span><span class="o">::</span><span class="na">deletebyId</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>
<span class="linenos" data-linenos=" 50 "></span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">attributes</span> <span class="o">=</span> <span class="p">[];</span>
<span class="linenos" data-linenos=" 51 "></span>
<span class="linenos" data-linenos=" 52 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos=" 53 "></span>
<span class="linenos" data-linenos=" 54 "></span>
<span class="linenos" data-linenos=" 55 "></span>    <span class="k">public</span> <span class="k">function</span> <span class="nf">save</span><span class="p">()</span>
<span class="linenos" data-linenos=" 56 "></span>    <span class="p">{</span>
<span class="linenos" data-linenos=" 57 "></span>        <span class="k">try</span> <span class="p">{</span>
<span class="linenos" data-linenos=" 58 "></span>            <span class="nv">$bd</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">bd</span><span class="p">();</span>
<span class="linenos" data-linenos=" 59 "></span>            <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">attributes</span><span class="p">[</span><span class="k">static</span><span class="o">::</span><span class="nv">$index</span><span class="p">]))</span>
<span class="linenos" data-linenos=" 60 "></span>                <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$bd</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">updateString</span><span class="p">());</span>
<span class="linenos" data-linenos=" 61 "></span>            <span class="k">else</span>
<span class="linenos" data-linenos=" 62 "></span>                <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$bd</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">insertString</span><span class="p">());</span>
<span class="linenos" data-linenos=" 63 "></span>            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">attributes</span><span class="p">))</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">\Exception</span><span class="p">(</span><span class="s1">&#39;Error:&#39;</span><span class="o">.</span><span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">errorInfo</span><span class="p">()[</span><span class="mi">2</span><span class="p">]);</span>
<span class="linenos" data-linenos=" 64 "></span>            <span class="k">echo</span> <span class="s1">&#39;Element Inserit/modificat&#39;</span><span class="p">;</span>
<span class="linenos" data-linenos=" 65 "></span>        <span class="p">}</span><span class="k">catch</span> <span class="p">(</span><span class="nx">PDOException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos" data-linenos=" 66 "></span>            <span class="k">echo</span> <span class="s1">&#39;Falló la consulta: &#39;</span> <span class="o">.</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">();</span>
<span class="linenos" data-linenos=" 67 "></span>        <span class="p">}</span><span class="k">catch</span> <span class="p">(</span><span class="nx">\Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos" data-linenos=" 68 "></span>            <span class="k">echo</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">();</span>
<span class="linenos" data-linenos=" 69 "></span>        <span class="p">}</span>
<span class="linenos" data-linenos=" 70 "></span>
<span class="linenos" data-linenos=" 71 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos=" 72 "></span>
<span class="linenos" data-linenos=" 73 "></span>    <span class="c1">// Funcions de consultes genèriques</span>
<span class="linenos" data-linenos=" 74 "></span>
<span class="linenos" data-linenos=" 75 "></span>    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">getAll</span><span class="p">()</span>
<span class="linenos" data-linenos=" 76 "></span>    <span class="p">{</span>
<span class="linenos" data-linenos=" 77 "></span>        <span class="nv">$bd</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">bd</span><span class="p">();</span>
<span class="linenos" data-linenos=" 78 "></span>        <span class="k">return</span> <span class="nv">$bd</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM &quot;</span><span class="o">.</span><span class="k">static</span><span class="o">::</span><span class="nv">$table</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">fetchAll</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_OBJ</span><span class="p">);</span>
<span class="linenos" data-linenos=" 79 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos=" 80 "></span>
<span class="linenos" data-linenos=" 81 "></span>    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">getbyId</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span><span class="nv">$fetch_style</span><span class="o">=</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_OBJ</span><span class="p">)</span>
<span class="linenos" data-linenos=" 82 "></span>    <span class="p">{</span>
<span class="linenos" data-linenos=" 83 "></span>        <span class="k">try</span> <span class="p">{</span>
<span class="linenos" data-linenos=" 84 "></span>            <span class="nv">$bd</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">bd</span><span class="p">();</span>
<span class="linenos" data-linenos=" 85 "></span>            <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$bd</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM &quot;</span><span class="o">.</span> <span class="k">static</span><span class="o">::</span><span class="nv">$table</span> <span class="o">.</span><span class="s2">&quot; WHERE &quot;</span><span class="o">.</span><span class="k">static</span><span class="o">::</span><span class="nv">$index</span><span class="o">.</span><span class="s2">&quot; = :id&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos=" 86 "></span>            <span class="k">if</span> <span class="p">(</span><span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">([</span><span class="s1">&#39;id&#39;</span><span class="o">=&gt;</span><span class="nv">$id</span><span class="p">]))</span> <span class="k">return</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">fetch</span><span class="p">(</span><span class="nv">$fetch_style</span><span class="p">);</span>
<span class="linenos" data-linenos=" 87 "></span>
<span class="linenos" data-linenos=" 88 "></span>            <span class="k">else</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">\Exception</span><span class="p">(</span><span class="s2">&quot;Element no trobat&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos=" 89 "></span>        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">PDOException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos" data-linenos=" 90 "></span>            <span class="k">echo</span> <span class="s1">&#39;Falló la consulta: &#39;</span> <span class="o">.</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">();</span>
<span class="linenos" data-linenos=" 91 "></span>        <span class="p">}</span><span class="k">catch</span> <span class="p">(</span><span class="nx">\Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos" data-linenos=" 92 "></span>            <span class="k">echo</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">();</span>
<span class="linenos" data-linenos=" 93 "></span>        <span class="p">}</span>
<span class="linenos" data-linenos=" 94 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos=" 95 "></span>
<span class="linenos" data-linenos=" 96 "></span>    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">getbyColum</span><span class="p">(</span><span class="nv">$columna</span><span class="p">,</span> <span class="nv">$valor</span><span class="p">)</span>
<span class="linenos" data-linenos=" 97 "></span>    <span class="p">{</span>
<span class="linenos" data-linenos=" 98 "></span>        <span class="nv">$bd</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">bd</span><span class="p">();</span>
<span class="linenos" data-linenos=" 99 "></span>        <span class="k">return</span> <span class="nv">$bd</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM &quot;</span><span class="o">.</span> <span class="k">static</span><span class="o">::</span><span class="nv">$table</span> <span class="o">.</span><span class="s2">&quot; WHERE </span><span class="si">$columna</span><span class="s2"> = &#39;</span><span class="si">$valor</span><span class="s2">&#39;&quot;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">fetchAll</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_OBJ</span><span class="p">);</span>
<span class="linenos" data-linenos="100 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos="101 "></span>
<span class="linenos" data-linenos="102 "></span>    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">deletebyId</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
<span class="linenos" data-linenos="103 "></span>    <span class="p">{</span>
<span class="linenos" data-linenos="104 "></span>        <span class="k">try</span> <span class="p">{</span>
<span class="linenos" data-linenos="105 "></span>            <span class="nv">$bd</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">bd</span><span class="p">();</span>
<span class="linenos" data-linenos="106 "></span>            <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$bd</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">&quot;DELETE FROM &quot;</span><span class="o">.</span><span class="k">static</span><span class="o">::</span><span class="nv">$table</span><span class="o">.</span><span class="s2">&quot; WHERE &quot;</span><span class="o">.</span><span class="k">static</span><span class="o">::</span><span class="nv">$index</span><span class="o">.</span> <span class="s2">&quot; = :id&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos="107 "></span>
<span class="linenos" data-linenos="108 "></span>            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">([</span><span class="s1">&#39;id&#39;</span><span class="o">=&gt;</span><span class="nv">$id</span><span class="p">]))</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">\Exception</span><span class="p">(</span><span class="s1">&#39;Error:&#39;</span><span class="o">.</span><span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">errorInfo</span><span class="p">()[</span><span class="mi">2</span><span class="p">]);</span>
<span class="linenos" data-linenos="109 "></span>            <span class="k">echo</span> <span class="s1">&#39;Element Esborrat&#39;</span><span class="p">;</span>
<span class="linenos" data-linenos="110 "></span>
<span class="linenos" data-linenos="111 "></span>        <span class="p">}</span><span class="k">catch</span> <span class="p">(</span><span class="nx">PDOException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos" data-linenos="112 "></span>            <span class="k">echo</span> <span class="s1">&#39;Falló la consulta: &#39;</span> <span class="o">.</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">();</span>
<span class="linenos" data-linenos="113 "></span>        <span class="p">}</span><span class="k">catch</span> <span class="p">(</span><span class="nx">\Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos" data-linenos="114 "></span>            <span class="k">echo</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">();</span>
<span class="linenos" data-linenos="115 "></span>        <span class="p">}</span>
<span class="linenos" data-linenos="116 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos="117 "></span>
<span class="linenos" data-linenos="118 "></span>    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">deleteAll</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
<span class="linenos" data-linenos="119 "></span>    <span class="p">{</span>
<span class="linenos" data-linenos="120 "></span>        <span class="nv">$bd</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">bd</span><span class="p">();</span>
<span class="linenos" data-linenos="121 "></span>        <span class="k">return</span> <span class="nv">$bd</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;DELETE FROM &quot;</span><span class="o">.</span><span class="k">static</span><span class="o">::</span><span class="nv">$table</span><span class="p">);</span>
<span class="linenos" data-linenos="122 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos="123 "></span>
<span class="linenos" data-linenos="124 "></span>    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">deleteByColum</span><span class="p">(</span><span class="nv">$columna</span><span class="p">,</span> <span class="nv">$valor</span><span class="p">)</span>
<span class="linenos" data-linenos="125 "></span>    <span class="p">{</span>
<span class="linenos" data-linenos="126 "></span>        <span class="nv">$bd</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">bd</span><span class="p">();</span>
<span class="linenos" data-linenos="127 "></span>        <span class="k">return</span> <span class="nv">$bd</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">&quot;DELETE FROM &quot;</span><span class="o">.</span><span class="k">static</span><span class="o">::</span><span class="nv">$table</span><span class="o">.</span><span class="s2">&quot; WHERE </span><span class="si">$columna</span><span class="s2"> = &#39;</span><span class="si">$valor</span><span class="s2">&#39;&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos="128 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos="129 "></span>
<span class="linenos" data-linenos="130 "></span>
<span class="linenos" data-linenos="131 "></span>
<span class="linenos" data-linenos="132 "></span>    <span class="k">private</span> <span class="k">function</span> <span class="nf">insertString</span><span class="p">()</span> <span class="o">:</span> <span class="nx">string</span>
<span class="linenos" data-linenos="133 "></span>    <span class="p">{</span>
<span class="linenos" data-linenos="134 "></span>        <span class="nv">$columns</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">,</span> <span class="nb">array_keys</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">attributes</span><span class="p">));</span>
<span class="linenos" data-linenos="135 "></span>
<span class="linenos" data-linenos="136 "></span>        <span class="nv">$values</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="nb">implode</span><span class="p">(</span><span class="s2">&quot;,:&quot;</span><span class="p">,</span> <span class="nb">array_keys</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">attributes</span><span class="p">));</span>
<span class="linenos" data-linenos="137 "></span>
<span class="linenos" data-linenos="138 "></span>        <span class="k">return</span> <span class="s2">&quot;INSERT INTO &quot;</span><span class="o">.</span><span class="k">static</span><span class="o">::</span><span class="nv">$table</span><span class="o">.</span><span class="s2">&quot;(</span><span class="si">$columns</span><span class="s2">) VALUES (</span><span class="si">$values</span><span class="s2">)&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos="139 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos="140 "></span>
<span class="linenos" data-linenos="141 "></span>    <span class="k">private</span> <span class="k">function</span> <span class="nf">updateString</span><span class="p">()</span> <span class="o">:</span> <span class="nx">string</span>
<span class="linenos" data-linenos="142 "></span>    <span class="p">{</span>
<span class="linenos" data-linenos="143 "></span>
<span class="linenos" data-linenos="144 "></span>        <span class="nv">$sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos="145 "></span>        <span class="k">foreach</span> <span class="p">(</span><span class="nb">array_keys</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">attributes</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$key</span> <span class="p">)</span>
<span class="linenos" data-linenos="146 "></span>            <span class="nv">$sql</span> <span class="o">.=</span> <span class="s2">&quot;</span><span class="si">$key</span><span class="s2"> = :</span><span class="si">$key</span><span class="s2">,&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos="147 "></span>
<span class="linenos" data-linenos="148 "></span>        <span class="k">return</span> <span class="s2">&quot;UPDATE &quot;</span><span class="o">.</span> <span class="k">static</span><span class="o">::</span><span class="nv">$table</span><span class="o">.</span><span class="s2">&quot; SET &quot;</span><span class="o">.</span><span class="nb">trim</span><span class="p">(</span><span class="nv">$sql</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot; WHERE &quot;</span><span class="o">.</span> <span class="k">static</span><span class="o">::</span><span class="nv">$index</span><span class="o">.</span> <span class="s2">&quot; = :&quot;</span><span class="o">.</span><span class="k">static</span><span class="o">::</span><span class="nv">$index</span><span class="p">;</span>
<span class="linenos" data-linenos="149 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos="150 "></span><span class="p">}</span>
</code></pre></div>
<p>On tenim unes funcions statiques per atacar directament a la BBDD i unes altres per a treballar amb un objecte que és un registre en la taula.</p>
<p>En les primeres tinc els mètodes: getAll(), getById(),
getByColumn(),deleteById(),deleteAll(),deleteByColumn() i totes les que vulguera fer.</p>
<p>En les segons, utilitze els mètodes màgics per a gestionar els atributs de la taula i els mètodes find(), delete(), save() per a interactuar amb la BBDD.</p>
<p>Una classe que hereta d'esta seria de la forma:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="cp">&lt;?php</span>
<span class="linenos" data-linenos=" 2 "></span><span class="k">namespace</span> <span class="nx">App</span><span class="p">;</span>
<span class="linenos" data-linenos=" 3 "></span>
<span class="linenos" data-linenos=" 4 "></span><span class="k">class</span> <span class="nc">Product</span> <span class="k">extends</span> <span class="nx">EntidadBase</span>
<span class="linenos" data-linenos=" 5 "></span><span class="p">{</span>
<span class="linenos" data-linenos=" 6 "></span>
<span class="linenos" data-linenos=" 7 "></span>    <span class="k">protected</span> <span class="nv">$visible</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos" data-linenos=" 8 "></span>            <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;number&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 9 "></span>            <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="10 "></span>            <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="11 "></span>            <span class="s1">&#39;stock&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;number&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="12 "></span>            <span class="s1">&#39;idCategory&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;number&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="13 "></span>            <span class="s1">&#39;price&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;number&#39;</span>
<span class="linenos" data-linenos="14 "></span>    <span class="p">];</span>
<span class="linenos" data-linenos="15 "></span>
<span class="linenos" data-linenos="16 "></span>    <span class="k">protected</span> <span class="k">static</span> <span class="nv">$table</span> <span class="o">=</span> <span class="s2">&quot;Products&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos="17 "></span>    <span class="k">protected</span> <span class="k">static</span> <span class="nv">$index</span> <span class="o">=</span>  <span class="s2">&quot;id&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos="18 "></span>
<span class="linenos" data-linenos="19 "></span><span class="p">}</span>
</code></pre></div>
<p>On bàsicament definisc els atributs per a identificar la taula(nom i camp index) i els camps de cada taula ( que podria aprofitar per a fer una validació)</p>
<p>Per a treballar amb esta classe tenim les següents opcions:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="x">$product = new Product() // Cree nou producte buid</span>
<span class="linenos" data-linenos=" 2 "></span><span class="x">$product = new Product(12) // Cree nou producte amb les dades del registre amb id 12</span>
<span class="linenos" data-linenos=" 3 "></span><span class="x">$product = new Product($_POST) // Cree nou producte amb les dades d&#39;un formulari (amb de coincidir noms de camps de la taula amb noms de camps del formulari)</span>
<span class="linenos" data-linenos=" 4 "></span><span class="x">$product-&gt;name = &#39;Pipas Gerfusa&#39; // Canvie el camps name del producte</span>
<span class="linenos" data-linenos=" 5 "></span><span class="x">$product-&gt;save() // Guarde producte en la BBDD, si existeix el modifica i si no el crea.</span>
<span class="linenos" data-linenos=" 6 "></span><span class="x">$product-&gt;delete()  //Esborra producte de la BBD</span>
<span class="linenos" data-linenos=" 7 "></span><span class="x">$product-&gt;find(12) // Busca el producte en la BBDD</span>
<span class="linenos" data-linenos=" 8 "></span>
<span class="linenos" data-linenos=" 9 "></span><span class="x">Product::getAll() // torna tots els registres de la BBDD</span>
<span class="linenos" data-linenos="10 "></span><span class="x">Product::getById(12)  //torna el registre 12 de la BBDD</span>
<span class="linenos" data-linenos="11 "></span><span class="x">Producte::getByColumn(&#39;name&#39;,&#39;Pipas Gerfusa&#39;)  //torna el registre de la BBDD </span>
<span class="linenos" data-linenos="12 "></span>
<span class="linenos" data-linenos="13 "></span><span class="x">Product::deleteAll() // esborra tots els registres de la BBDD</span>
<span class="linenos" data-linenos="14 "></span><span class="x">Product::deleteById(12)  // esborra el registre 12 de la BBDD</span>
<span class="linenos" data-linenos="15 "></span><span class="x">Producte::deleteByColumn(&#39;name&#39;,&#39;Pipas Gerfusa&#39;)  //esborra el registre de la BBDD </span>
</code></pre></div>
<p>Totes estes funcions estan definides en l'EntitadBase, i podem definir més si ens calen.</p>
<p>Per exemple en el fitxer addProduct.php tenim</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="cp">&lt;?php</span>
<span class="linenos" data-linenos=" 2 "></span><span class="k">use</span> <span class="nx">App\Product</span><span class="p">;</span>
<span class="linenos" data-linenos=" 3 "></span><span class="k">require</span> <span class="nb">dirname</span><span class="p">(</span><span class="no">__FILE__</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&quot;/../config/load.php&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos=" 4 "></span><span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Validar&#39;</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos" data-linenos=" 5 "></span>    <span class="nv">$product</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Product</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">);</span>
<span class="linenos" data-linenos=" 6 "></span>    <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>
<span class="linenos" data-linenos=" 7 "></span>    <span class="nb">header</span><span class="p">(</span><span class="s2">&quot;Location:listProducts.php&quot;</span><span class="p">);</span>
<span class="linenos" data-linenos=" 8 "></span><span class="p">}</span>
<span class="linenos" data-linenos=" 9 "></span><span class="k">else</span> <span class="p">{</span>
<span class="linenos" data-linenos="10 "></span>    <span class="nv">$product</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Product</span><span class="p">();</span>
<span class="linenos" data-linenos="11 "></span>    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])){</span>
<span class="linenos" data-linenos="12 "></span>        <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]);</span>
<span class="linenos" data-linenos="13 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos="14 "></span>    <span class="nv">$titleView</span> <span class="o">=</span> <span class="s2">&quot;Afegir producte&quot;</span><span class="p">;</span>
<span class="linenos" data-linenos="15 "></span>    <span class="k">echo</span> <span class="nv">$blade</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;addProduct&#39;</span><span class="p">,</span><span class="nb">compact</span><span class="p">(</span><span class="s1">&#39;titleView&#39;</span><span class="p">,</span><span class="s1">&#39;product&#39;</span><span class="p">));</span>
<span class="linenos" data-linenos="16 "></span><span class="p">}</span>
</code></pre></div>
<p>Al principi creem un producte que omplim si el que anem a fer és modificar i deixem buid si és un nou registre i es mostra la vista.
Quan tractem al formulari creem un nou producte a partir del formulari i el guardem a la base de dades per després redirigir a la lista de Productes.</p>
<p>Per a millorar l'aplicació amb els criteris del model MVC en faltaria definir quines són les rutes vàlides de l'aplicació i diriguir-les a una funció d'un controlador, que és el que s'encarregaria de tractar amb el model i les vistes. Però anem a deixer-ho ací i ho vorem quan vejan el framework.</p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      2024 Xavier Sastre - Licencia CC BY-NC-SA
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["header.autohide", "toc.integrate", "content.tabs.link", "navigation.expand"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copiat al porta-retalls", "clipboard.copy": "C\u00f2pia al porta-retalls", "search.result.more.one": "1 m\u00e9s en aquesta p\u00e0gina", "search.result.more.other": "# m\u00e9s en aquesta p\u00e0gina", "search.result.none": "Cap document coincideix", "search.result.one": "1 document coincident", "search.result.other": "# documents coincidents", "search.result.placeholder": "Escriu per a comen\u00e7ar a cercar", "search.result.term.missing": "Desaparegut", "select.version": "Selecciona la versi\u00f3"}}</script>
    
    
      <script src="../assets/javascripts/bundle.8fd75fb4.min.js"></script>
      
    
  </body>
</html>