
<!doctype html>
<html lang="ca" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://xsastre.github.io/8.1.Laravel_restfull.html">
      
      
      
      
      <link rel="icon" href="imagenes/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.9">
    
    
      
        <title>8.1.Laravel restfull - Docencia Xavier</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.f2e4d321.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Sans+Condensed:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"IBM Plex Sans Condensed";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="light-blue" data-md-color-accent="Teal">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#desenvolupament-de-serveis-rest" class="md-skip">
          Salta el contingut
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Capçalera">
    <a href="." title="Docencia Xavier" class="md-header__button md-logo" aria-label="Docencia Xavier" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Docencia Xavier
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              8.1.Laravel restfull
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="light-blue" data-md-color-accent="Teal"  aria-label="Cambiar a modo noche"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Cambiar a modo noche" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="light-blue" data-md-color-accent="Teal"  aria-label="Canviar a mode dia"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Canviar a mode dia" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Cerca" placeholder="Cerca" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Cerca">
        
        <button type="reset" class="md-search__icon md-icon" title="Neteja" aria-label="Neteja" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicialitzant cerca
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navegació" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="Docencia Xavier" class="md-nav__button md-logo" aria-label="Docencia Xavier" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Docencia Xavier
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Inici
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Inici
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Inici
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    DWEC
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            DWEC
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Moduls/DWEC/_DWEC2425.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Desenvolupament web en entorn client - DAW
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Moduls/DWEC/desenvolupamentfrontend.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Desenvolupamet frontend
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    AW
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            AW
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Moduls/AW/00.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Temporització aproximada
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Moduls/AW/01.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Aplicacions web
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Moduls/AW/02.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HTML
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>8.1.Laravel restfull</h1>

<h2 id="desenvolupament-de-serveis-rest">Desenvolupament de serveis REST<a class="headerlink" href="#desenvolupament-de-serveis-rest" title="Permanent link">&para;</a></h2>
<h3 id="introduccio-als-serveis-rest">Introducció als serveis REST<a class="headerlink" href="#introduccio-als-serveis-rest" title="Permanent link">&para;</a></h3>
<p><a href="https://youtu.be/ByJ804KuEas"><img alt="" src="../img/ull.png" />Video</a></p>
<p>A hores d'ara tots hauríem de tindre clar que qualsevol aplicació web es basa en una arquitectura client-servidor, on un servidor queda a l'espera de connexions de clients, i els clients es connecten als
servidors per a sol·licitar certs recursos. Sobre aquesta base, veurem unes breus pinzellades de com
funciona el protocol HTTP, i en què consisteixen els serveis <strong>REST</strong>.</p>
<h4 id="el-protocol-http">El protocol HTTP<a class="headerlink" href="#el-protocol-http" title="Permanent link">&para;</a></h4>
<p>Les comunicacions web entre client i servidor es realitzen mitjançant el protocol <strong>HTTP</strong> (o <strong>HTTPS</strong>, en el cas de comunicacions segures). En tots dos casos, client i servidor s'envien certa informació estàndard,
en cada missatge.</p>
<p>Quant als clients, envien al servidor les dades del recurs que sol·liciten, juntament amb certa informació
addicional, com per exemple les capçaleres de petició (informació relativa a la mena de client o navegador,
contingut que accepta, etc), i paràmetres addicionals anomenats normalment dades del formulari, ja que
 solen contindre la informació d'algun formulari que s'envia de client a servidor.</p>
<p>Pel que respecta als servidors, accepten aquestes peticions, les processen i envien de tornada algunes
dades rellevants, com un codi d'estat (indicant si la petició va poder ser atesa satisfactòriament
o no), capçaleres de resposta (indicant el tipus de contingut enviat, grandària, idioma, etc), i el recurs
sol·licitat pròpiament dit, si tot ha anat correctament.</p>
<p>Aquest és el mecanisme que hem estat utilitzant fins ara a través dels controladors: reben la
petició concreta del client, i envien una resposta, que de moment s'ha centrat en renderitzar un
contingut HTML d'una vista.</p>
<p>Quant als codis d'estat de la resposta, depén del resultat de l'operació que s'haja
realitzat, aquests es cataloguen en cinc grups:</p>
<ul>
<li>
<p>Codis <strong>1xx</strong>: representen informació sobre una petició normalment incompleta. No són molt
habituals, però es poden emprar quan la petició és molt llarga, i s'envia abans una capçalera
per a comprovar si es pot processar aquesta petició.</p>
</li>
<li>
<p>Codis <strong>2xx</strong>: representen peticions que s'han pogut atendre satisfactòriament. El codi més
habitual és el 200, resposta estàndard per a les peticions que són correctes. Existeixen altres variants, com el codi 201, que s'envia quan s'ha inserit o creat un nou recurs en el servidor (una
inserció en una base de dades, per exemple), o el codi 204, que indica que la petició s'ha atés
bé, però no s'ha retornat res com a resposta.</p>
</li>
<li>
<p>Codis <strong>3xx</strong>: són codis de redirecció, que indiquen que d'alguna manera la petició original s'ha
redirigit a un altre recurs del servidor. Per exemple, el codi 301 indica que el recurs sol·licitat s'ha
mogut permanentment a una altra URL. El codi 304 indica que el recurs sol·licitat no ha canviat
des de l'última vegada que es va sol·licitar, per si es vol recuperar de la caixet local en aqueix cas.</p>
</li>
<li>
<p>Codis <strong>4xx</strong>: indiquen un error per part del client. El més típic és l'error 404, que indica que estem
sol·licitant una URL o recurs que no existeix. Però també hi ha altres habituals, com el 401 (client
no autoritzat), o 400 (les dades de la petició no són correctes, per exemple, perquè els camps del
formulari no són vàlids).</p>
</li>
<li>
<p>Codis <strong>5xx</strong>: indiquen un error per part del servidor. Per exemple, l'error 500 indica un error intern del servidor, o el 504, que és un error de <strong>timeout</strong> per temps excessiu a emetre la resposta.</p>
</li>
</ul>
<p>Farem ús d'aquests codis d'estat en els nostres serveis <strong>REST</strong> per a informar el client de la mena d'error
que s'haja produït, o de l'estat en què s'ha pogut atendre la seua petició.</p>
<h4 id="els-serveis-rest">Els serveis REST<a class="headerlink" href="#els-serveis-rest" title="Permanent link">&para;</a></h4>
<p><strong>REST</strong> són les sigles de REpresentational State Transfer, i designa un estil d'arquitectura d'aplicacions distribuïdes basada en HTTP. En un sistema REST, identifiquem cada recurs a sol·licitar amb una <strong>URI</strong> (identificador uniforme de recurs), i definim un conjunt delimitat de comandos o mètodes a realitzar,que típicament són:</p>
<ul>
<li><strong>GET</strong>: per a obtindre resultats d'algun tipus (llistats complets o filtrats per alguna condició)
POST: per a realitzar insercions o afegir elements en un conjunt de dades</li>
<li>
<p><strong>PUT</strong>: per a realitzar modificacions o actualitzacions del conjunt de dades</p>
</li>
<li>
<p><strong>DELETE</strong>: per a realitzar esborrats del conjunt de dades</p>
</li>
</ul>
<p>Existeixen altres tipus de comandos o mètodes, com per exemple <strong>PATCH</strong> (similar a PUT, però per a canvis
parcials), <strong>HEAD</strong> (per a consultar només l'encapçalat de la resposta obtinguda), etc. Ens
centrarem de moment en els quatre mètodes principals anteriors.</p>
<p>Per tant, identificant el recurs a sol·licitar i el comando a aplicar-li, el servidor que ofereix aquesta <strong>API REST</strong> proporciona una resposta a aqueixa petició. Aquesta resposta típicament ve donada per un missatge en format <strong>JSON</strong> o XML (encara que aquest cada vegada està més en desús). Això permet que les aplicacions puguen estendre's a diferents plataformes, i accedir als mateixos serveis des d'una aplicació Angular, o una aplicació d'escriptori <strong>.NET</strong>, o una aplicació mòbil en Android, per posar diversos exemples.</p>
<p>ACLARIMENT: per als qui no conegueu la definició de <strong>API</strong> (Application Programming Interface),
bàsicament és el conjunt de mètodes o funcionalitats que es posen a la disposició dels qui els
vulguen utilitzar. En aquest cas, el concepte de <strong>API REST</strong> fa referència al conjunt de serveis REST
proporcionats pel servidor per als clients que vulguen utilitzar-los.</p>
<h4 id="nivells-arquitectura-rest"><a href="https://www.arquitecturajava.com/arquitecturas-rest-y-sus-niveles/">Nivells arquitectura REST</a><a class="headerlink" href="#nivells-arquitectura-rest" title="Permanent link">&para;</a></h4>
<h4 id="el-format-json">El format JSON<a class="headerlink" href="#el-format-json" title="Permanent link">&para;</a></h4>
<p><strong>JSON</strong> són les sigles de Javascript Object Notation, una sintaxi pròpia de Javascript per a poder representar objectes com a cadenes de text, i poder així serialitzar i enviar informació d'objectes a través de fluxos de dades
(arxius de text, comunicacions client-servidor, etc).
Un objecte Javascript es defineix mitjançant una sèrie de propietats i valors. Per exemple, les dades d'una
persona (com a nom i edat) podríem emmagatzemar-los així:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kd">let</span><span class="w"> </span><span class="nx">persona</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="linenos" data-linenos="2 "></span><span class="nx">nombre</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Nacho&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="3 "></span><span class="nx">edad</span><span class="o">:</span><span class="w"> </span><span class="mf">39</span>
<span class="linenos" data-linenos="4 "></span><span class="p">};</span>
</code></pre></div>
<p>Aquest mateix objecte, convertit a JSON, formaria una cadena de text amb aquest contingut:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">{</span><span class="nt">&quot;nombre&quot;</span><span class="p">:</span><span class="s2">&quot;Nacho&quot;</span><span class="p">,</span><span class="nt">&quot;edad&quot;</span><span class="p">:</span><span class="mi">39</span><span class="p">}</span>
</code></pre></div>
<p>De la mateixa manera, si tenim una col·lecció (vector) d'objectes com aquesta:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="kd">let</span><span class="w"> </span><span class="nx">personas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="linenos" data-linenos="2 "></span><span class="p">{</span><span class="w"> </span><span class="nx">nombre</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Nacho&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">edad</span><span class="o">:</span><span class="w"> </span><span class="mf">39</span><span class="p">},</span>
<span class="linenos" data-linenos="3 "></span><span class="p">{</span><span class="w"> </span><span class="nx">nombre</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Mario&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">edad</span><span class="o">:</span><span class="w"> </span><span class="mf">4</span><span class="p">},</span>
<span class="linenos" data-linenos="4 "></span><span class="p">{</span><span class="w"> </span><span class="nx">nombre</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Laura&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">edad</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">},</span>
<span class="linenos" data-linenos="5 "></span><span class="p">{</span><span class="w"> </span><span class="nx">nombre</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Nora&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">edad</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="p">}</span>
<span class="linenos" data-linenos="6 "></span><span class="p">];</span>
</code></pre></div>
<p>Transformada a JSON segueix la mateixa sintaxi, però entre claudàtors:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">[{</span><span class="nt">&quot;nombre&quot;</span><span class="p">:</span><span class="s2">&quot;Nacho&quot;</span><span class="p">,</span><span class="nt">&quot;edad&quot;</span><span class="p">:</span><span class="mi">39</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;nombre&quot;</span><span class="p">:</span><span class="s2">&quot;Mario&quot;</span><span class="p">,</span><span class="nt">&quot;edad&quot;</span><span class="p">:</span><span class="mi">4</span><span class="p">},</span>
<span class="linenos" data-linenos="2 "></span><span class="p">{</span><span class="nt">&quot;nombre&quot;</span><span class="p">:</span><span class="s2">&quot;Laura&quot;</span><span class="p">,</span><span class="nt">&quot;edad&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;nombre&quot;</span><span class="p">:</span><span class="s2">&quot;Nora&quot;</span><span class="p">,</span><span class="nt">&quot;edad&quot;</span><span class="p">:</span><span class="mi">10</span><span class="p">}]</span>
</code></pre></div>
<h3 id="construint-una-apirest-basica">Construïnt una API/REST bàsica<a class="headerlink" href="#construint-una-apirest-basica" title="Permanent link">&para;</a></h3>
<p><a href="https://youtu.be/1O8cvJKNhm8"><img alt="" src="../img/ull.png" />Video</a></p>
<p>Vegem ara quins passos donar per a construir una API REST en Laravel que done suport a les operacions
bàsiques sobre una o diverses entitats: consultes (GET), insercions (POST), modificacions (PUT) i esborrats (DELETE). Emprarem per a això els denominats controladors de API
i que proporcionen un conjunt de funcions ja definides per a donar suport a cadascun d'aquests
comandos.</p>
<h4 id="definint-els-controlador-de-la-api">Definint els controlador de la API<a class="headerlink" href="#definint-els-controlador-de-la-api" title="Permanent link">&para;</a></h4>
<p>Per a proporcionar una API REST als clients que ho requerisquen, necessitem definir un controlador (o
controladors) orientats a oferir aquests serveis REST. Aquests controladors en Laravel es denominen de tipus
<strong>api</strong>, com vam veure en sessions prèvies. Normalment es definirà un controlador API per cadascun dels
models als quals necessitem accedir. Crearem un de prova per a oferir una API REST sobre els
llibres de la nostra aplicació de videoclub.
Existeixen diferents maneres d'executar el comando de creació del controlador de API. Ací mostrarem
potser un dels més útils:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="x">php artisan make:controller Api/MovieController --api --model=Movie</span>
</code></pre></div>
<p>Això crearà el controlador en la carpeta <strong>App\Http\Controllers\Api</strong> amb una sèrie de funcions ja predefinides. No és obligatori situar-ho en aqueixa subcarpeta, òbviament, però això ens servirà per a separar els controladors de API de la resta. Aquesta serà l'aparença del controlador generat:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="cp">&lt;?php</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="k">namespace</span> <span class="nx">App\Http\Controllers\Api</span><span class="p">;</span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span><span class="k">use</span> <span class="nx">App\Http\Controllers\Controller</span><span class="p">;</span>
<span class="linenos" data-linenos=" 6 "></span><span class="k">use</span> <span class="nx">App\Models\Movie</span><span class="p">;</span>
<span class="linenos" data-linenos=" 7 "></span><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>
<span class="linenos" data-linenos=" 8 "></span>
<span class="linenos" data-linenos=" 9 "></span><span class="k">class</span> <span class="nc">MovieController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="linenos" data-linenos="10 "></span><span class="p">{</span>
<span class="linenos" data-linenos="11 "></span>    <span class="sd">/**</span>
<span class="linenos" data-linenos="12 "></span><span class="sd">     * Display a listing of the resource.</span>
<span class="linenos" data-linenos="13 "></span><span class="sd">     *</span>
<span class="linenos" data-linenos="14 "></span><span class="sd">     * @return \Illuminate\Http\Response</span>
<span class="linenos" data-linenos="15 "></span><span class="sd">     */</span>
<span class="linenos" data-linenos="16 "></span>    <span class="k">public</span> <span class="k">function</span> <span class="nf">index</span><span class="p">()</span>
<span class="linenos" data-linenos="17 "></span>    <span class="p">{</span>
<span class="linenos" data-linenos="18 "></span>        <span class="c1">//</span>
<span class="linenos" data-linenos="19 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos="20 "></span>
<span class="linenos" data-linenos="21 "></span>    <span class="sd">/**</span>
<span class="linenos" data-linenos="22 "></span><span class="sd">     * Store a newly created resource in storage.</span>
<span class="linenos" data-linenos="23 "></span><span class="sd">     *</span>
<span class="linenos" data-linenos="24 "></span><span class="sd">     * @param  \Illuminate\Http\Request  $request</span>
<span class="linenos" data-linenos="25 "></span><span class="sd">     * @return \Illuminate\Http\Response</span>
<span class="linenos" data-linenos="26 "></span><span class="sd">     */</span>
<span class="linenos" data-linenos="27 "></span>    <span class="k">public</span> <span class="k">function</span> <span class="nf">store</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
<span class="linenos" data-linenos="28 "></span>    <span class="p">{</span>
<span class="linenos" data-linenos="29 "></span>        <span class="c1">//</span>
<span class="linenos" data-linenos="30 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos="31 "></span>
<span class="linenos" data-linenos="32 "></span>    <span class="sd">/**</span>
<span class="linenos" data-linenos="33 "></span><span class="sd">     * Display the specified resource.</span>
<span class="linenos" data-linenos="34 "></span><span class="sd">     *</span>
<span class="linenos" data-linenos="35 "></span><span class="sd">     * @param  \App\Models\Movie  $movie</span>
<span class="linenos" data-linenos="36 "></span><span class="sd">     * @return \Illuminate\Http\Response</span>
<span class="linenos" data-linenos="37 "></span><span class="sd">     */</span>
<span class="linenos" data-linenos="38 "></span>    <span class="k">public</span> <span class="k">function</span> <span class="nf">show</span><span class="p">(</span><span class="nx">Movie</span> <span class="nv">$movie</span><span class="p">)</span>
<span class="linenos" data-linenos="39 "></span>    <span class="p">{</span>
<span class="linenos" data-linenos="40 "></span>        <span class="c1">//</span>
<span class="linenos" data-linenos="41 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos="42 "></span>
<span class="linenos" data-linenos="43 "></span>    <span class="sd">/**</span>
<span class="linenos" data-linenos="44 "></span><span class="sd">     * Update the specified resource in storage.</span>
<span class="linenos" data-linenos="45 "></span><span class="sd">     *</span>
<span class="linenos" data-linenos="46 "></span><span class="sd">     * @param  \Illuminate\Http\Request  $request</span>
<span class="linenos" data-linenos="47 "></span><span class="sd">     * @param  \App\Models\Movie  $movie</span>
<span class="linenos" data-linenos="48 "></span><span class="sd">     * @return \Illuminate\Http\Response</span>
<span class="linenos" data-linenos="49 "></span><span class="sd">     */</span>
<span class="linenos" data-linenos="50 "></span>    <span class="k">public</span> <span class="k">function</span> <span class="nf">update</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">Movie</span> <span class="nv">$movie</span><span class="p">)</span>
<span class="linenos" data-linenos="51 "></span>    <span class="p">{</span>
<span class="linenos" data-linenos="52 "></span>        <span class="c1">//</span>
<span class="linenos" data-linenos="53 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos="54 "></span>
<span class="linenos" data-linenos="55 "></span>    <span class="sd">/**</span>
<span class="linenos" data-linenos="56 "></span><span class="sd">     * Remove the specified resource from storage.</span>
<span class="linenos" data-linenos="57 "></span><span class="sd">     *</span>
<span class="linenos" data-linenos="58 "></span><span class="sd">     * @param  \App\Models\Movie  $movie</span>
<span class="linenos" data-linenos="59 "></span><span class="sd">     * @return \Illuminate\Http\Response</span>
<span class="linenos" data-linenos="60 "></span><span class="sd">     */</span>
<span class="linenos" data-linenos="61 "></span>    <span class="k">public</span> <span class="k">function</span> <span class="nf">destroy</span><span class="p">(</span><span class="nx">Movie</span> <span class="nv">$movie</span><span class="p">)</span>
<span class="linenos" data-linenos="62 "></span>    <span class="p">{</span>
<span class="linenos" data-linenos="63 "></span>        <span class="c1">//</span>
<span class="linenos" data-linenos="64 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos="65 "></span><span class="p">}</span>
</code></pre></div>
<p>Observem que s'incorpora automàticament la clàusula use per a carregar el model associat, que
hem indicat en el paràmetre <strong>--model</strong> . A més, els mètodes show , update i destroy ja vénen amb un paràmetre de tipus Llibre que facilitarà molt algunes tasques.</p>
<p>Cadascuna de les funcions del nou controlador creat s'associa a un dels mètodes REST comentats
anteriorment:</p>
<ul>
<li>
<p>index s'associaria amb una operació GET de llistat general, per a obtindre tots els registres (de videos, en aquest cas)</p>
</li>
<li>
<p>store s'associaria amb una operació POST, per a emmagatzemar les dades que arriben en la petició
(com un nou video, en el nostre cas)</p>
</li>
<li>
<p>show s'associaria amb una operació GET per a obtindre el registre associat a un identificador
concret</p>
</li>
<li>
<p>update s'associaria amb una operació PUT, per a actualitzar les dades del registre associat a un
identificador concret</p>
</li>
<li>
<p>destroy s'associaria amb una operació DELETE, per a eliminar les dades del registre associat a un
identificador concret</p>
</li>
</ul>
<h4 id="establint-les-rutes">Establint les rutes<a class="headerlink" href="#establint-les-rutes" title="Permanent link">&para;</a></h4>
<p>Una vegada tenim el controlador API creat, definirem les rutes associades a cada mètode del controlador. Si recordem de sessions anteriors, podíem emprar el mètode <strong>Route::resource</strong> en l'arxiu <strong>routes/web.php</strong> per a establir de colp totes les rutes associades a un controlador de recursos.</p>
<p>De manera anàloga, podem emprar el mètode <strong>Route::apiResource</strong> en l'arxiu
<strong>routes/api.php</strong> per a establir automàticament totes les rutes d'un controlador de API. Afegim
aquesta línia en aquest arxiu <strong>routes/api.php</strong> :</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>Route::apiResource(&#39;movies&#39;,Api\MovieController::class);
</code></pre></div>
<p>Les rutes de API (aquelles definides en l'arxiu <strong>routes/api.php</strong> ) per defecte tenen un prefix
api , tal com s'estableix en el provider <strong>RouteServiceProvider</strong> . Per tant, hem definit una
ruta general <strong>api/movies</strong> , de manera que totes les subrutes que es deriven d'ella portaran a l'un o l'altre mètode del controlador de API de video.
Podem comprovar quines rutes hi ha actives amb aquest comando:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span>php artisan route:list
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span>+--------+-----------+--------------------+----------------+--------------------------------------------------+------------+
<span class="linenos" data-linenos=" 4 "></span>| Domain | Method    | URI                | Name           | Action                                           | Middleware |
<span class="linenos" data-linenos=" 5 "></span>+--------+-----------+--------------------+----------------+--------------------------------------------------+------------+
<span class="linenos" data-linenos=" 6 "></span>|        | GET|HEAD  | /                  |                | App\Http\Controllers\HomeController              | web        |
<span class="linenos" data-linenos=" 7 "></span>|        | GET|HEAD  | api/movies         | movies.index   | App\Http\Controllers\Api\MovieController@index   | api        |
<span class="linenos" data-linenos=" 8 "></span>|        | POST      | api/movies         | movies.store   | App\Http\Controllers\Api\MovieController@store   | api        |
<span class="linenos" data-linenos=" 9 "></span>|        | GET|HEAD  | api/movies/{movie} | movies.show    | App\Http\Controllers\Api\MovieController@show    | api        |
<span class="linenos" data-linenos="10 "></span>|        | PUT|PATCH | api/movies/{movie} | movies.update  | App\Http\Controllers\Api\MovieController@update  | api        |
<span class="linenos" data-linenos="11 "></span>|        | DELETE    | api/movies/{movie} | movies.destroy | App\Http\Controllers\Api\MovieController@destroy | api        |
<span class="linenos" data-linenos="12 "></span>|        | GET|HEAD  | api/user           |                | Closure                                          +--------------------------------------------------+------------+
</code></pre></div>
<h4 id="serveis-get">Serveis GET<a class="headerlink" href="#serveis-get" title="Permanent link">&para;</a></h4>
<p>Començarem per definir el mètode index . En aquest cas, obtindrem el conjunt de videos de labase de dades i retornar-lo tal qual:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="x">public function index()</span>
<span class="linenos" data-linenos="2 "></span><span class="x">{</span>
<span class="linenos" data-linenos="3 "></span><span class="x">    $movies = Movie::get();</span>
<span class="linenos" data-linenos="4 "></span><span class="x">    return $movies;</span>
<span class="linenos" data-linenos="5 "></span><span class="x">}</span>
</code></pre></div>
<p>Si accedim a la ruta <strong>api/videos</strong> des del navegador, s'activarà el mètode index que acabem d'implementar, i rebrem els llibres de la base de dades, directament en format JSON.</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="p">{</span>
<span class="linenos" data-linenos=" 2 "></span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="linenos" data-linenos=" 3 "></span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;El padrino&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 4 "></span><span class="nt">&quot;year&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1972&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 5 "></span><span class="nt">&quot;director&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Francis Ford Coppola&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 6 "></span><span class="nt">&quot;poster&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;http://ia.media-imdb.com/images/M/MV5BMjEyMjcyNDI4MF5BMl5BanBnXkFtZTcwMDA5Mzg3OA@@._V1_SX214_AL_.jpg&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 7 "></span><span class="nt">&quot;rented&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="linenos" data-linenos=" 8 "></span><span class="nt">&quot;synopsis&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Don Vito Corleone (Marlon Brando) es el respetado y temido jefe de una de las cinco familias de la mafia de Nueva York. Tiene cuatro hijos: Connie (Talia Shire), el impulsivo Sonny (James Caan), el pusilánime Freddie (John Cazale) y Michael (Al Pacino), que no quiere saber nada de los negocios de su padre. Cuando Corleone, en contra de los consejos de &#39;Il consigliere&#39; Tom Hagen (Robert Duvall), se niega a intervenir en el negocio de las drogas, el jefe de otra banda ordena su asesinato. Empieza entonces una violenta y cruenta guerra entre las familias mafiosas.&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos=" 9 "></span><span class="nt">&quot;created_at&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2020-12-03T11:19:19.000000Z&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="10 "></span><span class="nt">&quot;updated_at&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2020-12-21T10:36:20.000000Z&quot;</span>
<span class="linenos" data-linenos="11 "></span><span class="p">},</span>
<span class="linenos" data-linenos="12 "></span><span class="p">{</span>
<span class="linenos" data-linenos="13 "></span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="linenos" data-linenos="14 "></span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;El Padrino. Parte II&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="15 "></span><span class="nt">&quot;year&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1974&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="16 "></span><span class="nt">&quot;director&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Francis Ford Coppola&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="17 "></span><span class="nt">&quot;poster&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;http://ia.media-imdb.com/images/M/MV5BNDc2NTM3MzU1Nl5BMl5BanBnXkFtZTcwMTA5Mzg3OA@@._V1_SX214_AL_.jpg&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="18 "></span><span class="nt">&quot;rented&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="linenos" data-linenos="19 "></span><span class="nt">&quot;synopsis&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Continuación de la historia de los Corleone por medio de dos historias paralelas: la elección de Michael Corleone como jefe de los negocios familiares y los orígenes del patriarca, el ya fallecido Don Vito, primero en Sicilia y luego en Estados Unidos, donde, empezando desde abajo, llegó a ser un poderosísimo jefe de la mafia de Nueva York.&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="20 "></span><span class="nt">&quot;created_at&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2020-12-03T11:19:19.000000Z&quot;</span><span class="p">,</span>
<span class="linenos" data-linenos="21 "></span><span class="nt">&quot;updated_at&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2020-12-03T11:19:19.000000Z&quot;</span>
<span class="linenos" data-linenos="22 "></span><span class="p">}}</span>
</code></pre></div>
<p>NOTA: podem instal·lar l'extensió <strong>JSON formatter</strong> per a Chrome, i així poder veure les dades en format JSON més organitzats i amb la sintaxi ressaltada.</p>
<p>D'una forma similar, podríem implementar i provar el mètode show</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="x">public function show(Movie $movie)</span>
<span class="linenos" data-linenos="2 "></span><span class="x">{</span>
<span class="linenos" data-linenos="3 "></span><span class="x">    return $movie;</span>
<span class="linenos" data-linenos="4 "></span><span class="x">}</span>
</code></pre></div>
<p>En aquest cas, si accedim a la URI <strong>api/movies/1</strong> , obtindrem la informació del video amb id = 1. Notar que Laravel s'encarrega automàticament de buscar el llibre per nosaltres (fer la corresponent operació <strong>find</strong> per a l'id proporcionat). És el que es coneix com a enllaç implícit, i és alguna cosa que
també està disponible en els controladors web normals, sempre que els associem correctament amb el model vinculat. Això es fa automàticament si creem el controlador juntament amb el model o si usem el paràmetre --model per a associar-ho, com hem fet ací.</p>
<h5 id="mes-coses-sobre-el-format-json-i-la-resposta">Mes coses sobre el format JSON i la resposta<a class="headerlink" href="#mes-coses-sobre-el-format-json-i-la-resposta" title="Permanent link">&para;</a></h5>
<p>Després de provar els dos serveis anteriors, hauràs observat que Laravel s'encarrega de transformar directament els registres obtinguts a format JSON quan els enviem mitjançant return , per la qual cosa, en principi, no tenim per què preocupar-nos d'aquest procés. No obstant això, d'aquesta manera s'escapen
algunes coses al nostre control. Per exemple, i sobretot, no podem especificar el codi d'estat de la resposta, que per defecte és 200 si tot ha anat correctament. A més, tampoc podem controlar quina informació enviar de l'objecte en qüestió.</p>
<p>Si volem limitar o formatar la informació a enviar dels objectes que estem tractant, i que no s'envien tots els seus camps sense més, tenim diverses opcions:</p>
<ul>
<li>Afegir clàusules <strong>hidden</strong> en els models corresponents, per a indicar que aqueixa informació no ha de ser enviada en cap cas enlloc de l'aplicació. És el que ocorre, per exemple, amb el camp password del model d'Usuari :</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="x">protected $hidden = [&#39;password&#39;];</span>
</code></pre></div>
<ul>
<li>Definir a mà un array amb els camps a enviar en el mètode del controlador. En el cas de la fitxa del video anterior, si només volem enviar el títol i el director, podríem fer una cosa així:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="x">public function show(Movie $movie)</span>
<span class="linenos" data-linenos="2 "></span><span class="x">{</span>
<span class="linenos" data-linenos="3 "></span><span class="x">    return [</span>
<span class="linenos" data-linenos="4 "></span><span class="x">        &#39;titulo&#39; =&gt; $movie-&gt;title,</span>
<span class="linenos" data-linenos="5 "></span><span class="x">        &#39;director&#39; =&gt; $movie-&gt;director</span>
<span class="linenos" data-linenos="6 "></span><span class="x">    ];</span>
<span class="linenos" data-linenos="7 "></span><span class="x">}</span>
</code></pre></div>
<ul>
<li>En el cas que el pas anterior siga molt costós (perquè el model té molts camps, o perquè hem de fer el mateix en diverses parts del codi), també podem definir recursos (resources), que permeten separar el codi de la informació a mostrar del propi controlador. <a href="https://laravel.com/docs/8.x/eloquent-resources">Ací</a> podeu trobar informació sobre aquest tema.</li>
</ul>
<p>D'altra banda, si volem afegir o modificar més informació en la resposta, com el codi d'estat, l'estructura anterior no ens serveix, ja que sempre s'enviarà un codi 200. Per a això, és convenient emprar el mètode <strong>response()-&gt;json(...)</strong> , que permet especificar com a primer paràmetre les dades a enviar, i com segon paràmetre el codi d'estat. Els mètode anterior quedaria així,
enviant un codi 200 com a resposta (encara que si s'omet el segon paràmetre, s'assumeix que és 200):</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="x">public function show(Movie $movie)</span>
<span class="linenos" data-linenos="2 "></span><span class="x">{</span>
<span class="linenos" data-linenos="3 "></span><span class="x">    return response()-&gt;json($movie, 200);</span>
<span class="linenos" data-linenos="4 "></span><span class="x">}</span>
</code></pre></div>
<h4 id="resta-dels-serveis">Resta dels serveis<a class="headerlink" href="#resta-dels-serveis" title="Permanent link">&para;</a></h4>
<p><a href="https://youtu.be/pieNTwMManY"><img alt="" src="../img/ull.png" />Video</a></p>
<p>Vegem ara com implementar la resta de serveis (POST, PUT i DELETE). En el cas de la inserció (POST), haurem de rebre en la petició les dades de l'objecte a inserir (un llibre, en el nostre exemple). Igual que les dades del servidor al client s'envien en format JSON, és d'esperar en aplicacions que segueixen l'arquitectura REST que les dades del client al servidor també s'envien en format JSON.
El nostre mètode <strong>store</strong> , associat al servei POST, podria quedar d'aquesta manera (retornem el codi d'estat 201, que s'utilitza quan s'han inserit elements nous):</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="x">public function store(MoviePost $request)</span>
<span class="linenos" data-linenos=" 2 "></span><span class="x">{</span>
<span class="linenos" data-linenos=" 3 "></span><span class="x">        $movie = new Movie();</span>
<span class="linenos" data-linenos=" 4 "></span><span class="x">        $movie-&gt;title = $request-&gt;title;</span>
<span class="linenos" data-linenos=" 5 "></span><span class="x">        $movie-&gt;year = $request-&gt;year;</span>
<span class="linenos" data-linenos=" 6 "></span><span class="x">        $movie-&gt;director = $request-&gt;director;</span>
<span class="linenos" data-linenos=" 7 "></span><span class="x">        $movie-&gt;poster = $request-&gt;poster;</span>
<span class="linenos" data-linenos=" 8 "></span><span class="x">        $movie-&gt;synopsis = $request-&gt;synopsis;</span>
<span class="linenos" data-linenos=" 9 "></span><span class="x">        $movie-&gt;save();</span>
<span class="linenos" data-linenos="10 "></span><span class="x">        return response()-&gt;json($movie, 201);</span>
<span class="linenos" data-linenos="11 "></span><span class="x">}</span>
</code></pre></div>
<p>De forma semblant tindriem el mètode <strong>update</strong> per al servei PUT. En est cas tornem un codi 200.</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="x"> public function update(MoviePost $request, Movie $movie)</span>
<span class="linenos" data-linenos=" 2 "></span><span class="x">    {</span>
<span class="linenos" data-linenos=" 3 "></span><span class="x">        $movie-&gt;title = $request-&gt;title;</span>
<span class="linenos" data-linenos=" 4 "></span><span class="x">        $movie-&gt;year = $request-&gt;year;</span>
<span class="linenos" data-linenos=" 5 "></span><span class="x">        $movie-&gt;director = $request-&gt;director;</span>
<span class="linenos" data-linenos=" 6 "></span><span class="x">        $movie-&gt;poster = $request-&gt;poster;</span>
<span class="linenos" data-linenos=" 7 "></span><span class="x">        $movie-&gt;synopsis = $request-&gt;synopsis;</span>
<span class="linenos" data-linenos=" 8 "></span><span class="x">        $movie-&gt;save();</span>
<span class="linenos" data-linenos=" 9 "></span><span class="x">        return response()-&gt;json($movie);</span>
<span class="linenos" data-linenos="10 "></span><span class="x">    }</span>
</code></pre></div>
<p>Finalment, pel servei DELETE, hem d'implementar el mètode <strong>destroy</strong> , que podria quedar així:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="x">public function destroy(Movie $movie)</span>
<span class="linenos" data-linenos="2 "></span><span class="x">{</span>
<span class="linenos" data-linenos="3 "></span><span class="x">    $movie-&gt;delete();</span>
<span class="linenos" data-linenos="4 "></span><span class="x">    return response()-&gt;json(null, 204);</span>
<span class="linenos" data-linenos="5 "></span><span class="x">}</span>
</code></pre></div>
<p>Notar que retornem un codi d'estat 204, que indica que no estem retornant contingut (és null). D'altra banda, és habitual en aquesta mena d'operacions d'esborrat retornar en format JSON l'objecte que s'ha eliminat, per si de cas es vol desfer l'operació en un pas posterior. En aquest cas, la resposta del mètode d'esborrat seria així:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="x">return response()-&gt;json($movie,204);</span>
</code></pre></div>
<p>Com podem començar a intuir, provar aquests serveis no és tan senzill com provar serveis de tipus GET, ja que no podem simplement teclejar una URL en el navegador. Necessitem un mecanisme per a passar-li les dades al servidor en format JSON, i també el mètode (POST, PUT o DELETE).</p>
<h5 id="validacio-de-dades">Validació de dades<a class="headerlink" href="#validacio-de-dades" title="Permanent link">&para;</a></h5>
<p>A l'hora de rebre dades en format JSON per a serveis REST, també podem establir mecanismes de validació similars als vistos per als formularis, a través dels corresponents <strong>requests</strong>, com ja hem fet en els exemples anteriors.</p>
<h5 id="respostes-derror">Respostes d'error<a class="headerlink" href="#respostes-derror" title="Permanent link">&para;</a></h5>
<p>D'altra banda, hem d'assegurar-nos que qualsevol error que es produïsca en la part del API retorne un contingut en format JSON, i no una pàgina web. Per exemple, si sol·licitem veure la fitxa d'un llibre que el seu id no existeix, no hauria de retornar-nos una pàgina d'error 404, sinó un codi d'estat 404 amb un missatge d'error en format JSON.</p>
<p>Això no es compleix per defecte, ja que Laravel està configurat per a renderitzar una vista amb l'error produït. En el cas de Laravel 8 hem de modificar el mètode <strong>register</strong> dins de la classe <strong>App\Exceptions\Handler.php</strong>. Ho podem deixar de la següent forma:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="x">public function register()</span>
<span class="linenos" data-linenos=" 2 "></span><span class="x">{</span>
<span class="linenos" data-linenos=" 3 "></span><span class="x">    $this-&gt;renderable(function (Throwable $exception) {</span>
<span class="linenos" data-linenos=" 4 "></span><span class="x">    if (request()-&gt;is(&#39;api&#39;))</span>
<span class="linenos" data-linenos=" 5 "></span><span class="x">        {</span>
<span class="linenos" data-linenos=" 6 "></span><span class="x">            if ($exception instanceof ModelNotFoundException)</span>
<span class="linenos" data-linenos=" 7 "></span><span class="x">                return response()-&gt;json([&#39;error&#39; =&gt; &#39;Recurso no encontrado&#39;],404);</span>
<span class="linenos" data-linenos=" 8 "></span><span class="x">            else if ($exception instanceof ValidationException)</span>
<span class="linenos" data-linenos=" 9 "></span><span class="x">                return response()-&gt;json([&#39;error&#39; =&gt; &#39;Datos no válidos&#39;],400);</span>
<span class="linenos" data-linenos="10 "></span><span class="x">            else if (isset($exception))</span>
<span class="linenos" data-linenos="11 "></span><span class="x">                return response()-&gt;json([&#39;error&#39; =&gt; &#39;Error: &#39; .$exception-&gt;getMessage()], 500);</span>
<span class="linenos" data-linenos="12 "></span><span class="x">        }</span>
<span class="linenos" data-linenos="13 "></span><span class="x">    });</span>
<span class="linenos" data-linenos="14 "></span><span class="x">}</span>
</code></pre></div>
<h3 id="provant-els-serveis-amb-postman">Provant els serveis amb POSTMAN<a class="headerlink" href="#provant-els-serveis-amb-postman" title="Permanent link">&para;</a></h3>
<p>Ja hem vist que provar uns serveis de llistat (GET) és senzill a través d'un navegador. Però els serveis d'inserció (POST), modificació (PUT) o esborrat (DELETE) exigeixen d'altres eines per a poder ser provats. Podríem definir formularis amb aquests mètodes encapsulats, però l'esforç de definir
aqueixos formularis per a després no utilitzar-los més no mereix molt la pena. Veurem a continuació una eina molt útil per a provar tot tipus de serveis sense necessitat d'implementar gens addicional.</p>
<p><strong>Postman</strong> és una aplicació gratuïta i multiplataforma que permet enviar tot tipus de peticions a un servidor determinat, i examinar la resposta que aquest produeix. D'aquesta forma, podem comprovar que els serveis ofereixen la informació adequada abans de ser usats per una aplicació client real.</p>
<p>La primera vegada que l'executem ens preguntarà si volem registrar-nos, de manera que puguem compartir els projectes que fem entre els diferents equips en què estiguem registrats, però podem saltar aquest pas fent clic en l'enllaç inferior.</p>
<p>Després d'iniciar l'aplicació, veurem la pantalla d'inici de Postman. Al principi apareixeran diverses opcions en la zona central, per a crear col·leccions o peticions, encara que també les podem crear des del
botó <strong>New</strong> a la cantonada superior esquerra. Per exemple, podem crear una col·lecció "Movies", i apareixerà en el panell esquerre:</p>
<p>Des del mateix botó*New a la cantonada superior esquerra podem crear noves peticions i associar-les a una col·lecció. Existeix una forma alternativa (potser més còmoda) de crear aqueixes peticions, a través del panell
de pestanyes, afegint noves:</p>
<h4 id="afegir-peticions-get">Afegir peticions GET<a class="headerlink" href="#afegir-peticions-get" title="Permanent link">&para;</a></h4>
<p>Per a afegir una petició, habitualment triarem el tipus de comando sota les pestanyes (GET, POST, PUT, DELETE) i la URL associada a aquest comando. Per exemple:</p>
<p><img alt="" src="../img/postman_1.png" /></p>
<p>Llavors, podem fer clic en el botó "Save" en la part dreta, i guardar la petició per a poder-la reutilitzar. En guardar-la, ens demanarà que li assignem un nom (per exemple, "GET movies" en aquest cas), i la
col·lecció en la qual s'emmagatzemarà (la nostra col·lecció de "Movies").</p>
<p><img alt="" src="../img/postman_2.png" /></p>
<p>Després, podrem veure la prova associada a la col·lecció, en el panell esquerre, i si seleccionem aquesta prova i premem en el botó blau de "*Send" (part dreta), podem veure la resposta emesa pel servidor en el panell inferior de resposta (si tenim, és clar, el servidor en marxa)</p>
<p><img alt="" src="../img/postman_3.png" /></p>
<p>Seguint aquests mateixos passos, podem també crear una nova petició per a obtindre un llibre a partir del seu id, per GET:</p>
<p><img alt="" src="../img/postman_4.png" /></p>
<p>Bastaria amb reemplaçar l'id de la URL pel qual vulguem consultar realment. Si provem aquesta petició, obtindrem la resposta corresponent:</p>
<p><img alt="" src="../img/postman_5.png" /></p>
<h4 id="afegir-altres-tipus-de-peticions">Afegir altres tipus de peticions<a class="headerlink" href="#afegir-altres-tipus-de-peticions" title="Permanent link">&para;</a></h4>
<p>Les peticions POST difereixen de les peticions GET en què s'envia certa informació en el cos de la petició. Aquesta informació normalment són les dades que es volen afegir en el servidor. Com podem fer això amb Postman?
En primer lloc, creem una nova petició, triem el comando POST i definim la URL (en el nostre cas, videoclub.my/api/movies o una cosa similar, depenent de com tinguem en marxa el servidor).
Llavors, fem clic en la pestanya Body, sota la URL, i establim el tipus com <strong>raw</strong> perquè ens deixe escriure'l sense restriccions. També convé canviar la propietat <strong>Text</strong> perquè siga JSON, i que així el servidor reculla el tipus de dada adequada. S'afegirà automàticament una capçalera de petició (<strong>Header</strong>)
que especificarà que el tipus de contingut que s'enviarà són dades JSON. Després, en el quadre de text sota aquestes opcions, especifiquem l'objecte JSON que volem enviar per a inserir:</p>
<p><img alt="" src="../img/postman_6.png" /></p>
<p>Després d'això, n'hi ha prou amb guardar la petició com hem fet amb les anteriors, i llançar-la per a veure el resultat.</p>
<p>Quant a les peticions PUT, procedirem de manera similar a les peticions POST: hem de triar el comando (PUT en aquest cas), la URL, i completar el cos de la petició amb les dades que vulguem modificar del contacte. En aquest cas, a més, l'id del llibre l'enviarem també en la pròpia URL:</p>
<p><img alt="" src="../img/postman_7.png" /></p>
<p>Per a peticions DELETE, la mecànica és similar a la fitxa de l'element (operació GET), canviant el comando GET per DELETE, i sense necessitat d'establir res en el cos de la petició:</p>
<p><img alt="" src="../img/postman_8.png" /></p>
<h2 id="autenticacio-en-serveis-rest">Autenticació en serveis REST<a class="headerlink" href="#autenticacio-en-serveis-rest" title="Permanent link">&para;</a></h2>
<p><a href="https://youtu.be/DyTbHfQHp0I"><img alt="" src="../img/ull.png" />Video</a></p>
<p>En una API REST també pot ser necessari protegir certs serveis, de manera que només puguen accedir a ells els usuaris autenticats. No obstant això, en aquest cas no tenim disponible el mecanisme d'autenticació basat en sessions que vam veure en temes anteriors, ja que la parteix client que consula la API
REST no té per què estar basada en un navegador. Podríem accedir des d'una aplicació d'escriptori feta a Java, per exemple, o des d'una aplicació mòbil, i en aquests casos no podríem disposar de les sessions, pròpies de clients web o navegadors. En el seu lloc, emprarem un mecanisme d'autenticació basat en tokens.</p>
<h4 id="fonaments-de-lautenticacio-basada-en-tokens">Fonaments de l'autenticació basada en tokens<a class="headerlink" href="#fonaments-de-lautenticacio-basada-en-tokens" title="Permanent link">&para;</a></h4>
<p>L'autenticació basada en tokens és un mecanisme de validació d'usuaris en aplicacions client/servidor que podríem dir que és més universal que l'autenticació basada en sessions, ja que permet autenticar usuaris provinents de diferents tipus de clients. El que es fa és el següent:</p>
<ul>
<li>L'usuari necessita enviar les seues credencials (login i password), de manera similar a com es fa en una aplicació web normal, encara que aquesta vegada les dades s'envien normalment en format JSON.</li>
<li>El servidor valida aqueixes credencials i, si són correctes, genera una cadena de text anomenada <strong>token</strong>, d'una certa longitud, i que servirà per a identificar unívocament a l'usuari a partir d'aqueix moment. Dit token ha de ser enviat de tornada (també en format JSON) al client que es va validar.</li>
<li>A partir d'aquest punt, el client ha d'adjuntar el token com a part de la informació en cada petició que realitza a una zona d'accés restringit, de manera que el servidor puga consultar el token i comprovar si correspon amb el d'algun usuari autoritzat. Aquest token normalment s'envia en una capçalera de la petició anomenada <strong>Authorization</strong>, com veurem després, i el servidor pot consultar el valor d'aquesta capçalera per a verificar l'accés del client.</li>
</ul>
<h4 id="alternatives-per-a-la-implementacio-de-lautenticacio-basada-en-tokens">Alternatives per a la implementació de l'autenticació basada en tokens<a class="headerlink" href="#alternatives-per-a-la-implementacio-de-lautenticacio-basada-en-tokens" title="Permanent link">&para;</a></h4>
<p>Podem emprar diferents alternatives per a l'autenticació basada en tokens baix Laravel. Comentarem dues d'elles.</p>
<ul>
<li>
<p>D'una banda, podem emprar el mecanisme natiu de Laravel per a autenticació basada en tokens.Com a avantatges principals, no es necessita instal·lar cap dependència addicional, i és relativament senzill d'utilitzar. Com a inconvenients, requereix afegir un camp més a la taula d'usuaris, per a emmagatzemar el token generat per a cada usuari, i requereix també d'una gestió manual del token, encara que és senzilla.</p>
</li>
<li>
<p>D'altra banda podem valdre'ns de la llibreria <strong>Laravel Sanctum</strong>, que proporciona mecanismes d'autenticació per a APIs i per a SPAs (Single Page Applications, aplicacions de pàgina única). Entre els seus avantatges podem destacar que és senzilla d'integrar en l'aplicació i automatitza alguns aspectes
de la gestió de tokens, a més de comptar amb el suport oficial de Laravel. Com a inconvenients, és una llibreria més intrusiva que l'anterior, ja que requereix crear una taula addicional on emmagatzemar els tokens.</p>
</li>
</ul>
<p>En els següents apartats veurem com protegir mitjançant tokens un projecte senzill en Laravel emprant cadascun d'aquests mecanismes.</p>
<h4 id="preparant-lentorn">Preparant l'entorn<a class="headerlink" href="#preparant-lentorn" title="Permanent link">&para;</a></h4>
<p>Hem d'editar l'arxiu <strong>App\Exceptions\Hanlder.php</strong> , en concret el seu mètode register per a definir els diferents errors que poden produir-se i els missatges que cal retornar en cada cas:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="cp">&lt;?php</span>
<span class="linenos" data-linenos=" 2 "></span>
<span class="linenos" data-linenos=" 3 "></span><span class="k">namespace</span> <span class="nx">App\Exceptions</span><span class="p">;</span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span><span class="k">use</span> <span class="nx">Illuminate\Database\QueryException</span><span class="p">;</span>
<span class="linenos" data-linenos=" 6 "></span><span class="k">use</span> <span class="nx">Illuminate\Foundation\Exceptions\Handler</span> <span class="k">as</span> <span class="nx">ExceptionHandler</span><span class="p">;</span>
<span class="linenos" data-linenos=" 7 "></span><span class="k">use</span> <span class="nx">Throwable</span><span class="p">;</span>
<span class="linenos" data-linenos=" 8 "></span><span class="k">use</span> <span class="nx">Illuminate\Validation\ValidationException</span><span class="p">;</span>
<span class="linenos" data-linenos=" 9 "></span><span class="k">use</span> <span class="nx">Illuminate\Auth\AuthenticationException</span><span class="p">;</span>
<span class="linenos" data-linenos="10 "></span><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\ModelNotFoundException</span><span class="p">;</span>
<span class="linenos" data-linenos="11 "></span>
<span class="linenos" data-linenos="12 "></span><span class="k">class</span> <span class="nc">Handler</span> <span class="k">extends</span> <span class="nx">ExceptionHandler</span>
<span class="linenos" data-linenos="13 "></span><span class="p">{</span>
<span class="linenos" data-linenos="14 "></span>    <span class="sd">/**</span>
<span class="linenos" data-linenos="15 "></span><span class="sd">     * A list of the exception types that are not reported.</span>
<span class="linenos" data-linenos="16 "></span><span class="sd">     *</span>
<span class="linenos" data-linenos="17 "></span><span class="sd">     * @var array</span>
<span class="linenos" data-linenos="18 "></span><span class="sd">     */</span>
<span class="linenos" data-linenos="19 "></span>    <span class="k">protected</span> <span class="nv">$dontReport</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos" data-linenos="20 "></span>        <span class="c1">//</span>
<span class="linenos" data-linenos="21 "></span>    <span class="p">];</span>
<span class="linenos" data-linenos="22 "></span>
<span class="linenos" data-linenos="23 "></span>    <span class="sd">/**</span>
<span class="linenos" data-linenos="24 "></span><span class="sd">     * A list of the inputs that are never flashed for validation exceptions.</span>
<span class="linenos" data-linenos="25 "></span><span class="sd">     *</span>
<span class="linenos" data-linenos="26 "></span><span class="sd">     * @var array</span>
<span class="linenos" data-linenos="27 "></span><span class="sd">     */</span>
<span class="linenos" data-linenos="28 "></span>    <span class="k">protected</span> <span class="nv">$dontFlash</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos" data-linenos="29 "></span>        <span class="s1">&#39;password&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="30 "></span>        <span class="s1">&#39;password_confirmation&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="31 "></span>    <span class="p">];</span>
<span class="linenos" data-linenos="32 "></span>
<span class="linenos" data-linenos="33 "></span>    <span class="sd">/**</span>
<span class="linenos" data-linenos="34 "></span><span class="sd">     * Register the exception handling callbacks for the application.</span>
<span class="linenos" data-linenos="35 "></span><span class="sd">     *</span>
<span class="linenos" data-linenos="36 "></span><span class="sd">     * @return void</span>
<span class="linenos" data-linenos="37 "></span><span class="sd">     */</span>
<span class="linenos" data-linenos="38 "></span>    <span class="k">public</span> <span class="k">function</span> <span class="nf">register</span><span class="p">()</span>
<span class="linenos" data-linenos="39 "></span>    <span class="p">{</span>
<span class="linenos" data-linenos="40 "></span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">renderable</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">Throwable</span> <span class="nv">$exception</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos" data-linenos="41 "></span>
<span class="linenos" data-linenos="42 "></span>            <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">is</span><span class="p">(</span><span class="s1">&#39;api*&#39;</span><span class="p">))</span>
<span class="linenos" data-linenos="43 "></span>            <span class="p">{</span>
<span class="linenos" data-linenos="44 "></span>                <span class="k">if</span> <span class="p">(</span><span class="nv">$exception</span> <span class="nx">instanceof</span> <span class="nx">ModelNotFoundException</span><span class="p">)</span>
<span class="linenos" data-linenos="45 "></span>                    <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span><span class="s1">&#39;error&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Elemento no encontrado&#39;</span><span class="p">],</span> <span class="mi">404</span><span class="p">);</span>
<span class="linenos" data-linenos="46 "></span>                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$exception</span> <span class="nx">instanceof</span> <span class="nx">AuthenticationException</span><span class="p">)</span>
<span class="linenos" data-linenos="47 "></span>                    <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span><span class="s1">&#39;error&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Usuario no autenticado&#39;</span><span class="p">],</span> <span class="mi">401</span><span class="p">);</span>
<span class="linenos" data-linenos="48 "></span>                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$exception</span> <span class="nx">instanceof</span> <span class="nx">ValidationException</span><span class="p">)</span>
<span class="linenos" data-linenos="49 "></span>                    <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span><span class="s1">&#39;error&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Datos no válidos&#39;</span><span class="p">],</span> <span class="mi">400</span><span class="p">);</span>
<span class="linenos" data-linenos="50 "></span>                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$exception</span> <span class="nx">instanceof</span> <span class="nx">QueryException</span><span class="p">)</span>
<span class="linenos" data-linenos="51 "></span>                    <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span><span class="s1">&#39;error&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Datos no válidos&#39;</span><span class="p">],</span> <span class="mi">400</span><span class="p">);</span>
<span class="linenos" data-linenos="52 "></span>                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$exception</span><span class="p">))</span>
<span class="linenos" data-linenos="53 "></span>                    <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span><span class="s1">&#39;error&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Error en la aplicación (&#39;</span> <span class="o">.</span><span class="nb">get_class</span><span class="p">(</span><span class="nv">$exception</span><span class="p">)</span> <span class="o">.</span> <span class="s1">&#39;):&#39;</span> <span class="o">.</span><span class="nv">$exception</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">()],</span> <span class="mi">500</span><span class="p">);</span>
<span class="linenos" data-linenos="54 "></span>            <span class="p">}</span>
<span class="linenos" data-linenos="55 "></span>        <span class="p">});</span>
<span class="linenos" data-linenos="56 "></span>    <span class="p">}</span>
<span class="linenos" data-linenos="57 "></span><span class="p">}</span>
</code></pre></div>
<h4 id="autenticacio-amb-token-nativa">Autenticació amb token nativa<a class="headerlink" href="#autenticacio-amb-token-nativa" title="Permanent link">&para;</a></h4>
<h5 id="configuracio-basica">Configuració bàsica<a class="headerlink" href="#configuracio-basica" title="Permanent link">&para;</a></h5>
<p>En primer lloc, modifiquem la migració de la taula d'users per a afegir un nou camp on emmagatzemar el token. Aquest camp n'hi ha prou que tinga 60 caràcters de longitud, i serà necessari també que siga únic per a cada usuari:</p>
<p><div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span>public function up()
<span class="linenos" data-linenos=" 2 "></span>    {
<span class="linenos" data-linenos=" 3 "></span>        Schema::create(&#39;users&#39;, function (Blueprint $table) {
<span class="linenos" data-linenos=" 4 "></span>            $table-&gt;id();
<span class="linenos" data-linenos=" 5 "></span>            $table-&gt;string(&#39;name&#39;);
<span class="linenos" data-linenos=" 6 "></span>            $table-&gt;string(&#39;email&#39;)-&gt;unique();
<span class="linenos" data-linenos=" 7 "></span>            $table-&gt;timestamp(&#39;email_verified_at&#39;)-&gt;nullable();
<span class="linenos" data-linenos=" 8 "></span>            $table-&gt;string(&#39;api_token&#39;, 60)-&gt;unique()-&gt;nullable();
<span class="linenos" data-linenos=" 9 "></span>            $table-&gt;string(&#39;password&#39;);
<span class="linenos" data-linenos="10 "></span>            $table-&gt;rememberToken();
<span class="linenos" data-linenos="11 "></span>            $table-&gt;timestamps();
<span class="linenos" data-linenos="12 "></span>        });
<span class="linenos" data-linenos="13 "></span>    }
</code></pre></div>
Llancem la migració i hem de comprovar que el artxiu <strong>config/auth.php</strong> faça referència al model d'usuaris, si utilitzarem un model diferent a User ho canviariem en:</p>
<p><div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="x">&#39;providers&#39; =&gt; [</span>
<span class="linenos" data-linenos="2 "></span><span class="x">&#39;users&#39; =&gt; [</span>
<span class="linenos" data-linenos="3 "></span><span class="x">&#39;driver&#39; =&gt; &#39;eloquent&#39;,</span>
<span class="linenos" data-linenos="4 "></span><span class="x">&#39;model&#39; =&gt; App\Models\Usuario::class,</span>
<span class="linenos" data-linenos="5 "></span><span class="x">],</span>
</code></pre></div>
No és el cas.</p>
<h5 id="proteccio-de-rutes">Protecció de rutes<a class="headerlink" href="#proteccio-de-rutes" title="Permanent link">&para;</a></h5>
<p>Per a protegir les rutes d'accés restringit, primer crearem un controlador que s'encarregue de validar les credencials de l'usuari:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>php artisan make:controller Api/LoginController
</code></pre></div>
<p>Definim un mètode login , per exemple, que validarà les credencials que li arriben (login i password). Si són correctes, generarà una cadena de text aleatòria de 60 caràcters i l'emmagatzemarà en el camp <strong>api_token</strong> de l'usuari validat. També retornarà dit token com a resposta en format JSON. En cas que hi haja un error en l'autenticació, enviarà de tornada un missatge d'error, amb el
codi 401 d'accés no autoritzat.</p>
<p><div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="x">use App\Http\Controllers\Controller;</span>
<span class="linenos" data-linenos=" 2 "></span><span class="x">use Illuminate\Http\Request;</span>
<span class="linenos" data-linenos=" 3 "></span><span class="x">use Illuminate\Support\Str;</span>
<span class="linenos" data-linenos=" 4 "></span><span class="x">use Illuminate\Support\Facades\Hash;</span>
<span class="linenos" data-linenos=" 5 "></span><span class="x">use App\Models\User;</span>
<span class="linenos" data-linenos=" 6 "></span>
<span class="linenos" data-linenos=" 7 "></span><span class="x">class LoginController extends Controller</span>
<span class="linenos" data-linenos=" 8 "></span><span class="x">{</span>
<span class="linenos" data-linenos=" 9 "></span><span class="x">    public function login(Request $request)</span>
<span class="linenos" data-linenos="10 "></span><span class="x">    {</span>
<span class="linenos" data-linenos="11 "></span><span class="x">        $usuario = User::where(&#39;email&#39;, $request-&gt;login)-&gt;first();</span>
<span class="linenos" data-linenos="12 "></span><span class="x">        if (!$usuario || !Hash::check($request-&gt;password, $usuario-&gt;password))</span>
<span class="linenos" data-linenos="13 "></span><span class="x">        {</span>
<span class="linenos" data-linenos="14 "></span><span class="x">            return response()-&gt;json([&#39;error&#39; =&gt; &#39;Credenciales no válidas&#39;], 401);</span>
<span class="linenos" data-linenos="15 "></span><span class="x">        }</span>
<span class="linenos" data-linenos="16 "></span><span class="x">        else</span>
<span class="linenos" data-linenos="17 "></span><span class="x">        {</span>
<span class="linenos" data-linenos="18 "></span><span class="x">            $usuario-&gt;api_token = Str::random(60);</span>
<span class="linenos" data-linenos="19 "></span><span class="x">            $usuario-&gt;save();</span>
<span class="linenos" data-linenos="20 "></span><span class="x">            return response()-&gt;json([&#39;token&#39; =&gt; $usuario-&gt;api_token]);</span>
<span class="linenos" data-linenos="21 "></span><span class="x">        }</span>
<span class="linenos" data-linenos="22 "></span><span class="x">    }</span>
<span class="linenos" data-linenos="23 "></span><span class="x">}</span>
</code></pre></div>
Definim en l'arxiu <em>+routes/api.php</em>* una ruta que redirigisca a aquest mètode, per a quan l'usuari vulga autenticar-se (recorda afegir amb use la corresponent classe):  </p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>Route::post(&#39;login&#39;, [LoginController::class, &#39;login&#39;]);
</code></pre></div>
<p>També podem eliminar en aquest cas la ruta predefinida d'aquest arxiu, que empra l'autenticació nativa de Laravel:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>// Eliminar esta ruta:
<span class="linenos" data-linenos="2 "></span>Route::middleware(&#39;auth:api&#39;)-&gt;get(&#39;/user&#39;, function (Request $request) {
<span class="linenos" data-linenos="3 "></span>return $request-&gt;user();
<span class="linenos" data-linenos="4 "></span>});
</code></pre></div>
<p>Per a protegir les rutes que necessitem en els controladors API, les especifiquem en el constructor del controlador. Per exemple, així protegiríem totes les rutes del nostre controlador MovieController , excepte index i show :</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>class MovieController extends Controller
<span class="linenos" data-linenos="2 "></span>{
<span class="linenos" data-linenos="3 "></span>public function __construct()
<span class="linenos" data-linenos="4 "></span>{
<span class="linenos" data-linenos="5 "></span>    $this-&gt;middleware(&#39;auth:api&#39;,[&#39;except&#39; =&gt; [&#39;index&#39;, &#39;show&#39;]]);
<span class="linenos" data-linenos="6 "></span>}
<span class="linenos" data-linenos="7 "></span>...
</code></pre></div>
<p>També podem fer-ho en el fitxer de rutes. </p>
<h4 id="sanctum-or-passport">Sanctum or Passport<a class="headerlink" href="#sanctum-or-passport" title="Permanent link">&para;</a></h4>
<p>A l'hora de instal·lar una llibreria per a l'autenticació podem triar per Passport que utilitza <strong>OATH2</strong> per autenticació o una versió més simple que no l'utilitza com és Sanctum. Esta senzilla gràfica us pot orientar per saber quin dels dos instal·le. </p>
<p><img alt="" src="../img/api10.png" /></p>
<h4 id="autenticacio-basada-en-tokens-emprant-laravel-sanctum">Autenticació basada en tokens emprant Laravel Sanctum<a class="headerlink" href="#autenticacio-basada-en-tokens-emprant-laravel-sanctum" title="Permanent link">&para;</a></h4>
<p>Com hem comentat anteriorment, <strong>Laravel Sanctum</strong> és una llibreria que proporciona mecanismes d'autenticació per a SPAs (Single Page Applications, aplicacions de pàgina única), i APIs. En el nostre cas, l'emprarem
per a autenticar-nos mitjançant tokens en nostres APIs. </p>
<p>Els passos a seguir per a laconfiguració són els següents...
En primer lloc, hem d'incorporar Laravel Sanctum al nostre projecte, escrivint aquest comando des de l'arrel d'aquest:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="x">composer require laravel/sanctum</span>
</code></pre></div>
<p>Després, hem de publicar la configuració de Sanctum i el seu fitxer de migració, que generarà una taula addicional on emmagatzemar els tokens. Escrivim el següent comando (tot en una línia, encara que ací es divideix en dues per a poder-lo veure complet):</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>php artisan vendor:publish
<span class="linenos" data-linenos="2 "></span>--provider=&quot;Laravel\Sanctum\SanctumServiceProvider&quot;
</code></pre></div>
<p>En finalitzar aquest pas, tindrem la migració creada i un arxiu de configuració
<strong>config/sanctum.php</strong> disponible, per a editar la configuració per defecte de la llibreria. Per exemple, podem editar-ho per a especificar el temps de vida (TTL) dels tokens. El següent exemple estableix un temps de vida de 5 minuts, per exemple, encara que en el cas d'aplicacions basades en tokens és habitual
deixar temps molt majors (o indefinits, segons el cas, deixant aquesta propietat a null ):</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>&#39;expiration&#39; =&gt; 5,
</code></pre></div>
<p>Després, hem de llançar la migració que s'ha creat, juntament amb les quals tinguem pendents (la de la taula d'usuaris, per exemple). S'afegirà una taula anomenada personal_access_tokens a la nostra base de dades.</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>php artisan migrate:fresh --seed
</code></pre></div>
<p>Finalment, hem de modificar el model d'usuaris (App\Models\User ) per a afegir el <strong>trait HasApiTokens</strong> . D'aquesta manera es vincula el model d'usuari amb els tokens que es vagen a generar per a aquests.</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>...
<span class="linenos" data-linenos="2 "></span>use Laravel\Sanctum\HasApiTokens;
<span class="linenos" data-linenos="3 "></span>class User extends Authenticatable
<span class="linenos" data-linenos="4 "></span>{
<span class="linenos" data-linenos="5 "></span>use HasApiTokens, HasFactory, Notifiable;
</code></pre></div>
<h5 id="proteccio-de-rutes_1">Protecció de rutes<a class="headerlink" href="#proteccio-de-rutes_1" title="Permanent link">&para;</a></h5>
<p>Per a protegir les rutes d'accés restringit, primer crearem un controlador que s'encarregue de validar les credencials de l'usuari:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>php artisan make:controller Api/LoginController
</code></pre></div>
<p>Definim un mètode login , per exemple, que validarà les credencials que li arriben (login i password). Si són correctes, cridarà al mètode <strong>createToken</strong> de Sanctum (incorporat a l'usuari a través del <strong>trait HasApiTokens</strong> ), associant-lo al login de l'usuari entrant, i li retornarà el token en
format text pla, com un objecte JSON. En cas que hi haja un error en l'autenticació, enviarà de tornada un missatge d'error, amb el codi 401 d'accés no autoritzat.</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="x">use App\Http\Controllers\Controller;</span>
<span class="linenos" data-linenos=" 2 "></span><span class="x">use Illuminate\Http\Request;</span>
<span class="linenos" data-linenos=" 3 "></span><span class="x">use Illuminate\Support\Facades\Hash;</span>
<span class="linenos" data-linenos=" 4 "></span><span class="x">use App\Models\User;</span>
<span class="linenos" data-linenos=" 5 "></span>
<span class="linenos" data-linenos=" 6 "></span><span class="x">class LoginController extends Controller</span>
<span class="linenos" data-linenos=" 7 "></span><span class="x">{</span>
<span class="linenos" data-linenos=" 8 "></span><span class="x">    public function login(Request $request)</span>
<span class="linenos" data-linenos=" 9 "></span><span class="x">    {</span>
<span class="linenos" data-linenos="10 "></span><span class="x">        $usuario = User::where(&#39;email&#39;, $request-&gt;login)-&gt;first();</span>
<span class="linenos" data-linenos="11 "></span><span class="x">        if (!$usuario || !Hash::check($request-&gt;password, $usuario-&gt;password))</span>
<span class="linenos" data-linenos="12 "></span><span class="x">        {</span>
<span class="linenos" data-linenos="13 "></span><span class="x">            return response()-&gt;json([&#39;error&#39; =&gt; &#39;Credenciales no válidas&#39;], 401);</span>
<span class="linenos" data-linenos="14 "></span><span class="x">        }</span>
<span class="linenos" data-linenos="15 "></span><span class="x">        else</span>
<span class="linenos" data-linenos="16 "></span><span class="x">        {</span>
<span class="linenos" data-linenos="17 "></span><span class="x">            return response()-&gt;json([&#39;token&#39; =&gt; $usuario-&gt;createToken($usuario-&gt;email)-&gt;plainTextToken]);</span>
<span class="linenos" data-linenos="18 "></span><span class="x">        }</span>
<span class="linenos" data-linenos="19 "></span><span class="x">    }</span>
<span class="linenos" data-linenos="20 "></span><span class="x">}</span>
</code></pre></div>
<p>Definim en l'arxiu <strong>routes/api.php</strong> una ruta que redirigisca a aquest mètode, per a quan l'usuari vulga autenticar-se (recorda afegir amb use la corresponent classe):</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="x">Route::post(&#39;login&#39;, &#39;Api\LoginController@login&#39;);</span>
</code></pre></div>
<p>També podem eliminar en aquest cas la ruta predefinida d'aquest arxiu, que empra l'autenticació nativa de Laravel:</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>// Eliminar esta ruta:
<span class="linenos" data-linenos="2 "></span>Route::middleware(&#39;auth:api&#39;)-&gt;get(&#39;/user&#39;, function (Request $request) {
<span class="linenos" data-linenos="3 "></span>return $request-&gt;user();
<span class="linenos" data-linenos="4 "></span>});
</code></pre></div>
<p>Per a protegir les rutes que necessitem en els controladors API, les especifiquem en el constructor del controlador. Per exemple, així protegiríem totes les rutes del nostre controlador MovieController , excepte index i show :</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>class MovieController extends Controller
<span class="linenos" data-linenos="2 "></span>{
<span class="linenos" data-linenos="3 "></span>public function __construct()
<span class="linenos" data-linenos="4 "></span>{
<span class="linenos" data-linenos="5 "></span>    $this-&gt;middleware(&#39;auth:sanctum&#39;,[&#39;except&#39; =&gt; [&#39;index&#39;, &#39;show&#39;]]);
<span class="linenos" data-linenos="6 "></span>}
<span class="linenos" data-linenos="7 "></span>...
</code></pre></div>
<h3 id="prova-dautenticacio-amb-postman">Prova d'autenticació amb POSTMAN<a class="headerlink" href="#prova-dautenticacio-amb-postman" title="Permanent link">&para;</a></h3>
<p>Vegem com provar l'autenticació per token en el projecte de videoclub, per qualsevol dels mètodes vistos abans.
En primer lloc, i després de posar en marxa el projecte, ens assegurarem que podem accedir sense restriccions als dos serveis que no requereixen autorització ( index o show ), igual que abans.</p>
<p>Si accedim a un recurs protegit obtenim </p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Credenciales no válidas&quot;</span><span class="p">}</span>
</code></pre></div>
<p>Ara anem a loguejar-se</p>
<p><img alt="" src="../img/postman_9.png" /></p>
<p>Ara hem de copiar aquest token, i pegar-ho en la petició d'accés restringit. Haurem de pegar-ho en la capçalera Authorization (obrir aqueixa pestanya sota la URL de la petició en Postman), i el normal és enviar-ho com un <strong>Bearer token</strong>, segons els estàndards. Llavors sí que tindrem la resposta correcta de l'operació
sol·licitada.</p>
<p><img alt="" src="../img/postman_10.png" /></p>
<p>A l'hora de traslladar aquestes proves a una aplicació "real", enviaríem les credencials per JSON al servidor, obtindríem el token de tornada i l'emmagatzemaríem localment en alguna variable o suport
(per exemple, en l'element localStorage , si treballem amb algun framework Javascript). Després, davant cada petició JSON que férem al servidor, adjuntaríem aquest token en la capçalera Authorization perquè fóra validat pel servidor.</p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      2024 Xavier Sastre - Licencia CC BY-NC-SA
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": ".", "features": ["header.autohide", "toc.integrate", "content.tabs.link", "navigation.expand"], "search": "assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copiat al porta-retalls", "clipboard.copy": "C\u00f2pia al porta-retalls", "search.result.more.one": "1 m\u00e9s en aquesta p\u00e0gina", "search.result.more.other": "# m\u00e9s en aquesta p\u00e0gina", "search.result.none": "Cap document coincideix", "search.result.one": "1 document coincident", "search.result.other": "# documents coincidents", "search.result.placeholder": "Escriu per a comen\u00e7ar a cercar", "search.result.term.missing": "Desaparegut", "select.version": "Selecciona la versi\u00f3"}}</script>
    
    
      <script src="assets/javascripts/bundle.8fd75fb4.min.js"></script>
      
    
  </body>
</html>